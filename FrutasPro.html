<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Servicios Digitales</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Arimo:wght@400;700&family=Inter:wght@300;400;500;600;800&family=Tinos:wght@700&family=Orbitron:wght@700&display=swap');

        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        
        /* Efecto Ne√≥n */
        @keyframes neon-pulse {
            0%, 100% { text-shadow: 0 0 4px #3b82f6, 0 0 10px #3b82f6, 0 0 20px #2563eb; color: #ffffff; }
            50% { text-shadow: 0 0 2px #60a5fa, 0 0 5px #3b82f6; color: #dbeafe; opacity: 0.8; }
        }
        .neon-text-blue { animation: neon-pulse 1.5s infinite alternate; font-family: 'Inter', sans-serif; font-weight: 600; }

        /* Estilos espec√≠ficos de la Receta */
        .barcode { height: 58px; width: 220px; margin: 0 auto; background: linear-gradient(90deg, #000 1px, transparent 1px, transparent 2px, #000 2px, #000 4px, transparent 4px, transparent 5px, #000 5px, #000 6px, transparent 6px, transparent 8px, #000 8px, #000 11px, transparent 11px, transparent 12px, #000 12px, #000 13px, transparent 13px, transparent 15px, #000 15px, #000 17px, transparent 17px, transparent 19px, #000 19px, #000 20px, transparent 20px, transparent 21px, #000 21px, #000 24px, transparent 24px, transparent 26px, #000 26px, #000 27px, transparent 27px, transparent 29px, #000 29px, #000 31px, transparent 31px, transparent 33px, #000 33px, #000 36px, transparent 36px, transparent 38px, #000 38px, #000 39px, transparent 39px, transparent 40px, #000 40px, #000 43px, transparent 43px, transparent 44px, #000 44px, #000 45px, transparent 45px, transparent 47px, #000 47px, #000 50px, transparent 50px, transparent 51px, #000 51px, #000 53px, transparent 53px, transparent 55px, #000 55px, #000 58px, transparent 58px, transparent 60px, #000 60px, #000 61px, transparent 61px, transparent 63px, #000 63px, #000 65px, transparent 65px, transparent 67px, #000 67px, #000 70px, transparent 70px, transparent 72px, #000 72px, #000 74px, transparent 74px, transparent 76px, #000 76px, #000 77px, transparent 79px, #000 79px, #000 82px, transparent 82px, transparent 83px, #000 83px, #000 84px, transparent 84px, transparent 86px, #000 86px, #000 88px, transparent 88px, transparent 90px, #000 90px, #000 93px, transparent 93px, transparent 94px); background-size: 94px 100%; }
        .pt-box { padding: 2px 4px; line-height: 1.1; font-size: 9px; width: 100%; }
        .double-box { border: 4px double #000; background: white; }
        .pt-label { font-weight: 900; font-size: 9px; margin-right: 3px; }
        .pt-val { font-weight: 700; font-size: 10px; }
        .doctor-stamp-base { padding: 4px 6px; display: flex; align-items: center; gap: 6px; font-family: 'Arial Black', sans-serif; font-weight: 900; text-transform: uppercase; line-height: 1.1; font-size: 9px; max-width: 260px; mix-blend-mode: multiply; pointer-events: none; }
        .stamp-logo { height: 35px; width: auto; filter: grayscale(100%) sepia(100%) hue-rotate(190deg) saturate(1000%) brightness(40%) contrast(120%); }
        .svg-filters { position: absolute; width: 0; height: 0; overflow: hidden; }

        @media print {
            @page { margin: 0; size: auto; }
            html, body { height: 100%; overflow: hidden; background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-area { position: fixed; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 0.5cm !important; display: block; background: white !important; z-index: 9999; }
            .paper { box-shadow: none !important; margin: 0 auto !important; border: none !important; max-height: 100vh; }
        }
    </style>
</head>
<body>
    <svg class="svg-filters" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <filter id="stamp-texture-1"><feTurbulence type="fractalNoise" baseFrequency="0.5" numOctaves="1" result="noise" /><feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.3 0.7" in="noise" result="alphaNoise" /><feComposite operator="in" in="SourceGraphic" in2="alphaNoise" /></filter>
            <filter id="stamp-texture-2"><feTurbulence type="turbulence" baseFrequency="0.05" numOctaves="2" result="turbulence" /><feDisplacementMap in2="turbulence" in="SourceGraphic" scale="2" xChannelSelector="R" yChannelSelector="G" result="displaced"/><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" result="noise" /><feColorMatrix type="matrix" values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0.6 0.4" in="noise" result="alphaNoise" /><feComposite operator="in" in="displaced" in2="alphaNoise" /></filter>
            <filter id="stamp-texture-3"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="1" result="noise" /><feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.15 0.85" in="noise" result="alphaNoise" /><feComposite operator="in" in="SourceGraphic" in2="alphaNoise" /></filter>
            <filter id="stamp-texture-4"><feTurbulence type="fractalNoise" baseFrequency="0.4" numOctaves="4" result="noise" /><feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.8 -0.2" in="noise" result="alphaNoise" /><feComposite operator="in" in="SourceGraphic" in2="alphaNoise" /></filter>
        </defs>
    </svg>

    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // CONFIGURACION FIREBASE
        // ==========================================
        const firebaseConfig = {
            // !IMPORTANTE: REEMPLAZA ESTOS DATOS CON LOS DE TU CONSOLA DE FIREBASE
            apiKey: "AIzaSyAZOHuy67nnmQ36cnbMbDq8kG29CuqNMI4",
            authDomain: "frutas-pro.firebaseapp.com",
            projectId: "frutas-pro",
            storageBucket: "frutas-pro.firebasestorage.app",
            messagingSenderId: "330784421331",
            appId: "1:330784421331:web:9022cbf8d5e3c3d7da2b26"
        };

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        // Usamos Auth en lugar de solo Firestore para el login
        const auth = firebase.auth();
        const db = firebase.firestore();

        const { useState, useEffect } = React;

        // --- DATOS GLOBALES ---
        const SELLOS_DATA = [
            { id: 1, label: 'Sello 1 (Azul Original)', nombre: 'VALENTIN MOLINA DOMINGUEZ', tipo: 'M√âD. GENERAL', cedula: '12752209', matricula: '96150053', uni: 'Universidad Nacional Aut√≥noma de M√©xico (UNAM)', style: { borderColor: '#003366', color: '#003366', borderStyle: 'solid', borderWidth: '3px', transform: 'rotate(-12deg)', opacity: 0.95, filter: 'url(#stamp-texture-1)' }, position: { top: '-5px', left: '40px' } },
            { id: 2, label: 'Sello 2 (Negro, Centrado)', nombre: 'MARIANA E. GUERRA PAZ', tipo: 'M√âD. FAMILIAR', cedula: '89201145', matricula: '99124401', uni: 'Instituto Polit√©cnico Nacional (IPN)', style: { borderColor: '#1a1a1a', color: '#1a1a1a', borderStyle: 'solid', borderWidth: '3px', transform: 'rotate(2deg)', opacity: 0.9, filter: 'url(#stamp-texture-2)' }, position: { top: '15px', left: '180px' } },
            { id: 3, label: 'Sello 3 (Rojo, Inclinado)', nombre: 'ROBERTO CARLOS MENDEZ L.', tipo: 'MED. INTERNO', cedula: '55601923', matricula: '97003312', uni: 'Universidad Aut√≥noma Metropolitana (UAM)', style: { borderColor: '#8b0000', color: '#8b0000', borderStyle: 'double', borderWidth: '4px', transform: 'rotate(-25deg)', opacity: 0.85, filter: 'url(#stamp-texture-3)' }, position: { top: '-15px', left: '10px' } },
            { id: 4, label: 'Sello 4 (Morado, Borde Punteado)', nombre: 'LAURA SOFIA VILLA REAL', tipo: 'M√âD. GENERAL', cedula: '10928374', matricula: '94551122', uni: 'Universidad de Guadalajara (UDG)', style: { borderColor: '#4a0e78', color: '#4a0e78', borderStyle: 'dashed', borderWidth: '2px', transform: 'rotate(8deg)', opacity: 0.92, filter: 'url(#stamp-texture-4)' }, position: { top: '25px', left: '60px' } },
            { id: 5, label: 'Sello 5 (Verde, Desgastado)', nombre: 'HECTOR SALINAS CRUZ', tipo: 'CIRUJANO', cedula: '67123900', matricula: '98334455', uni: 'Benem√©rita Universidad Aut√≥noma de Puebla (BUAP)', style: { borderColor: '#005221', color: '#005221', borderStyle: 'solid', borderWidth: '3px', transform: 'rotate(-5deg)', opacity: 0.8, filter: 'url(#stamp-texture-2)' }, position: { top: '5px', left: '120px' } }
        ];

                               // ==========================================
        // COMPONENTE: PANTALLA DE LOGIN Y REGISTRO (V7 - SIN BOT√ìN DESCARGA)
        // ==========================================
        const LoginScreen = ({ onLogin }) => {
            // Estados B√°sicos
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isRegistering, setIsRegistering] = useState(false);

            // Estados Extra (Registro)
            const [nombre, setNombre] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [telefono, setTelefono] = useState('');
            const [direccion, setDireccion] = useState('');
            const [genero, setGenero] = useState('Masculino'); 

            // Carga segura de iconos (Anti-Pantalla Blanca)
            useEffect(() => {
                const timer = setTimeout(() => {
                    try {
                        if(window.lucide) window.lucide.createIcons();
                    } catch(e) { console.warn("Icon error ignorado", e); }
                }, 100);
                return () => clearTimeout(timer);
            }, [isRegistering]); 

            const handleAuth = async (e) => {
                e.preventDefault();
                setIsLoading(true);

                try {
                    if (isRegistering) {
                        // --- VALIDACIONES ---
                        if (password !== confirmPassword) {
                            alert("‚ùå Las contrase√±as no coinciden.");
                            setIsLoading(false);
                            return;
                        }
                        if (!nombre.trim() || !telefono.trim() || !direccion.trim()) {
                            alert("‚ö†Ô∏è Por favor completa todos los campos.");
                            setIsLoading(false);
                            return;
                        }

                        // 1. Crear usuario
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        
                        // 2. Guardar en Firestore
                        await db.collection('usuarios').doc(user.uid).set({
                            email: email,
                            nombre: nombre.toUpperCase(),
                            telefono: telefono,
                            direccion: direccion.toUpperCase(),
                            genero: genero,
                            fechaRegistro: new Date(),
                            saldo: 0
                        });
                        
                        // 3. Verificar
                        await user.sendEmailVerification();
                        alert("¬°Cuenta creada con √©xito! ‚úÖ\n\nSe ha enviado un correo de verificaci√≥n a " + email);
                        
                        // 4. Recarga segura
                        window.location.reload();

                    } else {
                        // --- LOGIN ---
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        const user = userCredential.user;

                        if (user.emailVerified) {
                            onLogin();
                        } else {
                            await auth.signOut();
                            alert("‚ö†Ô∏è Tu correo no ha sido verificado. Revisa tu bandeja de entrada.");
                        }
                    }

                } catch (error) {
                    console.error("Error Auth:", error);
                    let msg = "Error al procesar.";
                    if (error.code === 'auth/email-already-in-use') msg = "El correo ya est√° registrado.";
                    if (error.code === 'auth/wrong-password') msg = "Contrase√±a incorrecta.";
                    if (error.code === 'auth/user-not-found') msg = "Cuenta no encontrada.";
                    if (error.code === 'auth/weak-password') msg = "La contrase√±a es muy d√©bil.";
                    alert(msg);
                } finally {
                    setIsLoading(false);
                }
            };

            const toggleMode = () => {
                setIsRegistering(!isRegistering);
                setEmail(''); setPassword(''); setConfirmPassword('');
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900 p-4 font-sans">
                    <div key={isRegistering ? 'register-mode' : 'login-mode'} className={`w-full ${isRegistering ? 'max-w-2xl' : 'max-w-md'} bg-white rounded-2xl shadow-2xl p-8 transition-all duration-500`}>
                        
                        <div className="text-center mb-6">
                            <div className="inline-flex items-center justify-center w-12 h-12 rounded-lg bg-indigo-600 text-white mb-4 shadow-lg shadow-indigo-200">
                                <i data-lucide={isRegistering ? "user-plus" : "lock"} className="w-6 h-6"></i>
                            </div>
                            <h2 className="text-2xl font-black text-slate-800 uppercase tracking-tight">
                                {isRegistering ? "Crear Cuenta" : "Iniciar Sesi√≥n"}
                            </h2>
                            <p className="text-slate-500 text-sm font-bold">
                                {isRegistering ? "Completa el formulario" : "Bienvenido al Panel de Administraci√≥n"}
                            </p>
                        </div>

                        <form onSubmit={handleAuth} className="space-y-4">
                            
                            {/* --- CAMPOS EXCLUSIVOS DE REGISTRO --- */}
                            {isRegistering && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-[fadeIn_0.3s_ease-out]">
                                    <div className="md:col-span-2">
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre Completo</label>
                                        <div className="relative">
                                            <input type="text" required value={nombre} onChange={e => setNombre(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-bold text-slate-700" placeholder="Ej. Juan P√©rez" />
                                            <i data-lucide="user" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Tel√©fono</label>
                                        <div className="relative">
                                            <input type="tel" required value={telefono} onChange={e => setTelefono(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium" placeholder="55 1234 5678" />
                                            <i data-lucide="phone" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">G√©nero</label>
                                        <div className="relative">
                                            <select value={genero} onChange={e => setGenero(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium appearance-none cursor-pointer">
                                                <option value="Masculino">Masculino</option>
                                                <option value="Femenino">Femenino</option>
                                                <option value="No Binario">No Binario</option>
                                            </select>
                                            <i data-lucide="users" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                            <i data-lucide="chevron-down" className="absolute right-3 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                                        </div>
                                    </div>

                                    <div className="md:col-span-2">
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Direcci√≥n (Ciudad, Estado)</label>
                                        <div className="relative">
                                            <input type="text" required value={direccion} onChange={e => setDireccion(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium" placeholder="Ej. Toluca, Estado de M√©xico" />
                                            <i data-lucide="map-pin" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* --- CAMPOS COMUNES --- */}
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Correo Electr√≥nico</label>
                                <div className="relative">
                                    <input type="email" required value={email} onChange={(e) => setEmail(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium" placeholder="nombre@correo.com" />
                                    <i data-lucide="mail" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className={isRegistering ? "" : "md:col-span-2"}>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Contrase√±a</label>
                                    <div className="relative">
                                        <input type="password" required value={password} onChange={(e) => setPassword(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                                        <i data-lucide="lock" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                    </div>
                                </div>

                                {isRegistering && (
                                    <div className="animate-[fadeIn_0.3s_ease-out]">
                                        <label className="block text-xs font-bold text-indigo-600 uppercase mb-1">Confirmar Contrase√±a</label>
                                        <div className="relative">
                                            <input type="password" required value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className={`w-full pl-10 pr-4 py-3 rounded-xl bg-indigo-50 border ${password && confirmPassword && password !== confirmPassword ? 'border-rose-400 focus:border-rose-500' : 'border-indigo-200 focus:border-indigo-500'} focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium`} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                                            <i data-lucide="check-circle" className="absolute left-3 top-3.5 w-5 h-5 text-indigo-400"></i>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* Boton Principal */}
                            <button type="submit" disabled={isLoading} className={`w-full text-white font-bold py-4 rounded-xl transition-all duration-300 shadow-xl shadow-slate-200 disabled:opacity-50 disabled:cursor-not-allowed mt-4 flex items-center justify-center gap-2 ${isRegistering ? 'bg-gradient-to-r from-slate-800 to-slate-900 hover:scale-[1.01]' : 'bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-200'}`}>
                                {isLoading ? (
                                    <><div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> Procesando...</>
                                ) : (
                                    isRegistering ? 'CREAR CUENTA' : 'INGRESAR AL SISTEMA'
                                )}
                            </button>
                        </form>

                        {/* Toggle Login/Registro */}
                        <div className="mt-6 flex flex-col gap-3 text-center text-sm border-t border-slate-100 pt-6">
                            <button 
                                type="button"
                                onClick={toggleMode} 
                                className="text-slate-600 font-bold hover:text-indigo-600 transition flex items-center justify-center gap-2 mx-auto px-4 py-2 rounded-lg hover:bg-slate-50"
                            >
                                {isRegistering ? <><i data-lucide="arrow-left" className="w-4 h-4"></i> Volver al Login</> : "No tienes cuenta? Crear Cuenta"}
                            </button>
                            
                            {!isRegistering && (
                                <button onClick={() => {
                                    const resetEmail = prompt("Ingresa tu correo para recuperar contrase√±a:");
                                    if(resetEmail) {
                                        auth.sendPasswordResetEmail(resetEmail)
                                            .then(() => alert("Correo de recuperaci√≥n enviado."))
                                            .catch(e => alert("Error: " + e.message));
                                    }
                                }} className="text-slate-400 hover:text-slate-600 text-xs">
                                    Olvid√© mi contrase√±a
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };



                       // ==========================================
        // COMPONENTE: RECHARGE FLOW (Texto Original Restaurado + Env√≠o Admin)
        // ==========================================
        const RechargeFlow = ({ onBack }) => {
            const [step, setStep] = useState(1);
            const [accepted, setAccepted] = useState(false);
            const [showError, setShowError] = useState(false);
            const [concept, setConcept] = useState('');
            const [timeLeft, setTimeLeft] = useState(15 * 60);
            const [toast, setToast] = useState(null);
            const [isSending, setIsSending] = useState(false); // Estado para el env√≠o

            useEffect(() => {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let result = '';
                for (let i = 0; i < 8; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                setConcept(result);
            }, []);

            useEffect(() => {
                if (step === 2 && timeLeft > 0) {
                    const timer = setInterval(() => setTimeLeft(p => p - 1), 1000);
                    return () => clearInterval(timer);
                }
            }, [step, timeLeft]);

            useEffect(() => { if(window.lucide) window.lucide.createIcons(); }, [step]);

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            };

            const handleContinue = () => {
                if (!accepted) {
                    setShowError(true);
                    setTimeout(() => setShowError(false), 2000);
                    return;
                }
                setStep(2);
            };

            // Funci√≥n para enviar la solicitud al administrador
            const handleFinalize = async () => {
                setIsSending(true);
                try {
                    const user = auth.currentUser;
                    await db.collection('recargas').add({
                        userId: user.uid,
                        userEmail: user.email,
                        monto: 200, // Monto fijo seg√∫n la UI
                        concept: concept,
                        fecha: new Date(),
                        status: 'pendiente'
                    });
                    
                    alert("¬°Solicitud enviada! Tu saldo se reflejar√° cuando el administrador apruebe la transacci√≥n.");
                    onBack();
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error al enviar solicitud: " + error.message);
                } finally {
                    setIsSending(false);
                }
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    setToast("Copiado al portapapeles");
                    setTimeout(() => setToast(null), 2000);
                }).catch(err => {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("Copy");
                    textArea.remove();
                    setToast("Copiado");
                    setTimeout(() => setToast(null), 2000);
                });
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans relative overflow-hidden">
                    <button onClick={onBack} className="absolute top-4 left-4 text-white/70 hover:text-white flex items-center gap-2 z-10">
                        <i data-lucide="arrow-left" className="w-5 h-5"></i> Cancelar
                    </button>

                    {toast && (
                        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[100] bg-black/90 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 backdrop-blur-sm border border-white/10">
                            <i data-lucide="check-circle" className="w-5 h-5 text-emerald-400"></i>
                            <span className="font-semibold text-sm">{toast}</span>
                        </div>
                    )}

                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                        <div className="absolute top-[-10%] right-[-10%] w-96 h-96 bg-blue-600/20 rounded-full blur-3xl"></div>
                        <div className="absolute bottom-[-10%] left-[-10%] w-96 h-96 bg-indigo-600/20 rounded-full blur-3xl"></div>
                    </div>

                    {step === 1 && (
                        <div className="w-full max-w-lg bg-slate-800/80 backdrop-blur-md border border-slate-700 rounded-2xl shadow-2xl p-6 relative z-20">
                            <div className="mb-6 text-center">
                                <div className="bg-blue-500/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/30">
                                    <i data-lucide="alert-triangle" className="w-8 h-8 text-blue-400"></i>
                                </div>
                                <h2 className="text-2xl font-bold text-white mb-2">Advertencia de Recarga</h2>
                            </div>

                            <div className="bg-slate-900/50 p-6 rounded-xl border border-blue-900/50 mb-6 shadow-inner">
                                {/* TEXTO ORIGINAL RESTAURADO CON ESTILO NEON */}
                                <div className="neon-text-blue text-xs md:text-sm text-left space-y-3">
                                    <p className="text-center font-bold mb-3 uppercase tracking-wider border-b border-blue-800/50 pb-2">Instrucciones Importantes</p>
                                    <ul className="space-y-2 list-none">
                                        <li className="flex items-start gap-2"><span className="mt-0.5 text-blue-300">‚û§</span><span><strong>Recarga M√≠nima:</strong> $200 MXN.</span></li>
                                        <li className="flex items-start gap-2"><span className="mt-0.5 text-blue-300">‚û§</span><span><strong>M√©todo:</strong> Solo Transferencias.</span></li>
                                        <li className="flex items-start gap-2"><span className="mt-0.5 text-blue-300">‚û§</span><span><strong>Datos:</strong> Comprobante con Nombre, Monto, Concepto.</span></li>
                                        <li className="flex items-start gap-2"><span className="mt-0.5 text-blue-300">‚û§</span><span><strong>Concepto:</strong> √ösalo EXACTO.</span></li>
                                        <li className="flex items-start gap-2"><span className="mt-0.5 text-blue-300">‚û§</span><span><strong>Tiempo:</strong> L√≠mite de 15 min.</span></li>
                                    </ul>
                                </div>
                            </div>

                            <div className="space-y-6">
                                <label className="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700/50 transition cursor-pointer group">
                                    <div className="relative">
                                        <input type="checkbox" className="peer sr-only" checked={accepted} onChange={(e) => setAccepted(e.target.checked)} />
                                        <div className="w-6 h-6 border-2 border-slate-500 rounded peer-checked:bg-blue-500 peer-checked:border-blue-500 transition-all"></div>
                                        <i data-lucide="check" className="absolute top-0.5 left-0.5 w-4 h-4 text-white opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                                    </div>
                                    <span className="text-slate-300 font-medium select-none group-hover:text-white transition">He le√≠do y acepto los t√©rminos</span>
                                </label>

                                {showError && (
                                    <div className="text-rose-500 text-xs font-bold text-center animate-bounce bg-rose-500/10 p-2 rounded">
                                        ‚ö† Debes aceptar los t√©rminos
                                    </div>
                                )}

                                <button onClick={handleContinue} className={`w-full py-4 rounded-xl font-bold text-lg tracking-wide transition-all duration-200 transform shadow-lg ${accepted ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:scale-[1.02]' : 'bg-slate-700 text-slate-400 cursor-not-allowed'}`}>
                                    RECARGAR AHORA
                                </button>
                            </div>
                        </div>
                    )}

                    {step === 2 && (
                        <div className="w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden relative z-20 animate-[fadeIn_0.3s_ease-out]">
                             <div className="bg-slate-900 p-5 text-center relative">
                                <h3 className="text-white font-bold text-lg">Datos de Transferencia</h3>
                                <p className="text-slate-400 text-xs mt-1">Realiza tu pago antes de que termine el tiempo</p>
                                <div className="mt-4 bg-slate-800 rounded-lg py-2 border border-slate-700 flex items-center justify-center gap-2">
                                    <i data-lucide="timer" className="w-4 h-4 text-red-500 animate-pulse"></i>
                                    <span className="text-xl font-mono font-bold text-white tracking-widest">{formatTime(timeLeft)}</span>
                                </div>
                             </div>

                             <div className="p-6 space-y-5">
                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                    <p className="text-[10px] text-indigo-500 font-bold uppercase mb-1">Concepto (Copiar)</p>
                                    <div className="flex justify-between items-center">
                                        <span className="text-2xl font-black text-indigo-900 tracking-wider break-all">{concept}</span>
                                        <button onClick={() => copyToClipboard(concept)} className="bg-white p-2 rounded-lg shadow-sm border border-indigo-100 text-indigo-600 hover:bg-indigo-50 flex-shrink-0 ml-2 group relative">
                                            <i data-lucide="copy" className="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>

                                <div className="space-y-4 text-sm">
                                    <div className="flex justify-between border-b border-slate-100 pb-2 items-center">
                                        <span className="text-slate-500">Banco</span>
                                        <span className="font-bold text-slate-800">STP</span>
                                    </div>
                                    <div className="flex justify-between border-b border-slate-100 pb-2 items-center">
                                        <span className="text-slate-500">Beneficiario</span>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-slate-800">AXLL</span>
                                            <button onClick={() => copyToClipboard('AXLL')} className="text-slate-400 hover:text-indigo-600"><i data-lucide="copy" className="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                    <div className="flex justify-between border-b border-slate-100 pb-2 items-center">
                                        <span className="text-slate-500">CLABE</span>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-slate-800 text-sm">646180402324335362</span>
                                            <button onClick={() => copyToClipboard('646180402324335362')} className="text-slate-400 hover:text-indigo-600"><i data-lucide="copy" className="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center pt-2">
                                        <span className="text-slate-500 font-medium">Monto</span>
                                        <span className="font-black text-2xl text-emerald-600">$200.00</span>
                                    </div>
                                </div>

                                <button onClick={handleFinalize} disabled={isSending} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg shadow-slate-200 mt-2 disabled:opacity-50">
                                    {isSending ? 'Enviando Solicitud...' : 'Ya realic√© la transferencia'}
                                </button>
                             </div>
                        </div>
                    )}
                </div>
            );
        };

                                 // ==========================================
        // COMPONENTE: MENU LATERAL (CON NOMBRE DE USUARIO)
        // ==========================================
        const SidebarMenu = ({ isOpen, onClose, onNavigate, userBalance, userData }) => { 
            const user = firebase.auth().currentUser;
            const isAdmin = user && user.email === 'mrandroidtutorialeshd@gmail.com';

            useEffect(() => {
                if (isOpen && window.lucide) window.lucide.createIcons();
            }, [isOpen]);

            return (
                <>
                    <div 
                        className={`fixed inset-0 bg-slate-900/60 z-[60] transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                        onClick={onClose}
                    ></div>

                    <div className={`fixed top-0 left-0 h-full w-72 bg-white z-[70] shadow-2xl transform transition-transform duration-300 ease-out flex flex-col ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-slate-100 bg-slate-50">
                            <div className="flex justify-between items-start mb-4">
                                <div className="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 border border-indigo-200">
                                    <i data-lucide="user" className="w-6 h-6"></i>
                                </div>
                                <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full transition">
                                    <i data-lucide="x" className="w-5 h-5 text-slate-400"></i>
                                </button>
                            </div>
                            {/* Mostramos el nombre guardado o 'USUARIO' si no hay nada */}
                            <h3 className="font-bold text-slate-800 text-lg uppercase break-words leading-tight">
                                {userData?.nombre ? userData.nombre : 'USUARIO'}
                            </h3>
                            <p className="text-xs text-slate-500 break-words mt-1">{user ? user.email : 'Invitado'}</p>
                        </div>

                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                            <button onClick={() => { onClose(); onNavigate('profile'); }} className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl transition-all group font-medium">
                                <i data-lucide="user-circle" className="w-5 h-5 text-slate-400 group-hover:text-indigo-500"></i> Perfil
                            </button>
                            
                            <button onClick={() => { onClose(); onNavigate('store'); }} className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl transition-all group font-medium">
                                <i data-lucide="layout-grid" className="w-5 h-5 text-slate-400 group-hover:text-indigo-500"></i> Servicios
                            </button>

                            {isAdmin && (
                                <button onClick={() => { onClose(); onNavigate('admin'); }} className="w-full flex items-center gap-3 px-4 py-3 text-indigo-700 bg-indigo-50 hover:bg-indigo-100 rounded-xl transition-all group font-bold border border-indigo-100">
                                    <i data-lucide="shield" className="w-5 h-5 text-indigo-500"></i> Panel Admin
                                </button>
                            )}

                            <button onClick={() => { onClose(); onNavigate('recharge'); }} className="w-full flex items-center justify-between px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl transition-all group font-medium">
                                <div className="flex items-center gap-3">
                                    <i data-lucide="wallet" className="w-5 h-5 text-slate-400 group-hover:text-indigo-500"></i> Agregar Saldo
                                </div>
                                <span className="text-xs font-bold bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full">
                                    ${userBalance ? userBalance.toFixed(2) : '0.00'}
                                </span>
                            </button>
                            
                            {/* BOT√ìN HISTORIAL ACTUALIZADO */}
                            <button onClick={() => { onClose(); onNavigate('history'); }} className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl transition-all group font-medium">
                                <i data-lucide="history" className="w-5 h-5 text-slate-400 group-hover:text-indigo-500"></i> Mi Historial
                            </button>
                            
                            <button onClick={() => alert("Contactar Soporte")} className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl transition-all group font-medium">
                                <i data-lucide="headphones" className="w-5 h-5 text-slate-400 group-hover:text-indigo-500"></i> Soporte
                            </button>
                        </nav>

                        <div className="p-4 border-t border-slate-100">
                            {/* --- BOT√ìN DESCARGAR APP CON ICONO ANDROID SVG --- */}
                            <a 
                                href="https://www.mediafire.com/file/dumddjmhpfqobqb/FrutasPro-Master.apk/file" 
                                target="_blank"
                                rel="noopener noreferrer"
                                className="w-full flex items-center gap-3 px-4 py-3 text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all group font-bold mb-1"
                            >
                                {/* SVG del Robot de Android en color verde esmeralda */}
                                <svg viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5 text-emerald-500 group-hover:text-emerald-600 transition-colors">
                                    <path d="M17.523 15.3414c0 1.3704-1.1164 2.4813-2.4936 2.4813-1.3771 0-2.4935-1.1109-2.4935-2.4813 0-1.3704 1.1164-2.4813 2.4935-2.4813 1.3772 0 2.4936 1.1109 2.4936 2.4813zM6.4764 15.3414c0 1.3704-1.1164 2.4813-2.4935 2.4813-1.3772 0-2.4936-1.1109-2.4936-2.4813 0-1.3704 1.1164-2.4813 2.4936-2.4813 1.3771 0 2.4935 1.1109 2.4935 2.4813zM18.7891 7.2922l2.3967-4.137c.088-.1519.0384-.348-.1107-.4364-.1492-.0883-.3416-.0386-.4302.112l-2.4346 4.2023c-1.8953-.8701-4.0435-1.3537-6.3146-1.3537-2.1648 0-4.2208.4395-6.0594 1.2393l-2.3551-4.086c-.088-.152-.2807-.202-.4305-.1136-.1498.0883-.1996.2842-.1113.4367l2.3164 4.019C2.4795 9.4796.5333 13.065.5333 17.152h22.9333c0-4.2185-2.0717-7.8963-4.6775-9.8598z" />
                                </svg>
                                Descargar Aplicaci√≥n
                            </a>

                             <button onClick={() => { onClose(); auth.signOut(); }} className="w-full flex items-center gap-3 px-4 py-3 text-rose-600 hover:bg-rose-50 rounded-xl transition-all group font-bold">
                                <i data-lucide="log-out" className="w-5 h-5 text-rose-400 group-hover:text-rose-600"></i> Cerrar Sesion
                            </button>
                            <div className="text-center mt-4 text-[10px] text-slate-300">Power Revolution Team¬©</div>
                        </div>
                    </div>
                </>
            );
        };



                                                   // ==========================================
        // COMPONENTE: TIENDA VIRTUAL (V26 - MUESTRAS PDF EXTENDIDAS)
        // ==========================================
        const StoreFront = ({ onSelectService, onOpenMenu, onSelectCovid, userData, onGoToHistory }) => {
            const [searchTerm, setSearchTerm] = useState("");
            const [services, setServices] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState('TODOS');

            // --- ESTADOS PARA LA VENTANA DE PEDIDO ---
            const [selectedService, setSelectedService] = useState(null);
            const [isOrderOpen, setIsOrderOpen] = useState(false);
            const [formData, setFormData] = useState({});
            const [isSendingOrder, setIsSendingOrder] = useState(false);

            // ============================================================
            // üõ°Ô∏è ICONO INTELIGENTE (Tecnolog√≠a Anti-Desaparici√≥n)
            // ============================================================
            const Icon = ({ name, className }) => {
                const iconRef = React.useRef(null);
                React.useEffect(() => {
                    if (iconRef.current && window.lucide) {
                        iconRef.current.innerHTML = `<i data-lucide="${name}" class="${className || ''}"></i>`;
                        window.lucide.createIcons({ root: iconRef.current });
                    }
                }, [name, className]);
                return <span ref={iconRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }} />;
            };

            // 1. Cargar servicios
            useEffect(() => {
                const unsubscribe = db.collection('servicios').onSnapshot(snapshot => {
                    const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setServices(docs);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // 2. Filtrado
            const filteredServices = services.filter(service => 
                (service.active !== false) &&
                (filter === 'TODOS' || service.category === filter) &&
                ((service.title || "").toLowerCase().includes(searchTerm.toLowerCase()) || 
                (service.category || "").toLowerCase().includes(searchTerm.toLowerCase()))
            );

            // 3. Agrupar
            const groupedServices = filteredServices.reduce((groups, service) => {
                const category = service.category || 'OTROS';
                if (!groups[category]) groups[category] = [];
                groups[category].push(service);
                return groups;
            }, {});

            const sortedCategories = Object.keys(groupedServices).sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));

            // 4. Manejo de Clics
            const handleServiceClick = (service) => {
                const title = (service.title || "").toUpperCase();
                
                if (title.includes("RECETA") || title.includes("COVID") || title.includes("VACUNA")) {
                    if (title.includes("RECETA")) onSelectService();
                    else onSelectCovid();
                    return; 
                } 

                setSelectedService(service);
                setFormData({}); 
                setIsOrderOpen(true);
            };

            // --- L√ìGICA EXTENDIDA: NOMBRES DE PDF ---
            const getPdfFileName = (title) => {
                if (!title) return "Muestra.pdf";
                const t = title.toUpperCase();
                
                // Actas
                if (t.includes("NACIMIENTO")) return "nacimiento.pdf";
                if (t.includes("MATRIMONIO")) return "matrimonio.pdf";
                if (t.includes("DIVORCIO")) return "divorcio.pdf";
                if (t.includes("DEFUNCI√ìN") || t.includes("DEFUNCION")) return "defuncion.pdf";

                // Infonavit y Fiscal (NUEVOS)
                if (t.includes("REPORTE HIST√ìRICO") || t.includes("REPORTE HISTORICO")) return "historicos.pdf";
                if (t.includes("RESUMEN CR√âDITO") || t.includes("RESUMEN CREDITO")) return "resumen_credito.pdf";
                if (t.includes("OPINI√ìN DE CUMPLIMIENTO") || t.includes("OPINION DE CUMPLIMIENTO")) return "cumplimiento.pdf";
                if (t.includes("CSF CON") && t.includes("CURP")) return "clon.pdf"; // Detecta "CSF CON CON CURP"
                if (t.includes("LOCALIZACI√ìN DE IDCIF") || t.includes("LOCALIZACION DE IDCIF")) return "idcif.pdf";
                
                return "Muestra.pdf"; // Archivo por defecto para otros servicios
            };

            // 5. FUNCI√ìN REALIZAR PEDIDO
            const handleFinalizeOrder = async () => {
                if (!selectedService) return;

                const priceString = selectedService.price || "0";
                const price = priceString.toString().toUpperCase().includes('GRATIS') 
                    ? 0 
                    : parseFloat(priceString.replace(/[^0-9.]/g, '')) || 0;
                
                const currentBalance = userData?.saldo || 0;

                if (currentBalance < price) {
                    alert(`‚ùå SALDO INSUFICIENTE\nCosto: $${price}\nTu saldo: $${currentBalance.toFixed(2)}`);
                    return;
                }

                const requiredFields = selectedService.fields || [];
                const missingFields = requiredFields.filter(field => !formData[field] || formData[field].toString().trim() === "");
                
                if (missingFields.length > 0) {
                    alert(`‚ö†Ô∏è Faltan datos por llenar:\n\n- ${missingFields.join('\n- ')}`);
                    return;
                }

                if (!confirm(`¬øConfirmar pedido por $${price}?`)) return;

                setIsSendingOrder(true);

                try {
                    const user = auth.currentUser;
                    const batch = db.batch();

                    const userRef = db.collection('usuarios').doc(user.uid);
                    batch.update(userRef, { 
                        saldo: firebase.firestore.FieldValue.increment(-price) 
                    });

                    const reqRef = db.collection('solicitudes_servicios').doc();
                    batch.set(reqRef, {
                        userId: user.uid,
                        userEmail: user.email,
                        serviceId: selectedService.id,
                        serviceName: selectedService.title,
                        category: selectedService.category,
                        pricePaid: price,
                        date: new Date(),
                        status: 'pendiente',
                        datosFormulario: formData 
                    });

                    await batch.commit();
                    alert("‚úÖ Pedido realizado con √©xito.");
                    setIsOrderOpen(false);
                    onGoToHistory(); 

                } catch (error) {
                    alert("Error: " + error.message);
                } finally {
                    setIsSendingOrder(false);
                }
            };

            const handleInputChange = (label, value) => {
                setFormData(prev => ({...prev, [label]: value}));
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-10">
                    {/* Header */}
                    <div className="bg-white border-b border-slate-200 px-5 py-4 sticky top-0 z-50 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-3">
                            <div onClick={onOpenMenu} className="p-2 hover:bg-slate-100 rounded-full transition cursor-pointer active:scale-95">
                                <Icon name="menu" className="w-6 h-6 text-slate-600"/>
                            </div>
                            <div className="bg-indigo-600 rounded-lg p-1.5 shadow-indigo-200 shadow-md">
                                <Icon name="file-text" className="w-5 h-5 text-white"/>
                            </div>
                            <span className="font-extrabold text-xl tracking-tight text-slate-800">FrutasPro<span className="text-indigo-600">Master</span></span>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-xs font-bold border border-emerald-200">
                                ${userData?.saldo?.toFixed(2) || '0.00'}
                            </div>
                        </div>
                    </div>

                    {/* Buscador */}
                    <div className="p-5 max-w-3xl mx-auto">
                        <h2 className="text-2xl font-light text-slate-600 mb-6">Realizar nuevo pedido</h2>
                        <div className="space-y-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <div className="relative w-full">
                                <input type="text" placeholder="Buscar servicio..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 pl-11 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all font-medium" />
                                <div className="absolute left-4 top-3.5"><Icon name="search" className="w-4 h-4 text-indigo-400"/></div>
                            </div>
                        </div>
                    </div>

                    {/* Lista */}
                    <div className="px-5 max-w-3xl mx-auto">
                        {loading ? <div className="py-10 text-center text-slate-400">Cargando...</div> : sortedCategories.length === 0 ? 
                            <div className="text-center py-10 text-slate-400"><p>No se encontraron servicios.</p></div> : (
                            <div className="space-y-8">
                                {sortedCategories.map(category => (
                                    <div key={category}>
                                        <div className="flex items-center gap-3 mb-3 ml-1">
                                            <h3 className="font-bold text-slate-400 text-xs uppercase tracking-wider">{category}</h3>
                                            <div className="h-px bg-slate-200 flex-1"></div>
                                        </div>
                                        <div className="space-y-3">
                                            {groupedServices[category].map((service) => (
                                                <div key={service.id} onClick={() => handleServiceClick(service)}
                                                    className={`group relative bg-white overflow-hidden rounded-xl p-4 transition-all duration-300 cursor-pointer border border-slate-100 hover:border-indigo-300 shadow-sm hover:shadow-md flex justify-between items-center`}>
                                                    
                                                    <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${service.color === 'blue' ? 'bg-blue-500' : 'bg-indigo-500'}`}></div>
                                                    <div className="pl-3 flex flex-col gap-1">
                                                        <div className="flex items-center gap-2">
                                                            <h3 className="font-bold text-slate-800 text-sm uppercase tracking-wide group-hover:text-indigo-700 transition-colors">{service.title}</h3>
                                                            {service.isNew && <span className="bg-rose-100 text-rose-600 text-[9px] font-bold px-2 py-0.5 rounded-full border border-rose-200">NUEVO</span>}
                                                        </div>
                                                        <p className="text-[10px] text-slate-400 font-semibold uppercase">{service.category}</p>
                                                    </div>
                                                    <div className="flex flex-col items-end gap-1.5">
                                                        <span className={`text-xs font-bold px-2.5 py-1 rounded-lg ${service.price === 'GRATIS' ? 'bg-blue-50 text-blue-600 border border-blue-100' : 'bg-emerald-50 text-emerald-600 border border-emerald-100'}`}>{service.price}</span>
                                                        <span className="text-[10px] font-medium text-slate-400 flex items-center gap-1"><Icon name="clock" className="w-3 h-3"/> {service.time}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* ========================================================= */}
                    {/* VENTANA DE PEDIDO (PANTALLA COMPLETA - V26)               */}
                    {/* ========================================================= */}
                    {isOrderOpen && selectedService && (
                        <div className="fixed inset-0 z-[100] bg-white flex flex-col animate-[fadeIn_0.2s_ease-out]">
                            {/* Header Ventana */}
                            <div className="bg-white border-b border-slate-200 px-5 py-4 flex items-center justify-between sticky top-0 z-10">
                                <button onClick={() => setIsOrderOpen(false)} className="p-2 -ml-2 text-slate-500 hover:bg-slate-100 rounded-full transition-colors">
                                    <Icon name="arrow-left" className="w-6 h-6"/>
                                </button>
                                <span className="font-bold text-slate-700">Completar Pedido</span>
                                <button onClick={() => setIsOrderOpen(false)} className="p-2 -mr-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-full transition-all">
                                    <Icon name="x" className="w-6 h-6"/>
                                </button>
                            </div>

                            {/* Contenido Scrollable */}
                            <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                                {/* T√≠tulo */}
                                <div className="mb-6">
                                    <h2 className="text-xl font-black text-slate-800 uppercase leading-tight mb-2">{selectedService.title}</h2>
                                    <span className="bg-indigo-100 text-indigo-700 text-xs font-bold px-3 py-1 rounded-lg">{selectedService.category}</span>
                                </div>

                                {/* Campos Rellenables */}
                                <div className="space-y-4">
                                    {selectedService.fields && selectedService.fields.length > 0 ? (
                                        selectedService.fields.map((field, idx) => (
                                            <div key={idx}>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">{field}</label>
                                                <input 
                                                    type="text" 
                                                    className="w-full bg-white border border-slate-300 rounded-xl p-3 text-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all font-medium text-slate-700"
                                                    placeholder={`Ingresa ${field}...`}
                                                    value={formData[field] || ''}
                                                    onChange={(e) => handleInputChange(field, e.target.value)}
                                                />
                                            </div>
                                        ))
                                    ) : (
                                        <div className="text-center p-6 bg-white rounded-xl border border-slate-200 text-slate-400 text-sm">
                                            No se requieren datos adicionales.
                                        </div>
                                    )}
                                </div>

                                {/* --- ZONA DE PAGO Y BOT√ìN --- */}
                                <div className="mt-8 mb-8 p-4 bg-white rounded-2xl border border-slate-200 shadow-md">
                                    <div className="flex justify-between items-end mb-4 px-1">
                                        <span className="text-sm font-bold text-slate-400">Total a Pagar</span>
                                        <span className="text-2xl font-black text-slate-800">{selectedService.price}</span>
                                    </div>
                                    <button 
                                        onClick={handleFinalizeOrder}
                                        disabled={isSendingOrder}
                                        className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg shadow-xl shadow-slate-300 hover:bg-slate-800 active:scale-[0.98] transition-all disabled:opacity-70 disabled:cursor-not-allowed flex justify-center items-center gap-2"
                                    >
                                        {isSendingOrder ? 'Procesando...' : <>Realizar Pedido <Icon name="arrow-right" className="w-4 h-4"/></>}
                                    </button>
                                </div>

                                {/* --- SECCI√ìN DE INFORMACI√ìN Y ALERTAS --- */}
                                <div className="space-y-4 pt-6 border-t border-slate-200">
                                    
                                    {/* Horario */}
                                    <div className="bg-emerald-100 border-2 border-emerald-400 rounded-2xl p-4 flex flex-col items-center gap-2 text-center animate-pulse shadow-lg">
                                        <div className="text-emerald-700 bg-white p-2 rounded-full shadow-sm"><Icon name="clock" className="w-8 h-8"/></div>
                                        <p className="text-base font-black text-emerald-800 uppercase leading-tight">
                                            Disponible y activo de <br/>08:00 am a 08:00 pm
                                        </p>
                                    </div>

                                    {/* Precauci√≥n */}
                                    <div className="bg-amber-100 border-2 border-amber-400 rounded-2xl p-4 flex flex-col items-center gap-2 text-center shadow-lg">
                                        <div className="text-amber-600 animate-[bounce_2s_infinite]"><Icon name="alert-triangle" className="w-8 h-8"/></div>
                                        <p className="text-sm font-bold text-amber-900 leading-tight">
                                            Si adquieres el servicio fuera de ese horario se entrega al d√≠a siguiente en horarios establecidos
                                        </p>
                                    </div>

                                    {/* Bot√≥n de Muestra (DIN√ÅMICO EXTENDIDO) */}
                                    <div className="pt-4 pb-4 flex justify-center">
                                        <a 
                                            href={getPdfFileName(selectedService.title)} 
                                            download={getPdfFileName(selectedService.title)}
                                            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-base font-black uppercase tracking-widest py-4 px-6 rounded-xl shadow-xl hover:shadow-2xl transition-all cursor-pointer flex items-center justify-center gap-3 animate-bounce border-b-4 border-indigo-900"
                                        >
                                            <Icon name="eye" className="w-6 h-6 text-white"/>
                                            Clic para ver muestra
                                        </a>
                                    </div>
                                </div>
                                <div className="h-10"></div> 
                            </div>
                        </div>
                    )}
                </div>
            );
        };




        // ==========================================
        // COMPONENTE: EDITOR DE RECETA (Original)
        // ==========================================
        const RecetaEditor = ({ onBack }) => {
            const [selectedSelloId, setSelectedSelloId] = useState(1);
            const [data, setData] = useState({
                paciente: {
                    nss: '05209874840', agregado: '1M1999OR',
                    nombre: 'RICARDO DE JESUS LOPEZ MONTOYA',
                    curp: 'LOMR980622HMCPN01', sexo: 'MASCULINO', fechaNac: '22/06/1998',
                    delegacion: 'TOLUCA', ump: '222', consultorio: '16', cve: '281401252110', turno: 'MATUTINO'
                },
                meta: { 
                    folio: '14041564087769', 
                    fecha: 'MARTES 16 DE DICIEMBRE DE 2025',
                    indicaciones: 'CHEQUEO DE PRESI√ìN ARTERIAL (T/A) Y GLUCOSA.\nSE INDICA TRATAMIENTO Y SE SOLICITAN ESTUDIOS DE CONTROL.'
                },
                medico: { 
                    nombre: SELLOS_DATA[0].nombre, tipo: SELLOS_DATA[0].tipo, cedula: SELLOS_DATA[0].cedula, matricula: SELLOS_DATA[0].matricula, uni: SELLOS_DATA[0].uni 
                },
                medicamentos: [
                    { id: 1, text: '6389 CIPROFLOXACINO 500 MG ‚Äî CADA TABLETA CONTIENE: CIPROFLOXACINO 500 MG', ind: 'V√≠a de administraci√≥n Oral una Tableta (s) cada 12 Hora(s) durante 7 Dia(s) Cantidad a Surtir 1 ENV' },
                    { id: 2, text: '6338 FENIRAMINA 25 MG ‚Äî CADA TABLETA CONTIENE: FENIRAMINA 25 MG', ind: 'V√≠a de administraci√≥n Oral una Tableta (s) cada 8 Hora(s) durante 5 Dia(s) Cantidad a Surtir 1 ENV' },
                    { id: 3, text: '6482 GOTAS DE MANZANILLA ‚Äî SOLUCI√ìN OFT√ÅLMICA', ind: 'V√≠a de administraci√≥n Oft√°lmica, aplicar 2 gotas en cada ojo cada 8 horas durante 5 d√≠a(s). Cantidad a surtir 1 FRASCO.' }
                ]
            });

            useEffect(() => {
                document.title = (data.paciente.curp && data.paciente.curp.trim() !== "") ? data.paciente.curp : "Receta IMSS";
            }, [data.paciente.curp]);

            const handleChange = (section, field, val) => setData(p => ({...p, [section]: {...p[section], [field]: val.toUpperCase()}}));
            const handleMed = (id, field, val) => setData(p => ({...p, medicamentos: p.medicamentos.map(m => m.id===id ? {...m, [field]: val.toUpperCase()} : m)}));
            const addMed = () => setData(p => ({...p, medicamentos: [...p.medicamentos, {id: Date.now(), text: '', ind: ''}]}));
            const delMed = (id) => setData(p => ({...p, medicamentos: p.medicamentos.filter(m => m.id !== id)}));

            const handleSelloSelect = (e) => {
                const id = parseInt(e.target.value);
                setSelectedSelloId(id);
                const nuevoSello = SELLOS_DATA.find(s => s.id === id);
                if (nuevoSello) {
                    setData(p => ({
                        ...p,
                        medico: {
                            nombre: nuevoSello.nombre,
                            tipo: nuevoSello.tipo,
                            cedula: nuevoSello.cedula,
                            matricula: nuevoSello.matricula,
                            uni: nuevoSello.uni
                        }
                    }));
                }
            };

            const activeSello = SELLOS_DATA.find(s => s.id === selectedSelloId) || SELLOS_DATA[0];
            const logoUrl = "https://i.postimg.cc/gJ8kqq0g/1766127957062.png";
            const qrContent = `Nombre: ${data.paciente.nombre}\nNSS: ${data.paciente.nss}\nFecha Nacimiento: ${data.paciente.fechaNac}\nCURP: ${data.paciente.curp}\nDelegaci√≥n: ${data.paciente.delegacion}\nCVE. PTAL: ${data.paciente.cve}\nFolio: ${data.meta.folio}`;
            const qrCode = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrContent)}`;

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-white">
                    {/* EDITOR */}
                    <div className="w-full lg:w-1/3 bg-slate-50 border-r border-slate-200 p-4 no-print h-screen overflow-y-auto font-sans shadow-xl z-20">
                         <div className="mb-4">
                            <button onClick={onBack} className="group flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-indigo-600 transition-colors bg-white border border-slate-200 px-3 py-2 rounded-lg shadow-sm">
                                <i data-lucide="arrow-left" className="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i> Volver a la Tienda
                            </button>
                        </div>
                        <div className="flex justify-between items-center mb-4 sticky top-0 bg-slate-50 z-10 py-3 border-b border-slate-200 text-xs">
                            <h2 className="font-bold flex items-center gap-2 text-sm text-slate-800"><i data-lucide="edit-3" className="w-4 h-4 text-indigo-500"></i> Editar Datos</h2>
                            <button onClick={() => window.print()} className="bg-slate-900 text-white px-4 py-1.5 rounded-md font-bold hover:bg-indigo-600 transition flex items-center gap-1"><i data-lucide="printer" className="w-3 h-3"></i> IMPRIMIR</button>
                        </div>
                        <div className="space-y-4 text-xs">
                             <fieldset className="border border-slate-200 p-3 rounded-xl bg-white shadow-sm">
                                <legend className="font-bold text-slate-500 px-1">Paciente</legend>
                                <input className="w-full border border-slate-300 rounded mb-1.5 p-1.5 focus:border-indigo-500 outline-none" placeholder="Nombre" value={data.paciente.nombre} onChange={e=>handleChange('paciente','nombre',e.target.value)} />
                                <div className="grid grid-cols-2 gap-1.5">
                                    <input className="border border-slate-300 rounded p-1.5 focus:border-indigo-500 outline-none" placeholder="NSS" value={data.paciente.nss} onChange={e=>handleChange('paciente','nss',e.target.value)} />
                                    <input className="border border-slate-300 rounded p-1.5 focus:border-indigo-500 outline-none" placeholder="Agregado" value={data.paciente.agregado} onChange={e=>handleChange('paciente','agregado',e.target.value)} />
                                    <input className="border border-slate-300 rounded p-1.5 focus:border-indigo-500 outline-none" placeholder="CURP" value={data.paciente.curp} onChange={e=>handleChange('paciente','curp',e.target.value)} />
                                    <input className="border border-slate-300 rounded p-1.5 focus:border-indigo-500 outline-none" placeholder="Fecha Nac" value={data.paciente.fechaNac} onChange={e=>handleChange('paciente','fechaNac',e.target.value)} />
                                    <input className="border border-slate-300 rounded p-1.5 focus:border-indigo-500 outline-none" placeholder="Delegaci√≥n" value={data.paciente.delegacion} onChange={e=>handleChange('paciente','delegacion',e.target.value)} />
                                    <input className="border border-slate-300 rounded p-1.5 focus:border-indigo-500 outline-none" placeholder="UMP" value={data.paciente.ump} onChange={e=>handleChange('paciente','ump',e.target.value)} />
                                    <input className="border border-slate-300 rounded p-1.5 focus:border-indigo-500 outline-none" placeholder="Consultorio" value={data.paciente.consultorio} onChange={e=>handleChange('paciente','consultorio',e.target.value)} />
                                    <input className="border border-slate-300 rounded p-1.5 focus:border-indigo-500 outline-none" placeholder="Turno" value={data.paciente.turno} onChange={e=>handleChange('paciente','turno',e.target.value)} />
                                </div>
                                <input className="w-full border border-slate-300 rounded mt-1.5 p-1.5 focus:border-indigo-500 outline-none" placeholder="Cve Ptal" value={data.paciente.cve} onChange={e=>handleChange('paciente','cve',e.target.value)} />
                            </fieldset>
                            <fieldset className="border border-slate-200 p-3 rounded-xl bg-white shadow-sm">
                                <legend className="font-bold text-slate-500 px-1">Receta</legend>
                                <input className="w-full border border-slate-300 rounded mb-1.5 p-1.5 focus:border-indigo-500 outline-none" placeholder="Folio" value={data.meta.folio} onChange={e=>handleChange('meta','folio',e.target.value)} />
                                <input className="w-full border border-slate-300 rounded mb-1.5 p-1.5 focus:border-indigo-500 outline-none" placeholder="Fecha Texto" value={data.meta.fecha} onChange={e=>handleChange('meta','fecha',e.target.value)} />
                            </fieldset>
                            <fieldset className="border border-slate-200 p-3 rounded-xl bg-slate-50">
                                <legend className="font-bold text-slate-500 flex justify-between w-full pb-1 px-1">Medicamentos <button onClick={addMed} className="bg-emerald-500 text-white px-2 rounded hover:bg-emerald-600 transition">+</button></legend>
                                {data.medicamentos.map(m => (
                                    <div key={m.id} className="mb-2 border-b border-slate-200 pb-2 bg-white p-2 rounded border shadow-sm">
                                        <div className="flex justify-between mb-1"><span className="font-bold text-slate-700">Item</span> <button onClick={()=>delMed(m.id)} className="text-rose-500 hover:text-rose-700 font-bold">x</button></div>
                                        <input className="w-full border border-slate-300 rounded mb-1 p-1.5 font-bold focus:border-indigo-500 outline-none" placeholder="Cod + Nombre" value={m.text} onChange={e=>handleMed(m.id,'text',e.target.value)} />
                                        <textarea className="w-full border border-slate-300 rounded p-1.5 h-12 resize-none focus:border-indigo-500 outline-none" placeholder="Indicaciones" value={m.ind} onChange={e=>handleMed(m.id,'ind',e.target.value)}></textarea>
                                    </div>
                                ))}
                            </fieldset>
                            <fieldset className="border border-slate-200 p-3 rounded-xl bg-white shadow-sm">
                                <legend className="font-bold text-slate-500 px-1">Indicaciones M√©dicas</legend>
                                <textarea className="w-full border border-slate-300 rounded p-1.5 h-20 resize-none font-bold uppercase focus:border-indigo-500 outline-none" value={data.meta.indicaciones} onChange={e=>handleChange('meta','indicaciones',e.target.value)}></textarea>
                            </fieldset>

                             <fieldset className="border border-slate-200 p-3 rounded-xl bg-white shadow-sm">
                                <legend className="font-bold text-slate-500 px-1">M√©dico (Datos y Dise√±o del Sello)</legend>
                                <div className="mb-2">
                                    <label className="block text-slate-600 mb-1 font-bold">Seleccionar Sello Predefinido:</label>
                                    <select className="w-full border border-slate-300 rounded p-1.5 font-bold bg-slate-50 cursor-pointer hover:bg-slate-100 focus:border-indigo-500 outline-none" value={selectedSelloId} onChange={handleSelloSelect}>
                                        {SELLOS_DATA.map(sello => <option key={sello.id} value={sello.id}>{sello.label}</option>)}
                                    </select>
                                </div>
                                <div className="border-t border-slate-200 mb-2"></div>
                                <input className="w-full border border-slate-300 rounded mb-1.5 p-1.5 focus:border-indigo-500 outline-none" placeholder="Nombre Dr(a)." value={data.medico.nombre} onChange={e=>handleChange('medico','nombre',e.target.value)} />
                                <input className="w-full border border-slate-300 rounded mb-1.5 p-1.5 bg-blue-50 font-bold focus:border-indigo-500 outline-none" placeholder="Tipo de M√©dico" value={data.medico.tipo} onChange={e=>handleChange('medico','tipo',e.target.value)} />
                                <input className="w-full border border-slate-300 rounded mb-1.5 p-1.5 focus:border-indigo-500 outline-none" placeholder="Universidad" value={data.medico.uni} onChange={e=>handleChange('medico','uni',e.target.value)} />
                                <div className="grid grid-cols-2 gap-1.5">
                                    <input className="border border-slate-300 rounded p-1.5 focus:border-indigo-500 outline-none" placeholder="C√©dula Prof." value={data.medico.cedula} onChange={e=>handleChange('medico','cedula',e.target.value)} />
                                    <input className="border border-slate-300 rounded p-1.5 focus:border-indigo-500 outline-none" placeholder="Matr√≠cula" value={data.medico.matricula} onChange={e=>handleChange('medico','matricula',e.target.value)} />
                                </div>
                            </fieldset>
                        </div>
                    </div>

                    {/* VISTA PREVIA (DERECHA) */}
                    <div className="w-full lg:w-2/3 bg-slate-200 flex justify-center items-start p-4 print-area overflow-auto">
                        <div className="paper bg-white w-[21.59cm] min-h-[13.97cm] p-8 relative text-black shadow-2xl">
                             <div className="flex justify-between items-start">
                                <div className="w-[55%] pr-2">
                                    <div className="flex flex-col items-center mb-1"><img src={logoUrl} className="h-10 w-auto mb-1 opacity-90" alt="Logo" /><h1 className="text-[10px] font-bold tracking-wide text-center leading-none">INSTITUTO MEXICANO DEL SEGURO SOCIAL</h1><p className="text-[5px] font-bold tracking-[0.2em] text-gray-500 mt-0.5 uppercase">Seguridad y Solidaridad Social</p></div>
                                    <div className="w-full border-t border-b border-gray-400 py-0.5 my-2 text-center text-[7px] uppercase">Direcci√≥n de Prestaciones M√©dicas</div>
                                    <div className="text-center mb-2"><h2 className="text-xl font-bold font-[Tinos] uppercase tracking-wide">Receta Individual</h2></div>
                                    <div className="relative h-12 mt-2 mb-2 w-full"><div className="absolute left-1/2 -translate-x-1/2 top-0"><div className="barcode"></div></div><div className="absolute -right-40 top-8"><div className="text-left leading-[1.1] font-sans"><div className="text-base font-bold text-gray-900 mb-0.5 whitespace-nowrap">Folio: <span className="text-black text-base font-black tracking-tight ml-1">{data.meta.folio}</span></div><div className="text-[11px] font-bold text-black uppercase max-w-[220px]">ESTA RECETA NO SE SURTIR√Å DESPU√âS DE LAS 72 HORAS DE SU EXPEDICI√ìN</div></div></div></div>
                                </div>
                                <div className="w-[45%] pl-2 pt-2 relative">
                                    <div className="double-box pt-box w-full -mt-6"><div className="flex justify-between mb-2"><div><span className="pt-label">NSS:</span><span className="pt-val">{data.paciente.nss}</span></div><div><span className="pt-label">AGREGADO. MED:</span><span className="pt-val">{data.paciente.agregado}</span></div></div><div className="text-center mb-2"><span className="pt-label block w-full mb-px">NOMBRE DEL PACIENTE:</span><div className="pt-val uppercase">{data.paciente.nombre}</div></div><div className="mb-0.5"><span className="pt-label">CURP:</span><span className="pt-val">{data.paciente.curp}</span></div><div className="mb-0.5"><span className="pt-label">SEXO:</span><span className="pt-val">{data.paciente.sexo}</span></div><div className="mb-0.5"><span className="pt-label">FECHA DE NACIMIENTO:</span><span className="pt-val">{data.paciente.fechaNac}</span></div><div className="mb-0.5"><span className="pt-label">DELEGACION:</span><span className="pt-val">{data.paciente.delegacion}</span></div><div className="flex justify-between mb-0.5"><div className="flex gap-2"><div><span className="pt-label">UMP:</span><span className="pt-val">{data.paciente.ump}</span></div><div><span className="pt-label">CONSULTORIO:</span><span className="pt-val">{data.paciente.consultorio}</span></div></div></div><div className="flex justify-end"><div className="text-left"><div><span className="pt-label">CVE.PTAL</span><span className="pt-val">{data.paciente.cve}</span></div><div><span className="pt-label">TURNO:</span><span className="pt-val">{data.paciente.turno}</span></div></div></div></div>
                                    <img src={qrCode} className="absolute -bottom-20 right-20 w-14 h-14" alt="QR" />
                                </div>
                            </div>

                            <div className="double-box min-h-[500px] flex flex-col relative mt-12">
                                <div className="flex justify-between items-center px-2 pt-1 text-[10px] font-bold uppercase"><div>FECHA: {data.meta.fecha}</div><div>Primer Nivel de Atenci√≥n</div></div>
                                <div className="border-b border-black w-auto mx-4 mb-1"></div>
                                <div className="p-2 flex-grow">
                                    {data.medicamentos.map(m => (<div key={m.id} className="med-item text-[10px] leading-snug mb-6"><div className="font-bold text-black px-1 mb-0.5">{m.text}</div><div className="border-b border-black w-auto mx-4 mb-1"></div><div className="pl-1 whitespace-pre-wrap">{m.ind}</div></div>))}
                                    {data.meta.indicaciones && (<div className="text-[10px] leading-snug whitespace-pre-wrap mt-4 font-bold px-1">{data.meta.indicaciones}</div>)}
                                </div>
                                
                                <div className="border-t border-black mt-auto bg-white relative">
                                    <div className="pt-3 px-4 flex text-[9px] items-start relative z-20">
                                        <div className="w-[55%] pr-2 relative"><div className="flex flex-col items-start relative"><span className="font-bold mb-0.5 leading-none">Nombre y firma del m√©dico: {data.medico.nombre}</span><span className="font-bold uppercase leading-tight text-[8px] w-full">{data.medico.uni}</span></div></div>
                                        <div className="w-[45%] flex justify-between items-start pl-4"><div className="flex flex-col items-start"><span className="font-bold mb-1 leading-none">C√©dula Profesional:</span><span className="font-[Arimo] font-bold leading-none">{data.medico.cedula}</span></div><div className="flex flex-col items-end"><span className="font-bold mb-1 leading-none">Matr√≠cula:</span><span className="font-[Arimo] font-bold leading-none">{data.medico.matricula}</span></div></div>
                                    </div>
                                    <div className="doctor-stamp-base absolute z-30" style={{ ...activeSello.style, ...activeSello.position }}>
                                        <img src={logoUrl} className="stamp-logo" alt="Sello" style={{ filter: activeSello.style.color !== '#003366' ? 'grayscale(100%) brightness(30%) contrast(150%)' : undefined }} />
                                        <div className="text-left text-[8px]"><div>DR(A). {data.medico.nombre}</div><div>{data.medico.tipo}</div><div>CED. PROF. {data.medico.cedula}</div><div>MATRICULA {data.medico.matricula}</div></div>
                                    </div>
                                    <div className="border-b border-black w-auto mx-4 mt-1 mb-1 relative z-10"></div>
                                    <div className="h-20 w-full bg-white relative z-0 flex flex-col items-end justify-start px-4"><span className="font-bold text-[9px] uppercase mt-1">PACIENTE</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
                                                                                // ==========================================
        // COMPONENTE: PANEL DE ADMINISTRACI√ìN (V20 - DISE√ëO ORIGINAL + ID USUARIO)
        // ==========================================
        const AdminPanel = ({ onBack }) => {
            const [section, setSection] = useState('menu');
            
            // --- ESTADOS DE DATOS ---
            const [requests, setRequests] = useState([]);
            const [orders, setOrders] = useState([]);
            const [stockList, setStockList] = useState([]);
            const [usersList, setUsersList] = useState([]);
            
            // --- ESTADOS DE CARGA ---
            const [loadingRequests, setLoadingRequests] = useState(true);
            const [loadingOrders, setLoadingOrders] = useState(true);
            const [loadingStock, setLoadingStock] = useState(true);
            const [loadingUsers, setLoadingUsers] = useState(true);

            // --- ESTADOS MODALES ---
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [historyModalOpen, setHistoryModalOpen] = useState(false);
            
            // --- ESTADO PARA VER DATOS DEL PEDIDO ---
            const [isDetailsOpen, setIsDetailsOpen] = useState(false);
            const [selectedOrderDetails, setSelectedOrderDetails] = useState(null);

            // --- ESTADOS EDICI√ìN ---
            const [editingId, setEditingId] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [newService, setNewService] = useState({ title: '', category: '', price: '', time: '', isNew: false, fields: [] });

            // --- ESTADO HISTORIAL ---
            const [selectedUserHistory, setSelectedUserHistory] = useState({ user: null, compras: [], recargas: [], loading: false });

            const availableFields = [
                "Curp", "Nombre Completo", "Apellido Paterno", "Apellido Materno", "Fecha de Nacimiento", 
                "Domicilio", "Clave de Elector", "N√∫mero de servicio CFE", "NSS", "Placa", "A√±o a pagar", 
                "N√∫mero de serie", "N√∫mero de motor", "Marca", "Modelo", "L√≠nea", "Color", 
                "Nombre del due√±o/conductor", "Direcci√≥n", "RFC", "Idcif", "Fecha de emisi√≥n", "Cl√≠nica", 
                "Delegaci√≥n o municipio", "Turno", "N. Consultorio", "Sexo", "Clave patronal", 
                "1 Medicamento", "2 Medicamento", "3 Medicamento", "4 Medicamento", "Indicaciones M√©dicas", 
                "Nombre del medico", "De que se enfermo"
            ];

            // üõ°Ô∏è COMPONENTE "C√ÅPSULA" PARA ICONOS
            const Icon = ({ name, className }) => (
                <span 
                    dangerouslySetInnerHTML={{__html: `<i data-lucide="${name}" class="${className || ''}"></i>`}} 
                    style={{display: 'inline-flex', alignItems: 'center', justifyContent: 'center'}}
                />
            );

            // 1. MOTOR DE ICONOS
            useEffect(() => {
                const timer = setTimeout(() => {
                    if(window.lucide) window.lucide.createIcons();
                }, 50);
                return () => clearTimeout(timer);
            }, [section, requests, stockList, orders, usersList, isModalOpen, historyModalOpen, selectedUserHistory, newService, isDetailsOpen]);

            // 2. CARGA DE DATOS
            useEffect(() => {
                const unsub1 = db.collection('recargas').where('status', '==', 'pendiente').onSnapshot(s => { setRequests(s.docs.map(d => ({id:d.id,...d.data()})).sort((a,b)=>(b.fecha?.seconds||0)-(a.fecha?.seconds||0))); setLoadingRequests(false); });
                const unsub2 = db.collection('servicios').onSnapshot(s => { setStockList(s.docs.map(d => ({id:d.id,...d.data()})).sort((a,b)=>(a.title||"").localeCompare(b.title||""))); setLoadingStock(false); });
                const unsub3 = db.collection('solicitudes_servicios').where('status', '==', 'pendiente').onSnapshot(s => { setOrders(s.docs.map(d => ({id:d.id,...d.data()})).sort((a,b)=>(b.date?.seconds||0)-(a.date?.seconds||0))); setLoadingOrders(false); });
                const unsub4 = db.collection('usuarios').onSnapshot(s => { setUsersList(s.docs.map(d => ({id:d.id,...d.data()}))); setLoadingUsers(false); });
                return () => { unsub1(); unsub2(); unsub3(); unsub4(); };
            }, []);

            // --- FUNCIONES L√ìGICAS ---
            const handleProcessRecarga = async (req, approved) => {
                if(!confirm(approved?"¬øAprobar?":"¬øRechazar?")) return;
                try {
                    const batch = db.batch();
                    batch.update(db.collection('recargas').doc(req.id), {status: approved?'aprobado':'rechazado', fechaProceso: new Date()});
                    if(approved && req.userId) batch.update(db.collection('usuarios').doc(req.userId), {saldo: firebase.firestore.FieldValue.increment(Number(req.monto||0))});
                    await batch.commit();
                } catch(e) { alert(e.message); }
            };

            const handleAttachLink = async (id, current) => {
                const link = prompt("Link:", current||""); if(link===null) return;
                try { await db.collection('solicitudes_servicios').doc(id).update({downloadUrl: link}); alert("‚úÖ Link guardado"); } catch(e){alert(e.message);}
            };

            const handleCompleteOrder = async (id, hasLink) => {
                if(!hasLink && !confirm("Sin link. ¬øSeguir?")) return; if(hasLink && !confirm("¬øEntregar?")) return;
                try { await db.collection('solicitudes_servicios').doc(id).update({status:'completado', fechaCompletado: new Date()}); } catch(e){alert(e.message);}
            };

            const handleViewData = (order) => {
                setSelectedOrderDetails(order);
                setIsDetailsOpen(true);
            };

            // --- L√ìGICA DE STOCK ---
            const handleSaveService = async (e) => {
                e.preventDefault(); setIsSaving(true);
                try {
                    if(editingId) await db.collection('servicios').doc(editingId).update(newService);
                    else await db.collection('servicios').add({...newService, createdAt: new Date(), active: true});
                    setIsModalOpen(false); setEditingId(null); alert("‚úÖ Guardado");
                } catch(e){alert(e.message);} finally{setIsSaving(false);}
            };

            const handleDeleteService = async (id) => { if(confirm("¬øEliminar?")) db.collection('servicios').doc(id).delete(); };
            const handleToggleActive = async (s) => db.collection('servicios').doc(s.id).update({active: !(s.active!==false)});
            
            const openModal = (s) => {
                if(s) { setNewService({ title:s.title||'', category:s.category||'', price:s.price||'', time:s.time||'', isNew:!!s.isNew, fields: s.fields || [] }); setEditingId(s.id); }
                else { setNewService({title:'', category:'', price:'', time:'', isNew:false, fields: []}); setEditingId(null); }
                setIsModalOpen(true);
            };

            const toggleField = (field) => {
                const currentFields = newService.fields || [];
                if (currentFields.includes(field)) { setNewService({ ...newService, fields: currentFields.filter(f => f !== field) }); } 
                else { setNewService({ ...newService, fields: [...currentFields, field] }); }
            };

            // Funciones Usuario
            const handleAddBalance = async (u) => { const m = prompt(`Sumar saldo a ${u.nombre}:`); if(!m) return; try { await db.collection('usuarios').doc(u.id).update({saldo: firebase.firestore.FieldValue.increment(parseFloat(m))}); alert("‚úÖ Listo"); } catch(e){alert(e.message);} };
            const handleSetBalance = async (u) => { const m = prompt(`Nuevo saldo TOTAL para ${u.nombre}:`, u.saldo); if(!m) return; try { await db.collection('usuarios').doc(u.id).update({saldo: parseFloat(m)}); alert("‚úÖ Listo"); } catch(e){alert(e.message);} };
            const handleToggleSuspend = async (u) => { if(confirm("¬øCambiar estado?")) db.collection('usuarios').doc(u.id).update({disabled:!u.disabled}); };
            const handleDeleteUser = async (u) => { if(prompt(`Escribe ELIMINAR para borrar a ${u.email}`)==="ELIMINAR") db.collection('usuarios').doc(u.id).delete(); };
            
            const handleViewHistory = async (u) => {
                setSelectedUserHistory({user:u, compras:[], recargas:[], loading:true}); setHistoryModalOpen(true);
                try {
                    const c = await db.collection('solicitudes_servicios').where('userId','==',u.id).get();
                    const r = await db.collection('recargas').where('userId','==',u.id).get();
                    setSelectedUserHistory({
                        user:u, loading:false,
                        compras: c.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.date?.seconds||0)-(a.date?.seconds||0)),
                        recargas: r.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.fecha?.seconds||0)-(a.fecha?.seconds||0))
                    });
                } catch(e){alert(e.message); setHistoryModalOpen(false);}
            };
            const handleDeleteHistoryItem = async (col, id) => {
                if(!confirm("¬øBorrar registro?")) return;
                try { await db.collection(col).doc(id).delete(); 
                    setSelectedUserHistory(p=>({...p, compras: col.includes('sol')?p.compras.filter(i=>i.id!==id):p.compras, recargas: col.includes('rec')?p.recargas.filter(i=>i.id!==id):p.recargas}));
                } catch(e){alert(e.message);}
            };
            const handleWipeHistory = async (u) => {
                if(prompt("Escribe BORRAR:")!=="BORRAR") return;
                const b = db.batch(); (await db.collection('solicitudes_servicios').where('userId','==',u.id).get()).forEach(d=>b.delete(d.ref));
                (await db.collection('recargas').where('userId','==',u.id).get()).forEach(d=>b.delete(d.ref));
                await b.commit(); alert("‚úÖ Borrado"); setHistoryModalOpen(false);
            };

            // ==========================================
            // VISTAS DEL PANEL
            // ==========================================

            if (section === 'menu') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans"><div className="max-w-4xl mx-auto">
                    <button onClick={onBack} className="mb-6 flex items-center gap-2 text-slate-600 font-bold hover:text-indigo-600"><Icon name="arrow-left" className="w-5 h-5"/> Volver a la Tienda</button>
                    <h2 className="text-3xl font-bold text-slate-800 mb-8 flex items-center gap-3"><Icon name="shield" className="w-8 h-8 text-indigo-600"/> Panel de Administraci√≥n</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <button onClick={()=>setSection('pagos')} className="bg-white p-6 rounded-2xl shadow hover:shadow-xl transition group relative overflow-hidden"><div className="flex justify-between items-start mb-4"><div className="p-3 bg-indigo-50 rounded-xl text-indigo-600"><Icon name="credit-card" className="w-8 h-8"/></div>{requests.length>0 && <span className="bg-rose-500 text-white text-xs font-bold px-3 py-1 rounded-full animate-pulse">{requests.length}</span>}</div><h3 className="text-xl font-bold text-slate-800">Recargas</h3><p className="text-slate-500 text-sm">Aprobar saldo</p></button>
                        <button onClick={()=>setSection('pedidos')} className="bg-white p-6 rounded-2xl shadow hover:shadow-xl transition group relative overflow-hidden"><div className="flex justify-between items-start mb-4"><div className="p-3 bg-orange-50 rounded-xl text-orange-600"><Icon name="shopping-cart" className="w-8 h-8"/></div>{orders.length>0 && <span className="bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full animate-pulse">{orders.length}</span>}</div><h3 className="text-xl font-bold text-slate-800">Pedidos</h3><p className="text-slate-500 text-sm">Solicitudes</p></button>
                        <button onClick={()=>setSection('stock')} className="bg-white p-6 rounded-2xl shadow hover:shadow-xl transition group relative overflow-hidden"><div className="flex justify-between items-start mb-4"><div className="p-3 bg-emerald-50 rounded-xl text-emerald-600"><Icon name="package" className="w-8 h-8"/></div><span className="bg-slate-100 text-slate-600 text-xs font-bold px-3 py-1 rounded-full">{stockList.length}</span></div><h3 className="text-xl font-bold text-slate-800">Stock</h3><p className="text-slate-500 text-sm">Inventario</p></button>
                        <button onClick={()=>setSection('usuarios')} className="bg-white p-6 rounded-2xl shadow hover:shadow-xl transition group relative overflow-hidden"><div className="flex justify-between items-start mb-4"><div className="p-3 bg-blue-50 rounded-xl text-blue-600"><Icon name="users" className="w-8 h-8"/></div><span className="bg-slate-100 text-slate-600 text-xs font-bold px-3 py-1 rounded-full">{usersList.length}</span></div><h3 className="text-xl font-bold text-slate-800">Usuarios</h3><p className="text-slate-500 text-sm">Gesti√≥n</p></button>
                    </div></div></div>
            );

            if (section === 'pagos') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans"><div className="max-w-4xl mx-auto"><button onClick={()=>setSection('menu')} className="mb-6 flex gap-2 font-bold text-slate-600"><Icon name="arrow-left" className="w-5 h-5"/> Volver</button><h2 className="text-2xl font-bold mb-6 flex gap-2"><Icon name="credit-card" className="w-6 h-6 text-indigo-600"/> Recargas</h2>
                <div className="bg-white rounded-xl shadow p-4 space-y-2">{requests.length===0?<p className="text-center text-slate-400 p-4">Sin datos.</p>:requests.map(r=>(<div key={r.id} className="flex justify-between items-center p-3 hover:bg-slate-50 border-b"><div><div className="font-bold">{r.userEmail}</div><div className="text-xs text-slate-500">${r.monto}</div></div><div className="flex gap-2"><button onClick={()=>handleProcessRecarga(r,false)} className="text-rose-600 font-bold text-xs bg-rose-50 px-3 py-2 rounded">RECHAZAR</button><button onClick={()=>handleProcessRecarga(r,true)} className="text-white font-bold text-xs bg-emerald-500 px-3 py-2 rounded">APROBAR</button></div></div>))}</div></div></div>
            );

            // --- VISTA PEDIDOS (CORREGIDA PARA INCLUIR MODAL) ---
            if (section === 'pedidos') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans">
                    <div className="max-w-4xl mx-auto">
                        <button onClick={()=>setSection('menu')} className="mb-6 flex gap-2 font-bold text-slate-600"><Icon name="arrow-left" className="w-5 h-5"/> Volver</button>
                        <h2 className="text-2xl font-bold mb-6 flex gap-2"><Icon name="shopping-cart" className="w-6 h-6 text-orange-600"/> Pedidos</h2>
                        <div className="bg-white rounded-xl shadow p-4 space-y-2">
                            {orders.length===0?<p className="text-center text-slate-400 p-4">Sin datos.</p>:orders.map(o=>(
                                <div key={o.id} className="flex flex-col md:flex-row justify-between items-center p-3 hover:bg-slate-50 border-b gap-3">
                                    <div className="flex-1">
                                        <div><span className="font-black">{o.serviceName}</span> <span className="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 rounded">PAID ${o.pricePaid}</span></div>
                                        <div className="text-xs text-slate-500">{o.userEmail}</div>
                                        {o.downloadUrl && <div className="text-[10px] text-indigo-600 bg-indigo-50 inline-block px-1 rounded border border-indigo-100">Link Adjunto</div>}
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => handleViewData(o)} className="text-xs font-bold border border-blue-200 bg-blue-50 text-blue-600 px-3 py-2 rounded flex gap-1 hover:bg-blue-100"><Icon name="eye" className="w-3 h-3"/> VER DATOS</button>
                                        <button onClick={()=>handleAttachLink(o.id,o.downloadUrl)} className="text-xs font-bold border px-3 py-2 rounded flex gap-1"><Icon name="link" className="w-3 h-3"/> {o.downloadUrl?'EDITAR':'ADJUNTAR'}</button>
                                        <button onClick={()=>handleCompleteOrder(o.id,o.downloadUrl)} className="text-xs font-bold text-white bg-slate-900 px-3 py-2 rounded flex gap-1"><Icon name="check" className="w-3 h-3"/> ATENDIDO</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* MODAL VER DATOS (AHORA DENTRO DE LA VISTA DE PEDIDOS) */}
                    {isDetailsOpen && selectedOrderDetails && (
                        <div className="fixed inset-0 z-[100] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
                                <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                                    <div><h3 className="font-bold text-slate-800">Datos del Pedido</h3><p className="text-xs text-slate-500 uppercase">{selectedOrderDetails.serviceName}</p></div>
                                    <button onClick={() => setIsDetailsOpen(false)}><Icon name="x" className="w-5 h-5 text-slate-400"/></button>
                                </div>
                                <div className="p-6 max-h-[60vh] overflow-y-auto">
                                    {(() => {
                                        const dataToShow = selectedOrderDetails.datosFormulario || selectedOrderDetails.formulario || {};
                                        const keys = Object.keys(dataToShow);
                                        
                                        if (keys.length === 0) return <div className="text-center text-slate-400 py-4">No hay datos adicionales registrados.</div>;

                                        return (
                                            <div className="space-y-3">
                                                {keys.map((key, index) => (
                                                    <div key={index} className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                                        <div className="text-[10px] font-bold text-slate-400 uppercase mb-1">{key}</div>
                                                        <div className="text-sm font-bold text-slate-800 select-text break-all">{dataToShow[key]}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        );
                                    })()}
                                </div>
                                <div className="p-4 border-t bg-slate-50 text-right">
                                    <button onClick={() => setIsDetailsOpen(false)} className="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold">CERRAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );

            if (section === 'stock') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans relative"><div className="max-w-2xl mx-auto"><button onClick={()=>setSection('menu')} className="mb-6 flex gap-2 font-bold text-slate-600"><Icon name="arrow-left" className="w-5 h-5"/> Volver</button><div className="flex justify-between mb-6"><h2 className="text-2xl font-bold flex gap-2"><Icon name="package" className="w-6 h-6 text-emerald-600"/> Inventario</h2><button onClick={()=>openModal()} className="bg-emerald-600 text-white text-xs font-bold px-4 py-2 rounded shadow flex gap-2"><Icon name="plus" className="w-4 h-4"/> Agregar</button></div>
                <div className="space-y-3">{stockList.map(s=>(<div key={s.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center"><div><h4 className="font-bold text-sm">{s.title} {s.active===false&&<span className="text-slate-400 text-xs">(OCULTO)</span>}</h4><p className="text-[10px] text-slate-500 font-bold uppercase">{s.category} ‚Ä¢ <span className="text-emerald-600">{s.price}</span></p></div><div className="flex items-center gap-2"><div className="flex flex-col items-center"><input type="checkbox" checked={s.active!==false} onChange={()=>handleToggleActive(s)}/><span className="text-[9px] font-bold">{s.active!==false?'ON':'OFF'}</span></div><button onClick={()=>openModal(s)} className="p-2 bg-yellow-50 text-yellow-600 rounded"><Icon name="pencil" className="w-4 h-4"/></button><button onClick={()=>handleDeleteService(s.id)} className="p-2 bg-rose-50 text-rose-600 rounded"><Icon name="trash-2" className="w-4 h-4"/></button></div></div>))}</div></div>
                {isModalOpen && (<div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name={editingId?"edit":"plus-circle"} className="w-5 h-5 text-indigo-600"/>{editingId?'Editar':'Nuevo'}</h3><button onClick={()=>setIsModalOpen(false)}><Icon name="x" className="w-5 h-5 text-slate-400"/></button></div>
                <form onSubmit={handleSaveService} className="space-y-4"><input className="w-full border p-2 rounded" placeholder="Titulo" value={newService.title} onChange={e=>setNewService({...newService,title:e.target.value.toUpperCase()})}/><input className="w-full border p-2 rounded" placeholder="Categoria" value={newService.category} onChange={e=>setNewService({...newService,category:e.target.value.toUpperCase()})}/><div className="grid grid-cols-2 gap-2"><input className="border p-2 rounded" placeholder="Precio" value={newService.price} onChange={e=>setNewService({...newService,price:e.target.value})}/><input className="border p-2 rounded" placeholder="Tiempo" value={newService.time} onChange={e=>setNewService({...newService,time:e.target.value})}/></div>
                <div className="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-100"><span className="text-xs font-bold text-slate-600">¬øEtiqueta "NUEVO"?</span><label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" className="sr-only peer" checked={newService.isNew} onChange={e => setNewService({...newService, isNew: e.target.checked})} /><div className="w-10 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div></label></div>
                <div className="border-t border-slate-100 pt-3"><p className="text-xs font-bold text-slate-500 mb-2 uppercase">Datos Requeridos:</p><div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto bg-slate-50 p-2 rounded border border-slate-200">{availableFields.map(label => (<label key={label} className="flex items-center gap-2 text-xs cursor-pointer hover:bg-slate-100 p-1 rounded"><input type="checkbox" checked={(newService.fields || []).includes(label)} onChange={() => toggleField(label)} className="rounded text-indigo-600 focus:ring-indigo-500"/><span className="truncate">{label}</span></label>))}</div></div>
                <button className="w-full bg-slate-900 text-white py-3 rounded font-bold">GUARDAR</button></form></div></div>)}</div>
            );

            // --- VISTA USUARIOS (V20 - DISE√ëO ORIGINAL RESTAURADO + ID AGREGADO) ---
            if (section === 'usuarios') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans"><div className="max-w-6xl mx-auto"><button onClick={()=>setSection('menu')} className="mb-6 flex gap-2 font-bold text-slate-600"><Icon name="arrow-left" className="w-5 h-5"/> Volver</button><h2 className="text-2xl font-bold mb-6 flex gap-2"><Icon name="users" className="w-6 h-6 text-indigo-600"/> Usuarios</h2>
                <div className="bg-white rounded-xl shadow border border-slate-200 overflow-hidden"><div className="p-4 bg-slate-50 border-b border-slate-200"><span className="font-bold text-xs uppercase">Total: {usersList.length}</span></div><div className="overflow-x-auto"><table className="w-full text-left text-sm text-slate-600"><thead className="bg-slate-50 font-bold text-xs uppercase border-b"><tr><th className="px-6 py-4">Usuario</th><th className="px-6 py-4">Acciones</th></tr></thead><tbody className="divide-y divide-slate-100">
                {usersList.map(u => (<tr key={u.id} className={u.disabled?"bg-red-50":"hover:bg-slate-50"}><td className="px-6 py-4 w-1/3"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center font-bold text-indigo-600">{u.nombre?u.nombre[0]:'U'}</div><div>
                    <div className="font-black text-slate-800 flex items-center gap-2">{u.nombre||'SIN NOMBRE'} <span className="text-[10px] bg-emerald-100 text-emerald-700 px-2 rounded font-bold">${(u.saldo||0).toFixed(2)}</span></div>
                    <div className="text-xs text-indigo-500">{u.email}</div>
                    
                    {/* --- AQU√ç AGREGAMOS EL ID DEL USUARIO SIN CAMBIAR EL DISE√ëO --- */}
                    <div className="text-[9px] text-slate-400 font-mono mt-0.5 select-text">ID: {u.id}</div>

                </div></div></td>
                <td className="px-6 py-4"><div className="flex flex-wrap gap-2">
                    <div className="flex bg-emerald-50 rounded border border-emerald-100"><button onClick={()=>handleAddBalance(u)} className="p-2 border-r border-emerald-100 text-emerald-700"><Icon name="plus" className="w-4 h-4"/></button><button onClick={()=>handleSetBalance(u)} className="p-2 text-emerald-700"><Icon name="edit-3" className="w-4 h-4"/></button></div>
                    <div className="flex bg-blue-50 rounded border border-blue-100"><button onClick={()=>handleViewHistory(u)} className="p-2 border-r border-blue-100 text-blue-700"><Icon name="file-clock" className="w-4 h-4"/></button><button onClick={()=>handleWipeHistory(u)} className="p-2 text-blue-700"><Icon name="file-x" className="w-4 h-4"/></button></div>
                    <div className="flex bg-slate-100 rounded border border-slate-200"><button onClick={()=>handleToggleSuspend(u)} className="p-2 border-r border-slate-200 text-slate-600"><Icon name={u.disabled?"check-circle":"ban"} className="w-4 h-4"/></button><button onClick={()=>handleDeleteUser(u)} className="p-2 text-rose-600"><Icon name="user-x" className="w-4 h-4"/></button></div>
                </div></td></tr>))}</tbody></table></div></div></div>
                
                {historyModalOpen && (<div className="fixed inset-0 z-[100] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4"><div className="bg-white w-full max-w-3xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                    <div className="p-4 border-b bg-slate-50 flex justify-between items-center"><div><h3 className="font-bold">Historial</h3><p className="text-xs text-slate-500">{selectedUserHistory.user?.email}</p></div><button onClick={()=>setHistoryModalOpen(false)}><Icon name="x" className="w-5 h-5"/></button></div>
                    <div className="flex-1 overflow-y-auto p-6 bg-slate-100"><div className="grid md:grid-cols-2 gap-6">
                        <div><h4 className="font-bold text-indigo-600 mb-3">Compras</h4><div className="space-y-2">{selectedUserHistory.compras.map(c=>(<div key={c.id} className="bg-white p-3 rounded shadow text-xs relative"><div className="font-bold pr-6">{c.serviceName}</div><div className="text-emerald-600 font-bold">${c.pricePaid}</div><button onClick={()=>handleDeleteHistoryItem('solicitudes_servicios',c.id)} className="absolute top-2 right-2 text-slate-300 hover:text-rose-500"><Icon name="trash-2" className="w-4 h-4"/></button></div>))}</div></div>
                        <div><h4 className="font-bold text-emerald-600 mb-3">Recargas</h4><div className="space-y-2">{selectedUserHistory.recargas.map(r=>(<div key={r.id} className="bg-white p-3 rounded shadow text-xs relative"><div className="font-bold pr-6">${r.monto}</div><div className="text-slate-500">{r.concept}</div><button onClick={()=>handleDeleteHistoryItem('recargas',r.id)} className="absolute top-2 right-2 text-slate-300 hover:text-rose-500"><Icon name="trash-2" className="w-4 h-4"/></button></div>))}</div></div>
                    </div></div></div></div>
                )}</div>
            );

            return null;
        };





        
                                     // ==========================================
        // COMPONENTE: EDITOR CERTIFICADO COVID (CLON FINAL - FULL NAME GRANDE)
        // ==========================================
        const CovidEditor = ({ onBack }) => {
            const [data, setData] = useState({
                curp: 'LIGR920126HCMNNB01', 
                nombre: 'RUBEN LINARES GONZALEZ',
                dosis1: { fecha: '2021-03-18', marca: 'AstraZeneca', lote: 'I-592740' },
                dosis2: { fecha: '2021-08-16', marca: 'AstraZeneca', lote: 'I-694376' },
                selloDigital: '278feab6-2b4f-4fe4-b9b7-3e8dcff84934',
                fechaEmision: '2025-12-02 15:56:03'
            });

            const handleChange = (field, value) => {
                setData(prev => ({ ...prev, [field]: value.toUpperCase() }));
            };

            const handleDoseChange = (dose, field, value) => {
                setData(prev => ({ ...prev, [dose]: { ...prev[dose], [field]: value } }));
            };

            const headerImage = "https://i.postimg.cc/6pXNzC2y/20260201-084246-0000.png";

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-slate-100 font-sans">
                    {/* IMPORTAMOS LA FUENTE MONTSERRAT */}
                    <style>
                        {`@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');`}
                    </style>

                    {/* --- PANEL DE EDICI√ìN (IZQUIERDA) --- */}
                    <div className="w-full lg:w-1/3 bg-white border-r border-slate-200 p-5 no-print h-screen overflow-y-auto z-20 shadow-xl">
                        <div className="mb-6 flex justify-between items-center">
                            <button onClick={onBack} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-bold transition">
                                <i data-lucide="arrow-left" className="w-5 h-5"></i> Regresar
                            </button>
                            <button onClick={() => window.print()} className="bg-slate-900 text-white px-4 py-2 rounded-lg font-bold hover:bg-emerald-600 transition flex items-center gap-2 text-xs shadow-lg">
                                <i data-lucide="printer" className="w-4 h-4"></i> IMPRIMIR
                            </button>
                        </div>
                        
                        <div className="space-y-6 text-xs font-['Montserrat']">
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h3 className="font-black text-slate-400 uppercase tracking-widest mb-3">Datos Personales</h3>
                                <div className="space-y-3">
                                    <div><label className="block font-bold text-slate-700 mb-1">CURP</label><input className="w-full border border-slate-300 rounded p-2 outline-none font-mono uppercase focus:border-indigo-500" value={data.curp} onChange={e => handleChange('curp', e.target.value)} /></div>
                                    <div><label className="block font-bold text-slate-700 mb-1">Nombre Completo</label><input className="w-full border border-slate-300 rounded p-2 outline-none uppercase focus:border-indigo-500" value={data.nombre} onChange={e => handleChange('nombre', e.target.value)} /></div>
                                </div>
                            </div>
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <h3 className="font-black text-blue-400 uppercase tracking-widest mb-3">1¬™ Dosis</h3>
                                <div className="space-y-3">
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="block font-bold text-slate-500">Fecha</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis1.fecha} onChange={e => handleDoseChange('dosis1', 'fecha', e.target.value)} /></div>
                                        <div><label className="block font-bold text-slate-500">Lote</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis1.lote} onChange={e => handleDoseChange('dosis1', 'lote', e.target.value)} /></div>
                                    </div>
                                    <div><label className="block font-bold text-slate-500">Marca</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis1.marca} onChange={e => handleDoseChange('dosis1', 'marca', e.target.value)} /></div>
                                </div>
                            </div>
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <h3 className="font-black text-blue-800 uppercase tracking-widest mb-3">2¬™ Dosis</h3>
                                <div className="space-y-3">
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="block font-bold text-slate-500">Fecha</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis2.fecha} onChange={e => handleDoseChange('dosis2', 'fecha', e.target.value)} /></div>
                                        <div><label className="block font-bold text-slate-500">Lote</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis2.lote} onChange={e => handleDoseChange('dosis2', 'lote', e.target.value)} /></div>
                                    </div>
                                    <div><label className="block font-bold text-slate-500">Marca</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis2.marca} onChange={e => handleDoseChange('dosis2', 'marca', e.target.value)} /></div>
                                </div>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h3 className="font-black text-slate-400 uppercase tracking-widest mb-3">Pie de P√°gina</h3>
                                <div><label className="block font-bold text-slate-500 mb-1">Fecha Emisi√≥n</label><input className="w-full border border-slate-300 rounded p-2 mb-3 focus:border-indigo-500" value={data.fechaEmision} onChange={e => handleChange('fechaEmision', e.target.value)} /></div>
                                <div><label className="block font-bold text-slate-500 mb-1">Sello Digital (Hash)</label><textarea className="w-full border border-slate-300 rounded p-2 font-mono h-16 text-[10px] focus:border-indigo-500" value={data.selloDigital} onChange={e => handleChange('selloDigital', e.target.value)} /></div>
                            </div>
                        </div>
                    </div>

                    {/* --- VISTA PREVIA (DERECHA - CLON FINAL) --- */}
                    <div className="w-full lg:w-2/3 bg-gray-600 flex justify-center items-start p-8 print-area overflow-auto">
                        <div className="paper bg-white w-[21.59cm] min-h-[27.94cm] relative shadow-none flex flex-col items-center pt-0 pb-12 px-12" 
                             style={{ fontFamily: 'Arial, sans-serif', color: '#1a1a1a' }}>
                            
                            {/* 1. HEADER (LOGO) */}
                            <div className="w-full mb-0 px-6 relative z-10 mt-[-15px]">
                                <img src={headerImage} alt="Encabezado" className="w-full object-contain" />
                            </div>

                            {/* 2. T√çTULO */}
                            <div className="text-center mb-3 w-full mt-[-8px] relative z-20">
                                <h1 className="text-[42px] font-black mb-0 leading-[0.8] tracking-tighter w-full transform scale-x-[1.05]" style={{ color: '#1a1a1a' }}>
                                    CERTIFICADO DE VACUNACI√ìN
                                </h1>
                                <h1 className="text-[42px] font-black mb-1 leading-[0.8] tracking-tighter w-full transform scale-x-[1.05]" style={{ color: '#1a1a1a' }}>
                                    CONTRA LA COVID-19
                                </h1>
                                <p className="text-[15px] mt-1 tracking-[0.25em] uppercase font-normal scale-y-90" style={{ color: '#1a1a1a' }}>COVID-19 VACCINATION CERTIFICATE</p>
                            </div>

                            {/* 3. DATOS PERSONALES */}
                            <div className="w-full mb-5 text-center">
                                <div className="mb-1">
                                    <p className="text-[24px] font-bold mb-0 leading-tight" style={{ color: '#1a1a1a', transform: 'scaleX(1.20)' }}>Clave √önica de Registro de Poblaci√≥n:</p>
                                    <p className="text-[13px] mb-0.5 leading-none font-normal tracking-[0.04em]" style={{ color: '#444' }}>Unique Population Registry Code:</p>
                                    <p className="text-[22px] tracking-wide uppercase mt-0.5 font-normal scale-y-95" style={{ color: '#1a1a1a' }}>{data.curp}</p>
                                </div>
                                <div>
                                    <p className="text-[24px] font-bold mb-0 leading-tight" style={{ color: '#1a1a1a' }}>Nombre completo:</p>
                                    
                                    {/* CAMBIO APLICADO: AUMENTADO A 14PX (ANTES 12PX) */}
                                    <p className="text-[14px] mb-1 leading-none font-normal" style={{ color: '#444' }}>Full name:</p>
                                    
                                    <p className="text-[22px] tracking-wide uppercase mt-1.5 font-normal scale-y-95" style={{ color: '#1a1a1a' }}>{data.nombre}</p>
                                </div>
                            </div>

                            {/* 4. TABLA DE VACUNACI√ìN - SEPARADA */}
                            {/* CUADRO 1: T√çTULOS */}
                            <div className="w-[95%] mx-auto mb-1 border border-[#1a1a1a] flex">
                                <div className="w-1/2 py-1.5 text-center border-r border-[#1a1a1a]">
                                    <div className="font-bold text-[18px] leading-tight" style={{ color: '#1a1a1a' }}>1¬∫ Dosis</div>
                                    <div className="text-[12px] leading-tight" style={{ color: '#444' }}>First dose</div>
                                </div>
                                <div className="w-1/2 py-1.5 text-center">
                                    <div className="font-bold text-[18px] leading-tight" style={{ color: '#1a1a1a' }}>2¬∫ Dosis</div>
                                    <div className="text-[12px] leading-tight" style={{ color: '#444' }}>Second dose</div>
                                </div>
                            </div>

                            {/* CUADRO 2: CONTENIDO */}
                            <div className="w-[95%] mx-auto mb-2 border border-[#1a1a1a] flex">
                                {/* Columna 1 */}
                                <div className="w-1/2 pt-5 pb-8 px-2 flex flex-col gap-5 border-r border-[#1a1a1a] items-center text-center">
                                    <div>
                                        <div className="font-bold text-[15px] leading-tight" style={{ color: '#1a1a1a' }}>Fecha de aplicaci√≥n:</div>
                                        <div className="text-[11px] leading-none mb-1" style={{ color: '#444' }}>Application date:</div>
                                        <div className="text-[18px] mt-0.5 font-normal" style={{ color: '#1a1a1a' }}>{data.dosis1.fecha}</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-[15px] leading-tight" style={{ color: '#1a1a1a' }}>Marca de la vacuna:</div>
                                        <div className="text-[11px] leading-none mb-1" style={{ color: '#444' }}>Vaccine manufacturer:</div>
                                        <div className="text-[18px] mt-0.5 font-normal" style={{ color: '#1a1a1a' }}>{data.dosis1.marca}</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-[15px] leading-tight" style={{ color: '#1a1a1a' }}>Lote de la vacuna:</div>
                                        <div className="text-[11px] leading-none mb-1" style={{ color: '#444' }}>Vaccine lot number:</div>
                                        <div className="text-[18px] mt-0.5 font-normal" style={{ color: '#1a1a1a' }}>{data.dosis1.lote}</div>
                                    </div>
                                </div>
                                
                                {/* Columna 2 */}
                                <div className="w-1/2 pt-5 pb-8 px-2 flex flex-col gap-5 items-center text-center">
                                    <div>
                                        <div className="font-bold text-[15px] leading-tight" style={{ color: '#1a1a1a' }}>Fecha de aplicaci√≥n:</div>
                                        <div className="text-[11px] leading-none mb-1" style={{ color: '#444' }}>Application date:</div>
                                        <div className="text-[18px] mt-0.5 font-normal" style={{ color: '#1a1a1a' }}>{data.dosis2.fecha}</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-[15px] leading-tight" style={{ color: '#1a1a1a' }}>Marca de la vacuna:</div>
                                        <div className="text-[11px] leading-none mb-1" style={{ color: '#444' }}>Vaccine manufacturer:</div>
                                        <div className="text-[18px] mt-0.5 font-normal" style={{ color: '#1a1a1a' }}>{data.dosis2.marca}</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-[15px] leading-tight" style={{ color: '#1a1a1a' }}>Lote de la vacuna:</div>
                                        <div className="text-[11px] leading-none mb-1" style={{ color: '#444' }}>Vaccine lot number:</div>
                                        <div className="text-[18px] mt-0.5 font-normal" style={{ color: '#1a1a1a' }}>{data.dosis2.lote}</div>
                                    </div>
                                </div>
                            </div>

                            {/* 5. PIE DE P√ÅGINA */}
                            <div className="w-full flex justify-between items-end mt-4 px-4">
                                <div className="w-[30%] flex flex-col pl-4 pb-4">
                                    <div className="mb-2 ml-2 relative h-16 w-32 opacity-90">
                                        <svg width="100%" height="100%" viewBox="0 0 150 80">
                                            <path d="M10,60 C25,25 45,15 55,55 C60,75 65,35 75,25 C85,15 95,65 105,55" stroke="#1a1a1a" strokeWidth="2" fill="none" strokeLinecap="round" />
                                            <path d="M20,58 L115,42" stroke="#1a1a1a" strokeWidth="1.2" fill="none" />
                                            <path d="M58,25 L52,68" stroke="#1a1a1a" strokeWidth="1.8" fill="none" />
                                        </svg>
                                    </div>
                                </div>
                                <div className="w-[65%] flex flex-col items-end pr-2">
                                    <div className="border border-[#1a1a1a] p-[2px] mb-2 w-full text-left bg-white">
                                        <div className="text-[10px] uppercase font-bold mb-0.5 leading-none ml-1 mt-0.5" style={{ color: '#1a1a1a' }}>SELLO DIGITAL/DIGITAL STAMP:</div>
                                        <div className="text-[10px] break-all leading-none ml-1 mb-0.5" style={{ fontFamily: "'Courier New', Courier, monospace", color: '#444' }}>{data.selloDigital}</div>
                                    </div>
                                    <div className="text-right mb-4">
                                        <span className="font-bold text-[11px]" style={{ color: '#1a1a1a' }}>Emisi√≥n del documento/Document issued: </span>
                                        <span className="text-[11px]" style={{ fontFamily: "'Courier New', Courier, monospace", color: '#1a1a1a' }}>{data.fechaEmision}</span>
                                    </div>
                                    <div className="text-[9px] leading-[1.2] text-right w-full" style={{ color: '#1a1a1a' }}>
                                        <p className="mb-0.5">Para validar la autenticidad de √©ste documento, por favor escanee el</p>
                                        <p className="mb-0.5">c√≥digo QR que debe abrir la p√°gina <b>https://cvcovid.salud.gob.mx</b></p>
                                        <p className="text-[#555] mb-0.5">To validate the authenticity of this document, please scann the QR</p>
                                        <p className="text-[#555]">code that should open the page <b>https://cvcovid.salud.gob.mx</b></p>
                                    </div>
                                </div>
                            </div>

                            {/* 6. BANNER RENAPO */}
                            <div className="w-full text-center mt-auto">
                                <div className="inline-block bg-[#e2e2e2] px-3 py-1.5">
                                    <p className="text-[8.5px] uppercase tracking-wide leading-tight text-center" style={{ color: '#1a1a1a' }}>
                                        "La Secretar√≠a de Gobernaci√≥n a trav√©s de <span className="font-bold">RENAPO</span>, acredita que la CURP fue verificada en la base de datos <br/> del Registro Nacional de Poblaci√≥n".
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
                      // ==========================================
        // COMPONENTE: HISTORIAL DE COMPRAS (V3 - URL ABSOLUTA CORREGIDA)
        // ==========================================
        const PurchaseHistory = ({ onBack }) => {
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if(window.lucide) window.lucide.createIcons();
                
                const user = auth.currentUser;
                if (!user) return;

                const unsubscribe = db.collection('solicitudes_servicios')
                    .where('userId', '==', user.uid)
                    .onSnapshot(snapshot => {
                        const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        docs.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
                        setHistory(docs);
                        setLoading(false);
                    });

                return () => unsubscribe();
            }, []);

            // --- FUNCI√ìN DE LIMPIEZA DE URL ---
            const openCleanUrl = (rawText) => {
                if (!rawText) {
                    alert("No hay enlace disponible.");
                    return;
                }

                // 1. Buscamos expl√≠citamente una URL que empiece por http:// o https://
                // Esta expresi√≥n regular extrae la URL sin importar qu√© texto haya antes.
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const match = rawText.match(urlRegex);

                let finalUrl = "";

                if (match && match.length > 0) {
                    // CASO A: Encontramos "https://..." dentro del texto. Usamos SOLO eso.
                    finalUrl = match[0];
                } else {
                    // CASO B: El admin puso "www.google.com" o "drive.google.com" SIN http.
                    // Si lo dejamos as√≠, el navegador le pone "127.0.0.1..." antes.
                    // SOLUCI√ìN: Forzamos el "https://" al principio.
                    
                    // Limpiamos espacios y posibles etiquetas de texto
                    let cleanText = rawText.trim();
                    // Quitamos prefijos comunes si el admin escribi√≥ "Link: www..."
                    cleanText = cleanText.replace(/^(Link|Ver|Url|Descargar)[:\s]*/i, '');
                    
                    finalUrl = 'https://' + cleanText;
                }

                // Abrir en nueva pesta√±a
                window.open(finalUrl, '_blank');
            };

            return (
                <div className="min-h-screen bg-slate-50 p-6 font-sans">
                    <div className="max-w-3xl mx-auto">
                        <button onClick={onBack} className="mb-6 flex items-center gap-2 text-slate-600 font-bold hover:text-indigo-600 transition">
                            <i data-lucide="arrow-left" className="w-5 h-5"></i> Volver a la Tienda
                        </button>
                        
                        <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                            <i data-lucide="history" className="w-6 h-6 text-indigo-600"></i>
                            Historial de Compras
                        </h2>

                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-slate-500 uppercase text-xs tracking-wider">
                                Mis Documentos ({history.length})
                            </div>
                            
                            {loading ? (
                                <div className="p-10 text-center text-slate-400">Cargando historial...</div>
                            ) : history.length === 0 ? (
                                <div className="p-10 text-center text-slate-400">
                                    <i data-lucide="shopping-bag" className="w-12 h-12 mx-auto mb-3 opacity-30 text-indigo-500"></i>
                                    <p>A√∫n no has realizado ninguna compra.</p>
                                </div>
                            ) : (
                                <div className="divide-y divide-slate-100">
                                    {history.map(item => (
                                        <div key={item.id} className="p-4 hover:bg-slate-50 transition flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <h4 className="font-bold text-slate-800 text-sm">{item.serviceName}</h4>
                                                    <span className={`text-[9px] font-bold px-2 py-0.5 rounded-full border uppercase ${
                                                        item.status === 'completado' 
                                                            ? 'bg-emerald-100 text-emerald-700 border-emerald-200' 
                                                            : 'bg-amber-100 text-amber-700 border-amber-200'
                                                    }`}>
                                                        {item.status === 'completado' ? 'Listo / Entregado' : 'En Proceso'}
                                                    </span>
                                                </div>
                                                <div className="text-[11px] text-slate-500 flex items-center gap-3">
                                                    <span className="flex items-center gap-1"><i data-lucide="calendar" className="w-3 h-3"></i> {item.date ? new Date(item.date.seconds * 1000).toLocaleDateString() : 'Fecha desc.'}</span>
                                                    <span className="flex items-center gap-1"><i data-lucide="tag" className="w-3 h-3"></i> {item.category}</span>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                 <span className="font-bold text-slate-700 text-sm">${item.pricePaid}</span>
                                                 
                                                 {/* BOT√ìN DE DESCARGA CON FUNCI√ìN CORREGIDA */}
                                                 {item.status === 'completado' && (
                                                     <button 
                                                        onClick={() => openCleanUrl(item.downloadUrl)} 
                                                        className="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md shadow-indigo-200 transition font-bold text-xs flex items-center gap-2" 
                                                        title="Descargar Documento"
                                                     >
                                                        <i data-lucide="download" className="w-4 h-4"></i> DESCARGAR
                                                     </button>
                                                 )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        
                       // ==========================================
        // COMPONENTE: PERFIL DE USUARIO (V13 - BLINDAJE TOTAL CON SAFE-ICON)
        // ==========================================
        const UserProfile = ({ onBack }) => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState({});
            const [stats, setStats] = useState({ spent: 0, recharged: 0 });
            const [loading, setLoading] = useState(true);

            // Estado para edici√≥n
            const [editingField, setEditingField] = useState(null);
            const [tempValue, setTempValue] = useState("");
            const [isSaving, setIsSaving] = useState(false);
            
            // Estado para mensaje de √©xito
            const [successField, setSuccessField] = useState(null);

            // --- 1. COMPONENTE DE SEGURIDAD PARA ICONOS ---
            // Esto evita que React se rompa cuando los iconos cambian
            const SafeIcon = ({ name, className }) => (
                <span 
                    dangerouslySetInnerHTML={{
                        __html: `<i data-lucide="${name}" class="${className || ''}"></i>`
                    }}
                    style={{ display: 'inline-flex' }}
                />
            );

            // 2. MOTOR DE ICONOS BLINDADO
            useEffect(() => {
                // Peque√±o retraso para asegurar que el DOM est√° listo
                const timer = setTimeout(() => {
                    try {
                        if(window.lucide) window.lucide.createIcons();
                    } catch(e) { console.warn("Error de iconos prevenido"); }
                }, 100);
                return () => clearTimeout(timer);
            }, [loading, editingField, successField, userData]);

            useEffect(() => {
                const currentUser = auth.currentUser;
                if (!currentUser) return;
                setUser(currentUser);

                const unsubUser = db.collection('usuarios').doc(currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) setUserData(doc.data());
                    else setUserData({ email: currentUser.email });
                    setLoading(false);
                });

                const fetchStats = async () => {
                    try {
                        const ordersSnap = await db.collection('solicitudes_servicios').where('userId', '==', currentUser.uid).get();
                        const totalSpent = ordersSnap.docs.reduce((acc, doc) => acc + (doc.data().pricePaid || 0), 0);
                        const rechargesSnap = await db.collection('recargas').where('userId', '==', currentUser.uid).where('status', '==', 'aprobado').get();
                        const totalRecharged = rechargesSnap.docs.reduce((acc, doc) => acc + (doc.data().monto || 0), 0);
                        setStats({ spent: totalSpent, recharged: totalRecharged });
                    } catch (e) { console.error(e); }
                };
                fetchStats();
                return () => unsubUser();
            }, []);

            const startEditing = (field, currentValue) => {
                setSuccessField(null); 
                setEditingField(field);
                setTempValue(currentValue || "");
            };

            const cancelEditing = () => {
                setEditingField(null);
                setTempValue("");
            };

            const saveField = async (field) => {
                if (!user) return;
                setIsSaving(true);
                try {
                    const finalValue = field === 'genero' ? tempValue : String(tempValue || "").toUpperCase();
                    
                    await db.collection('usuarios').doc(user.uid).set({
                        [field]: finalValue
                    }, { merge: true });
                    
                    setEditingField(null); 
                    setSuccessField(field); 
                    
                    setTimeout(() => setSuccessField(null), 1500);

                } catch (error) {
                    alert("Error: " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            const formatDate = (timestamp) => {
                if(!timestamp) return 'Reciente';
                if(timestamp.toDate) return timestamp.toDate().toLocaleDateString();
                return new Date(timestamp).toLocaleDateString();
            };

            // RENDERIZADOR DE CAMPOS (USANDO SAFEICON)
            const renderEditableField = (field, label, iconName, placeholder, type = "text") => {
                const isEditing = editingField === field;
                const isSuccess = successField === field;
                const value = isEditing ? tempValue : (userData[field] || "");

                // KEY √öNICA: Obliga a React a limpiar el componente al cambiar de estado
                const componentKey = `field-${field}-${isEditing ? 'edit' : 'view'}-${isSuccess ? 'ok' : 'no'}`;

                let actionButtons;

                if (isEditing) {
                    actionButtons = (
                        <div className="flex gap-2">
                            <button onClick={cancelEditing} disabled={isSaving} className="text-slate-400 hover:text-slate-600 bg-slate-100 p-1 rounded">
                                <SafeIcon name="x" className="w-4 h-4" />
                            </button>
                            <button onClick={() => saveField(field)} disabled={isSaving} className="text-white bg-emerald-500 hover:bg-emerald-600 p-1 rounded font-bold shadow-emerald-200 shadow-sm">
                                {isSaving ? <span className="text-[10px]">...</span> : <SafeIcon name="check" className="w-4 h-4" />}
                            </button>
                        </div>
                    );
                } else if (isSuccess) {
                    actionButtons = (
                        <span className="text-emerald-600 text-[10px] font-bold px-2 py-1 bg-emerald-50 rounded border border-emerald-100 animate-pulse">
                            ¬°GUARDADO!
                        </span>
                    );
                } else {
                    actionButtons = (
                        <button onClick={() => startEditing(field, userData[field])} className="text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 p-1.5 rounded-full transition">
                            <SafeIcon name="pencil" className="w-4 h-4" />
                        </button>
                    );
                }

                return (
                    <div key={componentKey} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm mb-3 transition-all hover:shadow-md">
                        <div className="flex justify-between items-center mb-1">
                            <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-1">
                                <SafeIcon name={iconName} className="w-3 h-3" /> {label}
                            </label>
                            {actionButtons}
                        </div>
                        <div className="relative">
                            <input 
                                type={type} 
                                value={value}
                                onChange={(e) => setTempValue(e.target.value)}
                                disabled={!isEditing}
                                placeholder={placeholder}
                                className={`w-full bg-transparent outline-none font-bold text-slate-700 transition-all ${isEditing ? 'border-b-2 border-indigo-500 pb-1' : 'text-slate-800'}`}
                            />
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 p-6 font-sans pb-20">
                    <div className="max-w-xl mx-auto">
                        <button onClick={onBack} className="mb-6 flex items-center gap-2 text-slate-600 font-bold hover:text-indigo-600 transition">
                            <SafeIcon name="arrow-left" className="w-5 h-5" /> Volver a la Tienda
                        </button>
                        
                        <div className="flex items-center gap-4 mb-8">
                            <div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 border-2 border-indigo-200 shadow-sm">
                                <SafeIcon name="user-cog" className="w-8 h-8" />
                            </div>
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Mi Perfil</h2>
                                <p className="text-slate-500 text-sm">Gestiona tus datos personales</p>
                            </div>
                        </div>

                        {loading ? (
                            <div className="text-center py-10 text-slate-400 flex flex-col items-center gap-2">
                                <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-500"></div>
                                Cargando perfil...
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <div>
                                    <div className="mb-2 px-1 text-xs font-black text-slate-400 uppercase tracking-widest">Informaci√≥n Personal</div>
                                    
                                    {/* CORREO (NO EDITABLE) */}
                                    <div className="bg-slate-100 p-4 rounded-xl border border-slate-200 mb-3 opacity-70">
                                        <div className="flex justify-between items-center mb-1">
                                            <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-1"><SafeIcon name="mail" className="w-3 h-3" /> Correo</label>
                                            <SafeIcon name="lock" className="w-3 h-3 text-slate-400" />
                                        </div>
                                        <div className="font-bold text-slate-600 break-all">{user?.email}</div>
                                    </div>

                                    {renderEditableField("nombre", "Nombre Completo", "user", "Tu Nombre")}
                                    {renderEditableField("telefono", "Tel√©fono", "phone", "55 0000 0000", "tel")}
                                    {renderEditableField("direccion", "Direcci√≥n", "map-pin", "Ciudad, Estado")}

                                    {/* G√âNERO */}
                                    <div key={`genero-${editingField === 'genero' ? 'edit' : 'view'}-${successField === 'genero' ? 'ok' : 'normal'}`} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm mb-3 transition-all hover:shadow-md">
                                        <div className="flex justify-between items-center mb-3">
                                            <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-1">
                                                <SafeIcon name="users" className="w-3 h-3" /> G√©nero
                                            </label>
                                            
                                            {editingField === 'genero' ? (
                                                 <div className="flex gap-2">
                                                    <button onClick={cancelEditing} disabled={isSaving} className="text-slate-400 hover:text-slate-600 bg-slate-100 p-1 rounded"><SafeIcon name="x" className="w-4 h-4" /></button>
                                                    <button onClick={() => saveField('genero')} disabled={isSaving} className="text-white bg-emerald-500 hover:bg-emerald-600 p-1 rounded font-bold shadow-emerald-200 shadow-sm">
                                                        {isSaving ? <span className="text-[10px]">...</span> : <SafeIcon name="check" className="w-4 h-4" />}
                                                    </button>
                                                </div>
                                            ) : successField === 'genero' ? (
                                                <span className="text-emerald-600 text-[10px] font-bold px-2 py-1 bg-emerald-50 rounded border border-emerald-100 animate-pulse">¬°GUARDADO!</span>
                                            ) : (
                                                <button onClick={() => startEditing('genero', userData.genero)} className="text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 p-1.5 rounded-full transition">
                                                    <SafeIcon name="pencil" className="w-4 h-4" />
                                                </button>
                                            )}
                                        </div>
                                        
                                        <div className="flex gap-2 overflow-x-auto pb-1">
                                            {['Femenino', 'Masculino', 'No Binario'].map(option => {
                                                const currentVal = editingField === 'genero' ? tempValue : userData.genero;
                                                const isSelected = currentVal === option;
                                                return (
                                                    <label key={option} className={`flex-shrink-0 cursor-pointer px-4 py-2 rounded-lg border text-xs font-bold transition-all flex items-center gap-2 ${isSelected ? 'bg-indigo-600 text-white border-indigo-600 shadow-md ring-2 ring-indigo-200' : 'bg-slate-50 text-slate-500 border-slate-200 hover:bg-slate-100'} ${editingField !== 'genero' ? 'pointer-events-none opacity-60' : ''}`}>
                                                        <input type="radio" name="genero" value={option} checked={isSelected} onChange={(e) => setTempValue(e.target.value)} className="sr-only" disabled={editingField !== 'genero'} />
                                                        {isSelected && <SafeIcon name="check-circle" className="w-3 h-3" />}
                                                        {option}
                                                    </label>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div className="mb-2 px-1 text-xs font-black text-slate-400 uppercase tracking-widest mt-6">Estad√≠sticas de Cuenta</div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center text-center">
                                            <div className="w-10 h-10 rounded-full bg-rose-50 flex items-center justify-center text-rose-500 mb-2 border border-rose-100"><SafeIcon name="trending-down" className="w-5 h-5" /></div>
                                            <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Saldo Gastado</div>
                                            <div className="text-xl font-black text-slate-800 mt-1">${stats.spent.toFixed(2)}</div>
                                        </div>
                                        <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center text-center">
                                            <div className="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-500 mb-2 border border-emerald-100"><SafeIcon name="trending-up" className="w-5 h-5" /></div>
                                            <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Saldo Recargado</div>
                                            <div className="text-xl font-black text-slate-800 mt-1">${stats.recharged.toFixed(2)}</div>
                                        </div>
                                        <div className="col-span-2 bg-slate-800 p-5 rounded-2xl shadow-lg flex items-center justify-between text-white relative overflow-hidden">
                                            <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-500 rounded-full blur-3xl opacity-20 -mr-10 -mt-10"></div>
                                            <div className="flex items-center gap-4 relative z-10">
                                                <div className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center backdrop-blur-sm border border-white/10"><SafeIcon name="calendar-days" className="w-5 h-5 text-indigo-300" /></div>
                                                <div>
                                                    <div className="text-[10px] font-bold opacity-60 uppercase tracking-wider">Fecha de registro</div>
                                                    <div className="font-bold text-base text-white">{formatDate(userData.fechaRegistro)}</div>
                                                </div>
                                            </div>
                                            <SafeIcon name="award" className="w-12 h-12 text-yellow-400 opacity-20 relative z-10" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };



                                    // ==========================================
        // COMPONENTE PRINCIPAL (MainApp) - ACTUALIZADO
        // ==========================================
        const MainApp = () => {
            const [view, setView] = useState('login'); 
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isCheckingAuth, setIsCheckingAuth] = useState(true);
            const [userData, setUserData] = useState({ saldo: 0 }); 

            useEffect(() => { 
                if(window.lucide) window.lucide.createIcons(); 
                
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    if (user && user.emailVerified) {
                        setView('store');
                        
                        db.collection('usuarios').doc(user.uid).onSnapshot(doc => {
                            if (doc.exists) setUserData(doc.data());
                            else db.collection('usuarios').doc(user.uid).set({ email: user.email, saldo: 0 }, { merge: true });
                        });

                    } else {
                        setView('login');
                    }
                    setIsCheckingAuth(false);
                });
                
                return () => unsubscribe();
            }, []);

            const renderView = () => {
                switch(view) {
                    case 'login': return <LoginScreen onLogin={() => setView('store')} />;
                    case 'store': return <StoreFront userData={userData} onSelectService={() => setView('editor')} onSelectCovid={() => setView('covid')} onOpenMenu={() => setIsMenuOpen(true)} onGoToHistory={() => setView('history')} />;
                    case 'editor': return <RecetaEditor onBack={() => setView('store')} />;
                    case 'covid': return <CovidEditor onBack={() => setView('store')} />;
                    case 'recharge': return <RechargeFlow onBack={() => setView('store')} />;
                    case 'admin': return <AdminPanel onBack={() => setView('store')} />;
                    // NUEVA RUTA: HISTORIAL
                    case 'history': return <PurchaseHistory onBack={() => setView('store')} />;
                                        case 'profile': return <UserProfile onBack={() => setView('store')} />;

                    default: return <LoginScreen onLogin={() => setView('store')} />;
                }
            };

            if (isCheckingAuth) {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center">
                        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
                    </div>
                );
            }

            return (
                <div className="antialiased text-slate-900">
                    {view !== 'login' && view !== 'covid' && view !== 'editor' && (
                        <SidebarMenu 
                            isOpen={isMenuOpen} 
                            onClose={() => setIsMenuOpen(false)} 
                            onNavigate={(v) => { setIsMenuOpen(false); setView(v); }}
                            userBalance={userData?.saldo || 0}
                            userData={userData} // <-- AQU√ç PASAMOS LA INFORMACI√ìN DEL USUARIO
                        />
                    )}
                    {renderView()}
                </div>
            );
        };


        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
