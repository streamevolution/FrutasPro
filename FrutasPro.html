<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Servicios Digitales</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Arimo:wght@400;700&family=Inter:wght@300;400;500;600;800&family=Tinos:wght@700&family=Orbitron:wght@700&display=swap');

        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        
        /* Efecto Neón */
        @keyframes neon-pulse {
            0%, 100% { text-shadow: 0 0 4px #3b82f6, 0 0 10px #3b82f6, 0 0 20px #2563eb; color: #ffffff; }
            50% { text-shadow: 0 0 2px #60a5fa, 0 0 5px #3b82f6; color: #dbeafe; opacity: 0.8; }
        }
        .neon-text-blue { animation: neon-pulse 1.5s infinite alternate; font-family: 'Inter', sans-serif; font-weight: 600; }

        /* Estilos específicos de la Receta */
        .barcode { height: 58px; width: 220px; margin: 0 auto; background: linear-gradient(90deg, #000 1px, transparent 1px, transparent 2px, #000 2px, #000 4px, transparent 4px, transparent 5px, #000 5px, #000 6px, transparent 6px, transparent 8px, #000 8px, #000 11px, transparent 11px, transparent 12px, #000 12px, #000 13px, transparent 13px, transparent 15px, #000 15px, #000 17px, transparent 17px, transparent 19px, #000 19px, #000 20px, transparent 20px, transparent 21px, #000 21px, #000 24px, transparent 24px, transparent 26px, #000 26px, #000 27px, transparent 27px, transparent 29px, #000 29px, #000 31px, transparent 31px, transparent 33px, #000 33px, #000 36px, transparent 36px, transparent 38px, #000 38px, #000 39px, transparent 39px, transparent 40px, #000 40px, #000 43px, transparent 43px, transparent 44px, #000 44px, #000 45px, transparent 45px, transparent 47px, #000 47px, #000 50px, transparent 50px, transparent 51px, #000 51px, #000 53px, transparent 53px, transparent 55px, #000 55px, #000 58px, transparent 58px, transparent 60px, #000 60px, #000 61px, transparent 61px, transparent 63px, #000 63px, #000 65px, transparent 65px, transparent 67px, #000 67px, #000 70px, transparent 70px, transparent 72px, #000 72px, #000 74px, transparent 74px, transparent 76px, #000 76px, #000 77px, transparent 79px, #000 79px, #000 82px, transparent 82px, transparent 83px, #000 83px, #000 84px, transparent 84px, transparent 86px, #000 86px, #000 88px, transparent 88px, transparent 90px, #000 90px, #000 93px, transparent 93px, transparent 94px); background-size: 94px 100%; }
        .pt-box { padding: 2px 4px; line-height: 1.1; font-size: 9px; width: 100%; }
        .double-box { border: 4px double #000; background: white; }
        .pt-label { font-weight: 900; font-size: 9px; margin-right: 3px; }
        .pt-val { font-weight: 700; font-size: 10px; }
        .doctor-stamp-base { padding: 4px 6px; display: flex; align-items: center; gap: 6px; font-family: 'Arial Black', sans-serif; font-weight: 900; text-transform: uppercase; line-height: 1.1; font-size: 9px; max-width: 260px; mix-blend-mode: multiply; pointer-events: none; }
        .stamp-logo { height: 35px; width: auto; filter: grayscale(100%) sepia(100%) hue-rotate(190deg) saturate(1000%) brightness(40%) contrast(120%); }
        .svg-filters { position: absolute; width: 0; height: 0; overflow: hidden; }

        @media print {
            @page { margin: 0; size: auto; }
            html, body { height: 100%; overflow: hidden; background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-area { position: fixed; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 0.5cm !important; display: block; background: white !important; z-index: 9999; }
            .paper { box-shadow: none !important; margin: 0 auto !important; border: none !important; max-height: 100vh; }
        }
    </style>
</head>
<body>
    <svg class="svg-filters" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <filter id="stamp-texture-1"><feTurbulence type="fractalNoise" baseFrequency="0.5" numOctaves="1" result="noise" /><feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.3 0.7" in="noise" result="alphaNoise" /><feComposite operator="in" in="SourceGraphic" in2="alphaNoise" /></filter>
            <filter id="stamp-texture-2"><feTurbulence type="turbulence" baseFrequency="0.05" numOctaves="2" result="turbulence" /><feDisplacementMap in2="turbulence" in="SourceGraphic" scale="2" xChannelSelector="R" yChannelSelector="G" result="displaced"/><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" result="noise" /><feColorMatrix type="matrix" values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0.6 0.4" in="noise" result="alphaNoise" /><feComposite operator="in" in="displaced" in2="alphaNoise" /></filter>
            <filter id="stamp-texture-3"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="1" result="noise" /><feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.15 0.85" in="noise" result="alphaNoise" /><feComposite operator="in" in="SourceGraphic" in2="alphaNoise" /></filter>
            <filter id="stamp-texture-4"><feTurbulence type="fractalNoise" baseFrequency="0.4" numOctaves="4" result="noise" /><feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.8 -0.2" in="noise" result="alphaNoise" /><feComposite operator="in" in="SourceGraphic" in2="alphaNoise" /></filter>
        </defs>
    </svg>

    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // CONFIGURACION FIREBASE
        // ==========================================
        const firebaseConfig = {
            // !IMPORTANTE: REEMPLAZA ESTOS DATOS CON LOS DE TU CONSOLA DE FIREBASE
            apiKey: "AIzaSyAZOHuy67nnmQ36cnbMbDq8kG29CuqNMI4",
            authDomain: "frutas-pro.firebaseapp.com",
            projectId: "frutas-pro",
            storageBucket: "frutas-pro.firebasestorage.app",
            messagingSenderId: "330784421331",
            appId: "1:330784421331:web:9022cbf8d5e3c3d7da2b26"
        };

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        // Usamos Auth en lugar de solo Firestore para el login
        const auth = firebase.auth();
        const db = firebase.firestore();

        const { useState, useEffect } = React;

        // --- DATOS GLOBALES ---
        const SELLOS_DATA = [
            { id: 1, label: 'Sello 1 (Azul Original)', nombre: 'VALENTIN MOLINA DOMINGUEZ', tipo: 'MÉD. GENERAL', cedula: '12752209', matricula: '96150053', uni: 'Universidad Nacional Autónoma de México (UNAM)', style: { borderColor: '#003366', color: '#003366', borderStyle: 'solid', borderWidth: '3px', transform: 'rotate(-12deg)', opacity: 0.95, filter: 'url(#stamp-texture-1)' }, position: { top: '-5px', left: '40px' } },
            { id: 2, label: 'Sello 2 (Negro, Centrado)', nombre: 'MARIANA E. GUERRA PAZ', tipo: 'MÉD. FAMILIAR', cedula: '89201145', matricula: '99124401', uni: 'Instituto Politécnico Nacional (IPN)', style: { borderColor: '#1a1a1a', color: '#1a1a1a', borderStyle: 'solid', borderWidth: '3px', transform: 'rotate(2deg)', opacity: 0.9, filter: 'url(#stamp-texture-2)' }, position: { top: '15px', left: '180px' } },
            { id: 3, label: 'Sello 3 (Rojo, Inclinado)', nombre: 'ROBERTO CARLOS MENDEZ L.', tipo: 'MED. INTERNO', cedula: '55601923', matricula: '97003312', uni: 'Universidad Autónoma Metropolitana (UAM)', style: { borderColor: '#8b0000', color: '#8b0000', borderStyle: 'double', borderWidth: '4px', transform: 'rotate(-25deg)', opacity: 0.85, filter: 'url(#stamp-texture-3)' }, position: { top: '-15px', left: '10px' } },
            { id: 4, label: 'Sello 4 (Morado, Borde Punteado)', nombre: 'LAURA SOFIA VILLA REAL', tipo: 'MÉD. GENERAL', cedula: '10928374', matricula: '94551122', uni: 'Universidad de Guadalajara (UDG)', style: { borderColor: '#4a0e78', color: '#4a0e78', borderStyle: 'dashed', borderWidth: '2px', transform: 'rotate(8deg)', opacity: 0.92, filter: 'url(#stamp-texture-4)' }, position: { top: '25px', left: '60px' } },
            { id: 5, label: 'Sello 5 (Verde, Desgastado)', nombre: 'HECTOR SALINAS CRUZ', tipo: 'CIRUJANO', cedula: '67123900', matricula: '98334455', uni: 'Benemérita Universidad Autónoma de Puebla (BUAP)', style: { borderColor: '#005221', color: '#005221', borderStyle: 'solid', borderWidth: '3px', transform: 'rotate(-5deg)', opacity: 0.8, filter: 'url(#stamp-texture-2)' }, position: { top: '5px', left: '120px' } }
        ];

                               // ==========================================
        // COMPONENTE: PANTALLA DE LOGIN Y REGISTRO (V7 - SIN BOTÓN DESCARGA)
        // ==========================================
        const LoginScreen = ({ onLogin }) => {
            // Estados Básicos
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isRegistering, setIsRegistering] = useState(false);

            // Estados Extra (Registro)
            const [nombre, setNombre] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [telefono, setTelefono] = useState('');
            const [direccion, setDireccion] = useState('');
            const [genero, setGenero] = useState('Masculino'); 

            // Carga segura de iconos (Anti-Pantalla Blanca)
            useEffect(() => {
                const timer = setTimeout(() => {
                    try {
                        if(window.lucide) window.lucide.createIcons();
                    } catch(e) { console.warn("Icon error ignorado", e); }
                }, 100);
                return () => clearTimeout(timer);
            }, [isRegistering]); 

            const handleAuth = async (e) => {
                e.preventDefault();
                setIsLoading(true);

                try {
                    if (isRegistering) {
                        // --- VALIDACIONES ---
                        if (password !== confirmPassword) {
                            alert("❌ Las contraseñas no coinciden.");
                            setIsLoading(false);
                            return;
                        }
                        if (!nombre.trim() || !telefono.trim() || !direccion.trim()) {
                            alert("⚠️ Por favor completa todos los campos.");
                            setIsLoading(false);
                            return;
                        }

                        // 1. Crear usuario
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        
                        // 2. Guardar en Firestore
                        await db.collection('usuarios').doc(user.uid).set({
                            email: email,
                            nombre: nombre.toUpperCase(),
                            telefono: telefono,
                            direccion: direccion.toUpperCase(),
                            genero: genero,
                            fechaRegistro: new Date(),
                            saldo: 0
                        });
                        
                        // 3. Verificar
                        await user.sendEmailVerification();
                        alert("¡Cuenta creada con éxito! ✅\n\nSe ha enviado un correo de verificación a " + email);
                        
                        // 4. Recarga segura
                        window.location.reload();

                    } else {
                        // --- LOGIN ---
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        const user = userCredential.user;

                        if (user.emailVerified) {
                            onLogin();
                        } else {
                            await auth.signOut();
                            alert("⚠️ Tu correo no ha sido verificado. Revisa tu bandeja de entrada.");
                        }
                    }

                } catch (error) {
                    console.error("Error Auth:", error);
                    let msg = "Error al procesar.";
                    if (error.code === 'auth/email-already-in-use') msg = "El correo ya está registrado.";
                    if (error.code === 'auth/wrong-password') msg = "Contraseña incorrecta.";
                    if (error.code === 'auth/user-not-found') msg = "Cuenta no encontrada.";
                    if (error.code === 'auth/weak-password') msg = "La contraseña es muy débil.";
                    alert(msg);
                } finally {
                    setIsLoading(false);
                }
            };

            const toggleMode = () => {
                setIsRegistering(!isRegistering);
                setEmail(''); setPassword(''); setConfirmPassword('');
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900 p-4 font-sans">
                    <div key={isRegistering ? 'register-mode' : 'login-mode'} className={`w-full ${isRegistering ? 'max-w-2xl' : 'max-w-md'} bg-white rounded-2xl shadow-2xl p-8 transition-all duration-500`}>
                        
                        <div className="text-center mb-6">
                            <div className="inline-flex items-center justify-center w-12 h-12 rounded-lg bg-indigo-600 text-white mb-4 shadow-lg shadow-indigo-200">
                                <i data-lucide={isRegistering ? "user-plus" : "lock"} className="w-6 h-6"></i>
                            </div>
                            <h2 className="text-2xl font-black text-slate-800 uppercase tracking-tight">
                                {isRegistering ? "Crear Cuenta" : "Iniciar Sesión"}
                            </h2>
                            <p className="text-slate-500 text-sm font-bold">
                                {isRegistering ? "Completa el formulario" : "Bienvenido al Panel de Administración"}
                            </p>
                        </div>

                        <form onSubmit={handleAuth} className="space-y-4">
                            
                            {/* --- CAMPOS EXCLUSIVOS DE REGISTRO --- */}
                            {isRegistering && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-[fadeIn_0.3s_ease-out]">
                                    <div className="md:col-span-2">
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre Completo</label>
                                        <div className="relative">
                                            <input type="text" required value={nombre} onChange={e => setNombre(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-bold text-slate-700" placeholder="Ej. Juan Pérez" />
                                            <i data-lucide="user" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Teléfono</label>
                                        <div className="relative">
                                            <input type="tel" required value={telefono} onChange={e => setTelefono(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium" placeholder="55 1234 5678" />
                                            <i data-lucide="phone" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Género</label>
                                        <div className="relative">
                                            <select value={genero} onChange={e => setGenero(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium appearance-none cursor-pointer">
                                                <option value="Masculino">Masculino</option>
                                                <option value="Femenino">Femenino</option>
                                                <option value="No Binario">No Binario</option>
                                            </select>
                                            <i data-lucide="users" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                            <i data-lucide="chevron-down" className="absolute right-3 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                                        </div>
                                    </div>

                                    <div className="md:col-span-2">
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Dirección (Ciudad, Estado)</label>
                                        <div className="relative">
                                            <input type="text" required value={direccion} onChange={e => setDireccion(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium" placeholder="Ej. Toluca, Estado de México" />
                                            <i data-lucide="map-pin" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* --- CAMPOS COMUNES --- */}
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Correo Electrónico</label>
                                <div className="relative">
                                    <input type="email" required value={email} onChange={(e) => setEmail(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium" placeholder="nombre@correo.com" />
                                    <i data-lucide="mail" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className={isRegistering ? "" : "md:col-span-2"}>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Contraseña</label>
                                    <div className="relative">
                                        <input type="password" required value={password} onChange={(e) => setPassword(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition" placeholder="••••••••" />
                                        <i data-lucide="lock" className="absolute left-3 top-3.5 w-5 h-5 text-slate-400"></i>
                                    </div>
                                </div>

                                {isRegistering && (
                                    <div className="animate-[fadeIn_0.3s_ease-out]">
                                        <label className="block text-xs font-bold text-indigo-600 uppercase mb-1">Confirmar Contraseña</label>
                                        <div className="relative">
                                            <input type="password" required value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className={`w-full pl-10 pr-4 py-3 rounded-xl bg-indigo-50 border ${password && confirmPassword && password !== confirmPassword ? 'border-rose-400 focus:border-rose-500' : 'border-indigo-200 focus:border-indigo-500'} focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium`} placeholder="••••••••" />
                                            <i data-lucide="check-circle" className="absolute left-3 top-3.5 w-5 h-5 text-indigo-400"></i>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* Boton Principal */}
                            <button type="submit" disabled={isLoading} className={`w-full text-white font-bold py-4 rounded-xl transition-all duration-300 shadow-xl shadow-slate-200 disabled:opacity-50 disabled:cursor-not-allowed mt-4 flex items-center justify-center gap-2 ${isRegistering ? 'bg-gradient-to-r from-slate-800 to-slate-900 hover:scale-[1.01]' : 'bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-200'}`}>
                                {isLoading ? (
                                    <><div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> Procesando...</>
                                ) : (
                                    isRegistering ? 'CREAR CUENTA' : 'INGRESAR AL SISTEMA'
                                )}
                            </button>
                        </form>

                        {/* Toggle Login/Registro */}
                        <div className="mt-6 flex flex-col gap-3 text-center text-sm border-t border-slate-100 pt-6">
                            <button 
                                type="button"
                                onClick={toggleMode} 
                                className="text-slate-600 font-bold hover:text-indigo-600 transition flex items-center justify-center gap-2 mx-auto px-4 py-2 rounded-lg hover:bg-slate-50"
                            >
                                {isRegistering ? <><i data-lucide="arrow-left" className="w-4 h-4"></i> Volver al Login</> : "No tienes cuenta? Crear Cuenta"}
                            </button>
                            
                            {!isRegistering && (
                                <button onClick={() => {
                                    const resetEmail = prompt("Ingresa tu correo para recuperar contraseña:");
                                    if(resetEmail) {
                                        auth.sendPasswordResetEmail(resetEmail)
                                            .then(() => alert("Correo de recuperación enviado."))
                                            .catch(e => alert("Error: " + e.message));
                                    }
                                }} className="text-slate-400 hover:text-slate-600 text-xs">
                                    Olvidé mi contraseña
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };



                               // ==========================================
        // COMPONENTE: RECHARGE FLOW (ACTUALIZADO - HORARIOS Y ADVERTENCIA DINERO)
        // ==========================================
        const RechargeFlow = ({ onBack }) => {
            const [step, setStep] = useState(1);
            const [accepted, setAccepted] = useState(false);
            const [showError, setShowError] = useState(false);
            const [concept, setConcept] = useState('');
            const [timeLeft, setTimeLeft] = useState(15 * 60);
            const [toast, setToast] = useState(null);
            const [isSending, setIsSending] = useState(false); 

            useEffect(() => {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let result = '';
                for (let i = 0; i < 8; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                setConcept(result);
            }, []);

            useEffect(() => {
                if (step === 2 && timeLeft > 0) {
                    const timer = setInterval(() => setTimeLeft(p => p - 1), 1000);
                    return () => clearInterval(timer);
                }
            }, [step, timeLeft]);

            useEffect(() => { if(window.lucide) window.lucide.createIcons(); }, [step]);

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            };

            const handleContinue = () => {
                if (!accepted) {
                    setShowError(true);
                    setTimeout(() => setShowError(false), 2000);
                    return;
                }
                setStep(2);
            };

            const handleFinalize = async () => {
                setIsSending(true);
                try {
                    const user = auth.currentUser;
                    await db.collection('recargas').add({
                        userId: user.uid,
                        userEmail: user.email,
                        monto: 200, 
                        concept: concept,
                        fecha: new Date(),
                        status: 'pendiente'
                    });
                    
                    alert("¡Solicitud enviada! Tu saldo se reflejará cuando el sistema procese la transacción.");
                    onBack();
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error al enviar solicitud: " + error.message);
                } finally {
                    setIsSending(false);
                }
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    setToast("Copiado al portapapeles");
                    setTimeout(() => setToast(null), 2000);
                }).catch(err => {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("Copy");
                    textArea.remove();
                    setToast("Copiado");
                    setTimeout(() => setToast(null), 2000);
                });
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans relative overflow-hidden">
                    <button onClick={onBack} className="absolute top-4 left-4 text-white/70 hover:text-white flex items-center gap-2 z-10">
                        <i data-lucide="arrow-left" className="w-5 h-5"></i> Cancelar
                    </button>

                    {toast && (
                        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[100] bg-black/90 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 backdrop-blur-sm border border-white/10">
                            <i data-lucide="check-circle" className="w-5 h-5 text-emerald-400"></i>
                            <span className="font-semibold text-sm">{toast}</span>
                        </div>
                    )}

                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                        <div className="absolute top-[-10%] right-[-10%] w-96 h-96 bg-blue-600/20 rounded-full blur-3xl"></div>
                        <div className="absolute bottom-[-10%] left-[-10%] w-96 h-96 bg-indigo-600/20 rounded-full blur-3xl"></div>
                    </div>

                    {step === 1 && (
                        <div className="w-full max-w-lg bg-slate-800/80 backdrop-blur-md border border-slate-700 rounded-2xl shadow-2xl p-6 relative z-20">
                            <div className="mb-6 text-center">
                                <div className="bg-blue-500/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/30">
                                    <i data-lucide="alert-triangle" className="w-8 h-8 text-blue-400"></i>
                                </div>
                                <h2 className="text-2xl font-bold text-white mb-2">Advertencia de Recarga</h2>
                            </div>

                            <div className="bg-slate-900/50 p-6 rounded-xl border border-blue-900/50 mb-6 shadow-inner">
                                {/* TEXTO ACTUALIZADO CON TUS REQUERIMIENTOS */}
                                <div className="neon-text-blue text-xs md:text-sm text-left space-y-3">
                                    <p className="text-center font-bold mb-3 uppercase tracking-wider border-b border-blue-800/50 pb-2">Instrucciones Importantes</p>
                                    <ul className="space-y-3 list-none">
                                        <li className="flex items-start gap-2"><span className="mt-0.5 text-blue-300">➤</span><span><strong>Recarga Mínima:</strong> $200 MXN.</span></li>
                                        <li className="flex items-start gap-2"><span className="mt-0.5 text-blue-300">➤</span><span><strong>Método:</strong> Solo Transferencias.</span></li>
                                        
                                        {/* NUEVO PUNTO: HORARIO */}
                                        <li className="flex items-start gap-2">
                                            <span className="mt-0.5 text-blue-300">➤</span>
                                            <span><strong>Horario Automático:</strong> De 08:00 AM a 11:00 PM. Si recargas fuera de horario, el saldo llega al día siguiente automáticamente.</span>
                                        </li>

                                        {/* PUNTO EDITADO: CONCEPTO Y ADVERTENCIA DE DINERO */}
                                        <li className="flex items-start gap-2">
                                            <span className="mt-0.5 text-blue-300">➤</span>
                                            <span><strong>Concepto:</strong> Coloca la referencia EXACTA o <span className="text-rose-400 font-bold underline decoration-rose-500/50">PIERDES TU DINERO</span>.</span>
                                        </li>
                                        
                                        <li className="flex items-start gap-2"><span className="mt-0.5 text-blue-300">➤</span><span><strong>Tiempo:</strong> Límite de 15 min para pagar.</span></li>
                                    </ul>
                                </div>
                            </div>

                            <div className="space-y-6">
                                <label className="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700/50 transition cursor-pointer group">
                                    <div className="relative">
                                        <input type="checkbox" className="peer sr-only" checked={accepted} onChange={(e) => setAccepted(e.target.checked)} />
                                        <div className="w-6 h-6 border-2 border-slate-500 rounded peer-checked:bg-blue-500 peer-checked:border-blue-500 transition-all"></div>
                                        <i data-lucide="check" className="absolute top-0.5 left-0.5 w-4 h-4 text-white opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                                    </div>
                                    <span className="text-slate-300 font-medium select-none group-hover:text-white transition">He leído y acepto los términos</span>
                                </label>

                                {showError && (
                                    <div className="text-rose-500 text-xs font-bold text-center animate-bounce bg-rose-500/10 p-2 rounded">
                                        ⚠ Debes aceptar los términos
                                    </div>
                                )}

                                <button onClick={handleContinue} className={`w-full py-4 rounded-xl font-bold text-lg tracking-wide transition-all duration-200 transform shadow-lg ${accepted ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:scale-[1.02]' : 'bg-slate-700 text-slate-400 cursor-not-allowed'}`}>
                                    RECARGAR AHORA
                                </button>
                            </div>
                        </div>
                    )}

                    {step === 2 && (
                        <div className="w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden relative z-20 animate-[fadeIn_0.3s_ease-out]">
                             <div className="bg-slate-900 p-5 text-center relative">
                                <h3 className="text-white font-bold text-lg">Datos de Transferencia</h3>
                                <p className="text-slate-400 text-xs mt-1">Realiza tu pago antes de que termine el tiempo</p>
                                <div className="mt-4 bg-slate-800 rounded-lg py-2 border border-slate-700 flex items-center justify-center gap-2">
                                    <i data-lucide="timer" className="w-4 h-4 text-red-500 animate-pulse"></i>
                                    <span className="text-xl font-mono font-bold text-white tracking-widest">{formatTime(timeLeft)}</span>
                                </div>
                             </div>

                             <div className="p-6 space-y-5">
                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                    <p className="text-[10px] text-indigo-500 font-bold uppercase mb-1">Concepto (Copiar)</p>
                                    <div className="flex justify-between items-center">
                                        <span className="text-2xl font-black text-indigo-900 tracking-wider break-all">{concept}</span>
                                        <button onClick={() => copyToClipboard(concept)} className="bg-white p-2 rounded-lg shadow-sm border border-indigo-100 text-indigo-600 hover:bg-indigo-50 flex-shrink-0 ml-2 group relative">
                                            <i data-lucide="copy" className="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    <div className="text-[9px] text-rose-500 font-bold mt-2 text-center bg-rose-50 p-1 rounded border border-rose-100">
                                        ⚠ ¡USA ESTE CONCEPTO EXACTO O PIERDES TU DINERO!
                                    </div>
                                </div>

                                <div className="space-y-4 text-sm">
                                    <div className="flex justify-between border-b border-slate-100 pb-2 items-center">
                                        <span className="text-slate-500">Banco</span>
                                        <span className="font-bold text-slate-800">STP</span>
                                    </div>
                                    <div className="flex justify-between border-b border-slate-100 pb-2 items-center">
                                        <span className="text-slate-500">Beneficiario</span>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-slate-800">AXLL</span>
                                            <button onClick={() => copyToClipboard('AXLL')} className="text-slate-400 hover:text-indigo-600"><i data-lucide="copy" className="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                    <div className="flex justify-between border-b border-slate-100 pb-2 items-center">
                                        <span className="text-slate-500">CLABE</span>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-slate-800 text-sm">646180402324335362</span>
                                            <button onClick={() => copyToClipboard('646180402324335362')} className="text-slate-400 hover:text-indigo-600"><i data-lucide="copy" className="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center pt-2">
                                        <span className="text-slate-500 font-medium">Monto</span>
                                        <span className="font-black text-2xl text-emerald-600">$200.00</span>
                                    </div>
                                </div>

                                <button onClick={handleFinalize} disabled={isSending} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg shadow-slate-200 mt-2 disabled:opacity-50">
                                    {isSending ? 'Enviando Solicitud...' : 'Ya realicé la transferencia'}
                                </button>
                             </div>
                        </div>
                    )}
                </div>
            );
        };


                                 // ==========================================
        // COMPONENTE: MENU LATERAL (CON NOMBRE DE USUARIO)
        // ==========================================
        const SidebarMenu = ({ isOpen, onClose, onNavigate, userBalance, userData }) => { 
            const user = firebase.auth().currentUser;
            const isAdmin = user && user.email === 'mrandroidtutorialeshd@gmail.com';

            useEffect(() => {
                if (isOpen && window.lucide) window.lucide.createIcons();
            }, [isOpen]);

            return (
                <>
                    <div 
                        className={`fixed inset-0 bg-slate-900/60 z-[60] transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                        onClick={onClose}
                    ></div>

                    <div className={`fixed top-0 left-0 h-full w-72 bg-white z-[70] shadow-2xl transform transition-transform duration-300 ease-out flex flex-col ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-slate-100 bg-slate-50">
                            <div className="flex justify-between items-start mb-4">
                                <div className="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 border border-indigo-200">
                                    <i data-lucide="user" className="w-6 h-6"></i>
                                </div>
                                <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full transition">
                                    <i data-lucide="x" className="w-5 h-5 text-slate-400"></i>
                                </button>
                            </div>
                            {/* Mostramos el nombre guardado o 'USUARIO' si no hay nada */}
                            <h3 className="font-bold text-slate-800 text-lg uppercase break-words leading-tight">
                                {userData?.nombre ? userData.nombre : 'USUARIO'}
                            </h3>
                            <p className="text-xs text-slate-500 break-words mt-1">{user ? user.email : 'Invitado'}</p>
                        </div>

                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                            <button onClick={() => { onClose(); onNavigate('profile'); }} className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl transition-all group font-medium">
                                <i data-lucide="user-circle" className="w-5 h-5 text-slate-400 group-hover:text-indigo-500"></i> Perfil
                            </button>
                            
                            <button onClick={() => { onClose(); onNavigate('store'); }} className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl transition-all group font-medium">
                                <i data-lucide="layout-grid" className="w-5 h-5 text-slate-400 group-hover:text-indigo-500"></i> Servicios
                            </button>

                            {isAdmin && (
                                <button onClick={() => { onClose(); onNavigate('admin'); }} className="w-full flex items-center gap-3 px-4 py-3 text-indigo-700 bg-indigo-50 hover:bg-indigo-100 rounded-xl transition-all group font-bold border border-indigo-100">
                                    <i data-lucide="shield" className="w-5 h-5 text-indigo-500"></i> Panel Admin
                                </button>
                            )}

                            <button onClick={() => { onClose(); onNavigate('recharge'); }} className="w-full flex items-center justify-between px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl transition-all group font-medium">
                                <div className="flex items-center gap-3">
                                    <i data-lucide="wallet" className="w-5 h-5 text-slate-400 group-hover:text-indigo-500"></i> Agregar Saldo
                                </div>
                                <span className="text-xs font-bold bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full">
                                    ${userBalance ? userBalance.toFixed(2) : '0.00'}
                                </span>
                            </button>
                            
                            {/* BOTÓN HISTORIAL ACTUALIZADO */}
                            <button onClick={() => { onClose(); onNavigate('history'); }} className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl transition-all group font-medium">
                                <i data-lucide="history" className="w-5 h-5 text-slate-400 group-hover:text-indigo-500"></i> Mi Historial
                            </button>
                            
                            <button onClick={() => alert("Contactar Soporte")} className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl transition-all group font-medium">
                                <i data-lucide="headphones" className="w-5 h-5 text-slate-400 group-hover:text-indigo-500"></i> Soporte
                            </button>
                        </nav>

                        <div className="p-4 border-t border-slate-100">
                            {/* --- BOTÓN DESCARGAR APP CON ICONO ANDROID SVG --- */}
                            <a 
                                href="https://www.mediafire.com/file/dumddjmhpfqobqb/FrutasPro-Master.apk/file" 
                                target="_blank"
                                rel="noopener noreferrer"
                                className="w-full flex items-center gap-3 px-4 py-3 text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all group font-bold mb-1"
                            >
                                {/* SVG del Robot de Android en color verde esmeralda */}
                                <svg viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5 text-emerald-500 group-hover:text-emerald-600 transition-colors">
                                    <path d="M17.523 15.3414c0 1.3704-1.1164 2.4813-2.4936 2.4813-1.3771 0-2.4935-1.1109-2.4935-2.4813 0-1.3704 1.1164-2.4813 2.4935-2.4813 1.3772 0 2.4936 1.1109 2.4936 2.4813zM6.4764 15.3414c0 1.3704-1.1164 2.4813-2.4935 2.4813-1.3772 0-2.4936-1.1109-2.4936-2.4813 0-1.3704 1.1164-2.4813 2.4936-2.4813 1.3771 0 2.4935 1.1109 2.4935 2.4813zM18.7891 7.2922l2.3967-4.137c.088-.1519.0384-.348-.1107-.4364-.1492-.0883-.3416-.0386-.4302.112l-2.4346 4.2023c-1.8953-.8701-4.0435-1.3537-6.3146-1.3537-2.1648 0-4.2208.4395-6.0594 1.2393l-2.3551-4.086c-.088-.152-.2807-.202-.4305-.1136-.1498.0883-.1996.2842-.1113.4367l2.3164 4.019C2.4795 9.4796.5333 13.065.5333 17.152h22.9333c0-4.2185-2.0717-7.8963-4.6775-9.8598z" />
                                </svg>
                                Descargar Aplicación
                            </a>

                             <button onClick={() => { onClose(); auth.signOut(); }} className="w-full flex items-center gap-3 px-4 py-3 text-rose-600 hover:bg-rose-50 rounded-xl transition-all group font-bold">
                                <i data-lucide="log-out" className="w-5 h-5 text-rose-400 group-hover:text-rose-600"></i> Cerrar Sesion
                            </button>
                            <div className="text-center mt-4 text-[10px] text-slate-300">Power Revolution Team©</div>
                        </div>
                    </div>
                </>
            );
        };
        
        // Render del Input
            const RInput = ({ label, val, onChange, placeholder, w }) => (
                <div className={w || "w-full"}>
                    <label className="block text-[10px] font-black text-slate-500 uppercase mb-1 ml-1">{label}</label>
                    <input type="text" className="w-full bg-white border border-slate-300 rounded-xl p-2.5 text-xs focus:outline-none focus:border-indigo-500 font-bold text-slate-700 uppercase" placeholder={placeholder} value={val} onChange={e => onChange(e.target.value)} />
                </div>
            );

                                                                                                        // ==========================================
        // COMPONENTE: TIENDA VIRTUAL (DATOS PACIENTE VACÍOS + MÉDICO OCULTO)
        // ==========================================
        const StoreFront = ({ onSelectService, onOpenMenu, onSelectCovid, userData, onGoToHistory }) => {
            const [searchTerm, setSearchTerm] = useState("");
            const [services, setServices] = useState([]);
            const [anuncios, setAnuncios] = useState([]); 
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState('TODOS');

            // --- ESTADOS PEDIDO ---
            const [selectedService, setSelectedService] = useState(null);
            const [isOrderOpen, setIsOrderOpen] = useState(false);
            const [formData, setFormData] = useState({});
            const [isSendingOrder, setIsSendingOrder] = useState(false);
            const [isConfirmOpen, setIsConfirmOpen] = React.useState(false);

            // --- BANDERAS ---
            const [isFarmacia, setIsFarmacia] = useState(false);
            const [isImss, setIsImss] = useState(false);
            const [isCovid, setIsCovid] = useState(false);

            // --- DATA GENERATORS (DOCTORES) ---
            const DOCTORES_DATA = React.useMemo(() => {
                const nombresHombres = [
                    "JUAN CARLOS PÉREZ GÓMEZ", "LUIS ANTONIO GARCÍA MARTÍNEZ", "MIGUEL ÁNGEL RODRÍGUEZ LÓPEZ", "JOSÉ LUIS HERNÁNDEZ GONZÁLEZ", "CARLOS EDUARDO MARTÍNEZ SÁNCHEZ",
                    "JORGE ALBERTO SÁNCHEZ PÉREZ", "JESÚS MANUEL RAMÍREZ CRUZ", "FRANCISCO JAVIER FLORES GÓMEZ", "RAÚL ALEJANDRO TORRES VÁZQUEZ", "ROBERTO CARLOS RUIZ DÍAZ",
                    "DANIEL ALONSO MENDOZA GUTIÉRREZ", "EDUARDO JAVIER CASTRO ORTEGA", "SERGIO IVÁN VARGAS ROMERO", "ALEJANDRO DAVID MORALES JIMÉNEZ", "FERNANDO JOSÉ ORTIZ RUIZ",
                    "RICARDO ANDRÉS SILVA NAVARRO", "HÉCTOR MANUEL RAMOS CASTILLO", "GABRIEL OMAR MEDINA SALAZAR", "MARTÍN ELÍAS ROJAS AGUILAR", "PEDRO ANTONIO VEGA CÁRDENAS",
                    "MANUEL ALEJANDRO CAMPOS LUNA", "JAVIER EDUARDO CRUZ SALGADO", "ALBERTO JOSÉ REYES MARÍN", "DIEGO ARMANDO SOTO DOMÍNGUEZ", "ADRIÁN ARTURO PACHECO RIVERA",
                    "MARIO ALBERTO GUERRERO SERRANO", "JULIO CÉSAR VALENZUELA MEZA", "PABLO EMILIO CORTÉS IBARRA", "ÓSCAR IVÁN ESPINOZA ROSALES", "ANDRÉS FELIPE OROZCO BELTRÁN",
                    "RUBÉN DARÍO MONTES QUIROZ", "VÍCTOR HUGO CUEVAS GALLEGOS", "CÉSAR AUGUSTO PADILLA ZAMORA", "IVÁN LEONARDO SALAS VILLALOBOS", "HUGO ERNESTO RÍOS BARRERA",
                    "EDGAR ULISES MACÍAS ESCOBAR", "ARTURO ELÍAS ZÚÑIGA CORREA", "ALFREDO RAFAEL TOVAR VILLEGAS", "ENRIQUE ALONSO GALLARDO LARA", "FELIPE DE JESÚS NAVA PERALTA",
                    "GUSTAVO ADOLFO DELGADO CERVANTES", "IGNACIO MANUEL BERNAL OCHOA", "JOAQUÍN ANDRÉS SOLÍS ARROYO", "LEONARDO FABIÁN ACUÑA FIGUEROA", "MAURICIO ALEJANDRO CANO VALDEZ",
                    "NORBERTO ELÍAS TREJO MALDONADO", "ORLANDO JAVIER URBINA CORONA", "PATRICIO DANIEL VERA BUSTOS", "RODRIGO EMANUEL ZAVALA PINEDA", "SAÚL ERNESTO ALCARAZ MONTOYA"
                ];
                const nombresMujeres = [
                    "MARÍA FERNANDA LÓPEZ RUIZ", "ANA SOFÍA HERNÁNDEZ DÍAZ", "CARLA DANIELA GARCÍA PÉREZ", "ADRIANA MARÍA MARTÍNEZ SÁNCHEZ", "BEATRIZ ELENA GONZÁLEZ RODRÍGUEZ",
                    "CARMEN LUCÍA PÉREZ GÓMEZ", "DIANA CAROLINA RAMÍREZ CRUZ", "ELIZABETH VICTORIA FLORES TORRES", "FÁTIMA GUADALUPE TORRES VÁZQUEZ", "GABRIELA ALEJANDRA RUIZ MENDOZA",
                    "HILDA MARIANA CASTRO ORTEGA", "ISABEL CRISTINA VARGAS ROMERO", "JESSICA PAOLA MORALES JIMÉNEZ", "KARLA VANESSA ORTIZ SILVA", "LAURA PATRICIA RAMOS CASTILLO",
                    "MÓNICA LIZBETH MEDINA SALAZAR", "NATALIA SOFÍA ROJAS AGUILAR", "OLIVIA MARGARITA VEGA CÁRDENAS", "PAOLA ANDREA CAMPOS LUNA", "QUETZALLI YASMIN CRUZ SALGADO",
                    "REBECA ABIGAIL REYES MARÍN", "SANDRA LUZ SOTO DOMÍNGUEZ", "TERESA DE JESÚS PACHECO RIVERA", "URSULA MARIANA GUERRERO SERRANO", "VERÓNICA CECILIA VALENZUELA MEZA",
                    "WENDY NAYELI CORTÉS IBARRA", "XIMENA ALESSANDRA ESPINOZA ROSALES", "YOLANDA BEATRIZ OROZCO BELTRÁN", "ZULEMA KARINA MONTES QUIROZ", "ALMA DELIA CUEVAS GALLEGOS",
                    "BLANCA ESTELA PADILLA ZAMORA", "CLAUDIA IVETTE SALAS VILLALOBOS", "DANIELA MICHELLE RÍOS BARRERA", "ELENA SOFÍA MACÍAS ESCOBAR", "FABIOLA JANET ZÚÑIGA CORREA",
                    "GLORIA ESTEFANÍA TOVAR VILLEGAS", "HAYDEE MARISOL GALLARDO LARA", "IRENE GUADALUPE NAVA PERALTA", "JULIA MERCEDES DELGADO CERVANTES", "KAREN LIZETH BERNAL OCHOA",
                    "LETICIA MARIBEL SOLÍS ARROYO", "MARGARITA ROSA ACUÑA FIGUEROA", "NANCY GABRIELA CANO VALDEZ", "OFELIA ISABEL TREJO MALDONADO", "PATRICIA ELENA URBINA CORONA",
                    "ROCÍO ALEJANDRA VERA BUSTOS", "SILVIA FERNANDA ZAVALA PINEDA", "TANIA IVONNE ALCARAZ MONTOYA", "VALERIA JUDITH MEJÍA CORDERO", "YESSICA PAOLA LARA ZAMUDIO"
                ];
                const universidades = [
                    { uni: "UNIVERSIDAD NACIONAL AUTÓNOMA DE MÉXICO", dir: "AV. UNIVERSIDAD 3000, COPILCO EL ALTO\nCOYOACÁN, 04510 CIUDAD DE MÉXICO, CDMX" },
                    { uni: "INSTITUTO POLITÉCNICO NACIONAL", dir: "AV. WILFRIDO MASSIEU S/N, LINDAVISTA\nGUSTAVO A. MADERO, 07738 CIUDAD DE MÉXICO, CDMX" },
                    { uni: "BENEMÉRITA UNIVERSIDAD AUTÓNOMA DE PUEBLA", dir: "C. 16 DE SEPTIEMBRE 13323-LOCAL A, AMPLIACIÓN\nGUADALUPE HIDALGO, 72470 PUEBLA, PUE." },
                    { uni: "UNIVERSIDAD DE GUADALAJARA", dir: "AV. JUÁREZ 976, COL. CENTRO\nGUADALAJARA, 44100 GUADALAJARA, JAL." },
                    { uni: "UNIVERSIDAD AUTÓNOMA DE NUEVO LEÓN", dir: "AV. UNIVERSIDAD S/N, CIUDAD UNIVERSITARIA\nSAN NICOLÁS DE LOS GARZA, 66455 NUEVO LEÓN" },
                    { uni: "UNIVERSIDAD VERACRUZANA", dir: "LOMAS DEL ESTADIO S/N, ZONA UNIVERSITARIA\nXALAPA-ENRÍQUEZ, 91000 XALAPA, VER." },
                    { uni: "UNIVERSIDAD AUTÓNOMA DEL ESTADO DE MÉXICO", dir: "PASEO TOLLOCAN ESQ. JESÚS CARRANZA\nMODERNA DE LA CRUZ, 50180 TOLUCA, MÉX." },
                    { uni: "UNIVERSIDAD AUTÓNOMA DE QUERÉTARO", dir: "CERRO DE LAS CAMPANAS S/N, LAS CAMPANAS\nSANTIAGO DE QUERÉTARO, 76010 QUERÉTARO, QRO." },
                    { uni: "UNIVERSIDAD AUTÓNOMA DE YUCATÁN", dir: "CALLE 60 491-A, CENTRO\nMÉRIDA, 97000 MÉRIDA, YUC." },
                    { uni: "UNIVERSIDAD DE GUANAJUATO", dir: "LASCURÁIN DE RETANA 5, CENTRO\nGUANAJUATO, 36000 GUANAJUATO, GTO." }
                ];
                const especialidades = ["MÉDICO CIRUJANO", "MÉDICO CIRUJANO Y PARTERO", "MÉDICO GENERAL", "ESPECIALISTA EN MEDICINA FAMILIAR"];
                
                const generarDatos = (nombre, prefijo) => {
                    const uniObj = universidades[Math.floor(Math.random() * universidades.length)];
                    const cedula = Math.floor(1000000 + Math.random() * 9000000).toString();
                    return { nombre: `${prefijo} ${nombre}`, tipo: especialidades[Math.floor(Math.random() * especialidades.length)], cedula: cedula, uni: `${uniObj.uni}\n${uniObj.dir}` };
                };
                
                return [...nombresHombres.map(n => generarDatos(n, "DR.")), ...nombresMujeres.map(n => generarDatos(n, "DRA."))].sort(() => Math.random() - 0.5);
            }, []);

            // --- ESTADOS DE DATOS ---
            const [recipeData, setRecipeData] = useState({
                paciente: { nss: '', agregado: '', nombre: '', curp: '', sexo: 'MASCULINO', fechaNac: '', delegacion: '', ump: '', consultorio: '', cve: '', turno: 'MATUTINO' },
                meta: { folio: '', fecha: '', indicaciones: 'SE INDICA REPOSO ABSOLUTO POR 3 DÍAS.' },
                medico: { nombre: '', tipo: '', cedula: '', matricula: '', uni: '' },
                medicamentos: []
            });

            const [farmaciaData, setFarmaciaData] = useState({
                paciente: { nombre: '', edad: '', peso: '', talla: '', temp: '', fecha: '' },
                medico: { nombre: '', tipo: '', cedula: '', uni: '' },
                medicamentos: []
            });
            
            const [covidData, setCovidData] = useState({ curp: '', nombre: '', dosis1: {}, dosis2: {}, selloDigital: '', fechaEmision: '' });

            const user = firebase.auth().currentUser;
            const isAdmin = user && user.email === 'mrandroidtutorialeshd@gmail.com';

            const Icon = ({ name, className }) => {
                const iconRef = React.useRef(null);
                React.useEffect(() => {
                    if (iconRef.current && window.lucide) {
                        iconRef.current.innerHTML = `<i data-lucide="${name}" class="${className || ''}"></i>`;
                        window.lucide.createIcons({ root: iconRef.current });
                    }
                }, [name, className]);
                return <span ref={iconRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }} />;
            };

            useEffect(() => {
                const unsubscribeServices = db.collection('servicios').onSnapshot(snapshot => {
                    setServices(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                });
                const unsubscribeAnuncios = db.collection('anuncios').orderBy('fecha', 'desc').onSnapshot(snapshot => {
                    setAnuncios(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => { unsubscribeServices(); unsubscribeAnuncios(); };
            }, []);

            const filteredServices = services.filter(service => 
                (service.active !== false || isAdmin) &&
                (filter === 'TODOS' || service.category === filter) &&
                ((service.title || "").toLowerCase().includes(searchTerm.toLowerCase()) || 
                (service.category || "").toLowerCase().includes(searchTerm.toLowerCase()))
            );

            const groupedServices = filteredServices.reduce((groups, service) => {
                const category = service.category || 'OTROS';
                if (!groups[category]) groups[category] = [];
                groups[category].push(service);
                return groups;
            }, {});
            const sortedCategories = Object.keys(groupedServices).sort();

            // --- MANEJADOR DE CLICS ---
            const handleServiceClick = (service) => {
                const title = (service.title || "").toUpperCase();
                setIsFarmacia(false); setIsImss(false); setIsCovid(false); setFormData({});

                // 1. COVID
                if (title.includes("COVID") || title.includes("VACUNA")) { 
                    if (isAdmin) { onSelectCovid(); return; }
                    setIsCovid(true);
                    setCovidData({
                        curp: '', nombre: '',
                        dosis1: { fecha: '2021-05-12', marca: 'ASTRAZENECA', lote: 'I-592740' },
                        dosis2: { fecha: '2021-08-04', marca: 'ASTRAZENECA', lote: 'I-694376' },
                        selloDigital: '317feab6-5b4f-4fe4-a9b7-8e8dcff84934-C8812',
                        fechaEmision: new Date().toISOString().slice(0, 19).replace('T', ' ')
                    });
                    setSelectedService(service); setIsOrderOpen(true);
                    return; 
                }

                // 2. FARMACIA DEL AHORRO (RECARGADO)
                if (title.includes("FARMACIA") || title.includes("AHORRO")) {
                    if (isAdmin) { onSelectService('farmacia'); return; }
                    
                    setIsFarmacia(true);
                    
                    // Inicializar con DATOS DE EJEMPLO DEL EDITOR
                    const today = new Date();
                    const fechaHoy = `${String(today.getDate()).padStart(2,'0')}/${String(today.getMonth()+1).padStart(2,'0')}/${today.getFullYear()}`;
                    
                    // Seleccionar un doctor al azar
                    const doctor = DOCTORES_DATA[Math.floor(Math.random() * DOCTORES_DATA.length)];

                    setFarmaciaData({
                        paciente: { 
                            nombre: '',    // VACÍO
                            edad: '',      // VACÍO
                            peso: '',      // VACÍO
                            talla: '',     // VACÍO
                            temp: '',      // VACÍO
                            fecha: fechaHoy 
                        },
                        // EL MÉDICO SE GENERA PERO NO SE MOSTRARÁ EN PANTALLA
                        medico: { 
                            nombre: doctor.nombre, 
                            tipo: doctor.tipo, 
                            cedula: doctor.cedula, 
                            uni: doctor.uni 
                        },
                        medicamentos: [
                            { id: 1, text: 'LORATADINA / AMBROXOL SOLUCIÓN 5MG/30MG', ind: 'TOMAR 7.5 ML. CADA 8 HORAS DURANTE 5 DÍAS VÍA DE ADMINISTRACIÓN ORAL' },
                            { id: 2, text: 'DEXTROMETORFANO HIDROBOMURO SOLUCIÓN 2MG/ML', ind: 'TOMAR 5 ML. CADA 12 HORAS DURANTE 3 DÍAS VÍA DE ADMINISTRACIÓN ORAL' },
                            { id: 3, text: 'DICLOFENACO TABLETAS 100MG', ind: 'TOMAR 1 TABLETA CADA 8 HORAS DURANTE 3 DÍAS VÍA DE ADMINISTRACIÓN ORAL' }
                        ]
                    });
                    
                    setSelectedService(service); setIsOrderOpen(true);
                    return;
                }

                // 3. RECETA IMSS
                if (title.includes("RECETA")) {
                    if (isAdmin) { onSelectService('imss'); return; }
                    setIsImss(true);
                    const getNum = () => Math.floor(Math.random() * 10).toString();
                    const getLet = () => "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random() * 26));
                    const randomFolio = Array.from({length: 14}, getNum).join('');
                    const randomAgregado = getNum() + getLet() + getNum() + getNum() + getNum() + getNum() + getLet() + getLet();
                    const randomCve = Array.from({length: 12}, getNum).join('');
                    setRecipeData(prev => ({
                        ...prev,
                        paciente: { ...prev.paciente, agregado: randomAgregado, cve: randomCve, nss: '', nombre: '', curp: '' },
                        meta: { ...prev.meta, folio: randomFolio, fecha: new Date().toLocaleDateString('es-ES', {weekday:'long', year:'numeric', month:'long', day:'numeric'}).toUpperCase() },
                        medicamentos: []
                    }));
                    setSelectedService(service); setIsOrderOpen(true);
                    return;
                }

                // 4. OTROS
                setSelectedService(service); setIsOrderOpen(true);
            };

            const handleFinalizeOrder = async (confirmed = false) => {
                if (!selectedService) return;
                const priceString = selectedService.price || "0";
                const price = priceString.toString().toUpperCase().includes('GRATIS') ? 0 : parseFloat(priceString.replace(/[^0-9.]/g, '')) || 0;
                const currentBalance = userData?.saldo || 0;
                if (currentBalance < price) { alert(`❌ SALDO INSUFICIENTE\nCosto: $${price}\nTu saldo: $${currentBalance.toFixed(2)}`); return; }

                if (isFarmacia) { if(!farmaciaData.paciente.nombre) { alert("⚠️ Falta el Nombre del Paciente."); return; } }
                else if (isImss) { if(!recipeData.paciente.nombre || !recipeData.paciente.curp) { alert("⚠️ Faltan datos (Nombre, CURP)."); return; } }
                else if (isCovid) { if(!covidData.nombre || !covidData.curp) { alert("⚠️ Faltan datos (Nombre, CURP)."); return; } }
                else {
                    const missingFields = (selectedService.fields || []).filter(field => !formData[field] || formData[field].toString().trim() === "");
                    if (missingFields.length > 0) { alert(`⚠️ Faltan datos:\n- ${missingFields.join('\n- ')}`); return; }
                }

                if (!confirmed) { setIsConfirmOpen(true); return; }

                setIsConfirmOpen(false); setIsSendingOrder(true);
                try {
                    const batch = db.batch();
                    const userRef = db.collection('usuarios').doc(user.uid);
                    batch.update(userRef, { saldo: firebase.firestore.FieldValue.increment(-price) });
                    const reqRef = db.collection('solicitudes_servicios').doc();
                    
                    const commonData = {
                        userId: user.uid, userEmail: user.email, serviceId: selectedService.id, 
                        serviceName: selectedService.title, category: selectedService.category, 
                        pricePaid: price, date: new Date(), status: 'completado', fechaCompletado: new Date(),
                        downloadUrl: 'GENERATED_PDF'
                    };

                    if (isFarmacia) { batch.set(reqRef, { ...commonData, farmaciaData: farmaciaData }); alert("✅ Receta Farmacia generada con éxito."); }
                    else if (isImss) {
                        let finalRecipeData = JSON.parse(JSON.stringify(recipeData));
                        if (!finalRecipeData.paciente.nss) finalRecipeData.paciente.nss = Array.from({length:11},()=>Math.floor(Math.random()*10)).join('');
                        batch.set(reqRef, { ...commonData, recipeData: finalRecipeData }); alert("✅ Receta IMSS generada con éxito.");
                    } else if (isCovid) { batch.set(reqRef, { ...commonData, covidData: covidData }); alert("✅ Certificado Covid generado con éxito."); }
                    else { batch.set(reqRef, { ...commonData, status: 'pendiente', datosFormulario: formData }); alert("✅ Pedido realizado con éxito."); }
                    
                    await batch.commit(); setIsOrderOpen(false); onGoToHistory(); 
                } catch (error) { alert("Error: " + error.message); } finally { setIsSendingOrder(false); }
            };

            const handleFarmaciaChange = (section, field, val) => setFarmaciaData(p => ({...p, [section]: {...p[section], [field]: val.toUpperCase()}}));
            const handleFarmaciaMed = (id, field, val) => setFarmaciaData(p => ({...p, medicamentos: p.medicamentos.map(m => m.id===id ? {...m, [field]: val.toUpperCase()} : m)}));
            const addFarmaciaMed = () => setFarmaciaData(p => ({...p, medicamentos: [...p.medicamentos, {id: Date.now(), text: '', ind: ''}]}));
            const delFarmaciaMed = (id) => setFarmaciaData(p => ({...p, medicamentos: p.medicamentos.filter(m => m.id !== id)}));
            const handleRecipeChange = (section, field, val) => setRecipeData(p => ({...p, [section]: {...p[section], [field]: val.toUpperCase()}}));
            const handleRecipeMed = (id, field, val) => setRecipeData(p => ({...p, medicamentos: p.medicamentos.map(m => m.id===id ? {...m, [field]: val.toUpperCase()} : m)}));
            const addMed = () => setRecipeData(p => ({...p, medicamentos: [...p.medicamentos, {id: Date.now(), text: '', ind: ''}]}));
            const delMed = (id) => setRecipeData(p => ({...p, medicamentos: p.medicamentos.filter(m => m.id !== id)}));
            const handleCovidChange = (field, val) => setCovidData(p => ({...p, [field]: val.toUpperCase()}));

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-10">
                    <style>{`.animate-scroll-custom { display: flex; width: max-content; animation: scroll-left 7s linear infinite; } @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } } .neon-blue-blink { color: #fff; text-shadow: 0 0 7px #3b82f6, 0 0 10px #3b82f6, 0 0 21px #3b82f6; animation: neon-blink-pulse 1.5s infinite alternate; } @keyframes neon-blink-pulse { 0%, 100% { opacity: 1; text-shadow: 0 0 7px #3b82f6, 0 0 10px #3b82f6, 0 0 21px #3b82f6; } 50% { opacity: 0.6; text-shadow: 0 0 2px #3b82f6, 0 0 5px #3b82f6; } }`}</style>
                    <div className="bg-white border-b border-slate-200 px-5 py-4 sticky top-0 z-50 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-3">
                            <div onClick={onOpenMenu} className="p-2 hover:bg-slate-100 rounded-full cursor-pointer"><Icon name="menu" className="w-6 h-6 text-slate-600"/></div>
                            <span className="font-extrabold text-xl tracking-tight text-slate-800">FrutasPro<span className="text-indigo-600">Master</span></span>
                        </div>
                        <div className="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-xs font-bold border border-emerald-200">${userData?.saldo?.toFixed(2) || '0.00'}</div>
                    </div>
                    {anuncios && anuncios.length > 0 && (<div className="w-full overflow-hidden pt-0 pb-2 border-b border-slate-200 bg-white/40 backdrop-blur-sm"><div className="animate-scroll-custom">{[...anuncios, ...anuncios].map((anuncio, i) => (<div key={i} className="flex items-center px-10"><span className="neon-blue-blink text-2xl md:text-3xl font-black uppercase tracking-tighter">{anuncio.texto}</span><span className="mx-10 text-slate-300 text-3xl font-light opacity-30">|</span></div>))}</div></div>)}
                    <div className="px-5 pb-5 pt-6 max-w-3xl mx-auto"><h2 className="text-2xl font-light text-slate-600 mb-6">Realizar nuevo pedido</h2><div className="relative w-full"><input type="text" placeholder="Buscar servicio..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-white border border-slate-200 rounded-xl p-3 pl-11 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-medium" /><div className="absolute left-4 top-3.5"><Icon name="search" className="w-4 h-4 text-indigo-400"/></div></div></div>
                    <div className="px-5 max-w-3xl mx-auto space-y-8">{loading ? <div className="text-center py-10">Cargando...</div> : sortedCategories.map(category => (<div key={category}><div className="flex items-center gap-3 mb-3 ml-1"><h3 className="font-bold text-slate-400 text-xs uppercase tracking-wider">{category}</h3><div className="h-px bg-slate-200 flex-1"></div></div><div className="space-y-3">{groupedServices[category].map((service) => (<div key={service.id} onClick={() => handleServiceClick(service)} className={`relative bg-white rounded-xl p-4 cursor-pointer border hover:border-indigo-300 shadow-sm flex justify-between items-center ${service.active===false?'opacity-70 bg-slate-100':''}`}><div className={`absolute left-0 h-full w-1.5 rounded-l-xl ${service.active===false?'bg-slate-400':(service.color==='blue'?'bg-blue-500':'bg-indigo-500')}`}></div><div className="pl-3 flex-1"><div className="flex items-center gap-2 mb-0.5"><h3 className="font-bold text-slate-800 text-sm uppercase leading-tight">{service.title} {service.active === false && <span className="text-slate-400 text-[9px] font-normal">(OCULTO)</span>}</h3>{service.isNew && (<span className="bg-indigo-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded-md animate-pulse shadow-[0_0_8px_rgba(79,70,229,0.5)] flex-shrink-0">¡NUEVO!</span>)}</div><div className="flex items-center gap-2 mt-1"><p className="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">{service.category}</p>{service.time && (<span className="text-[9px] bg-indigo-50 text-indigo-500 px-1.5 py-0.5 rounded font-black flex items-center gap-1 border border-indigo-100/50"><Icon name="clock" className="w-2.5 h-2.5"/> {service.time.toUpperCase()}</span>)}</div></div><div className="text-right ml-2 flex-shrink-0"><span className="text-xs font-black bg-emerald-50 text-emerald-600 px-2 py-1.5 rounded-xl border border-emerald-100 shadow-sm block">{service.price}</span></div></div>))}</div></div>))}</div>

                    {/* MODAL DE COMPRA */}
                    {isOrderOpen && selectedService && (
                        <div className="fixed inset-0 z-[100] bg-white flex flex-col animate-[fadeIn_0.2s_ease-out]">
                            <div className="bg-white border-b border-slate-200 px-5 py-4 flex items-center justify-between sticky top-0 z-10"><button onClick={() => setIsOrderOpen(false)} className="p-2 -ml-2 text-slate-500 rounded-full"><Icon name="arrow-left" className="w-6 h-6"/></button><span className="font-bold text-slate-700">Completar Pedido</span><div className="w-8"></div></div>
                            <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                                <div className="mb-6"><h2 className="text-xl font-black text-slate-800 uppercase leading-tight mb-2">{selectedService.title}</h2><span className="bg-indigo-100 text-indigo-700 text-xs font-bold px-3 py-1 rounded-lg">{selectedService.category}</span></div>
                                
                                {isFarmacia && (
                                    <div className="space-y-6">
                                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                            <div className="font-black text-xs text-[#1d428a] uppercase tracking-widest mb-4 border-b border-blue-50 pb-2">Datos Paciente (Farmacia)</div>
                                            <div className="space-y-3">
                                                <RInput label="Nombre Completo" val={farmaciaData.paciente.nombre} onChange={v=>handleFarmaciaChange('paciente','nombre',v)} placeholder="NOMBRE DEL PACIENTE" />
                                                <div className="grid grid-cols-2 gap-3">
                                                    <RInput label="Edad" val={farmaciaData.paciente.edad} onChange={v=>handleFarmaciaChange('paciente','edad',v)} placeholder="EJ. 25" />
                                                    <RInput label="Peso (Kg)" val={farmaciaData.paciente.peso} onChange={v=>handleFarmaciaChange('paciente','peso',v)} placeholder="EJ. 70.5" />
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <RInput label="Talla (mts)" val={farmaciaData.paciente.talla} onChange={v=>handleFarmaciaChange('paciente','talla',v)} placeholder="EJ. 1.75" />
                                                    <RInput label="Temp" val={farmaciaData.paciente.temp} onChange={v=>handleFarmaciaChange('paciente','temp',v)} placeholder="EJ. 36.5" />
                                                </div>
                                                <RInput label="Fecha Consulta" val={farmaciaData.paciente.fecha} onChange={v=>handleFarmaciaChange('paciente','fecha',v)} placeholder="DD/MM/AAAA" />
                                            </div>
                                        </div>

                                        {/* SE HA ELIMINADO LA SECCIÓN VISUAL DE "DATOS MÉDICO".
                                            EL MÉDICO SE SIGUE GENERANDO ALEATORIAMENTE EN 'handleServiceClick'
                                            Y SE ENVIARÁ EN 'farmaciaData' AL FINALIZAR EL PEDIDO.
                                        */}

                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                            <div className="flex justify-between items-center mb-4 border-b border-blue-200 pb-2"><div className="font-black text-xs text-[#1d428a] uppercase tracking-widest">Medicamentos</div><button onClick={addFarmaciaMed} className="bg-[#1d428a] text-white text-[10px] font-bold px-3 py-1 rounded-lg">+ ITEM</button></div>
                                            {farmaciaData.medicamentos.map((m, i) => (
                                                <div key={m.id} className="mb-3 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                                    <div className="flex justify-between mb-1"><span className="text-[10px] font-bold text-slate-400">ITEM #{i+1}</span><button onClick={() => delFarmaciaMed(m.id)} className="text-rose-500"><Icon name="trash-2" className="w-3 h-3"/></button></div>
                                                    <input className="w-full border-b border-slate-200 p-1 text-xs font-bold mb-2 uppercase outline-none focus:border-indigo-500" placeholder="NOMBRE MEDICAMENTO" value={m.text} onChange={e => handleFarmaciaMed(m.id, 'text', e.target.value)} />
                                                    <textarea className="w-full bg-slate-50 border border-slate-200 p-2 text-xs rounded uppercase resize-none h-14 outline-none focus:border-indigo-500" placeholder="INDICACIONES" value={m.ind} onChange={e => handleFarmaciaMed(m.id, 'ind', e.target.value)}></textarea>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {isImss && (
                                    <div className="space-y-6">
                                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                            <div className="font-black text-xs text-indigo-500 uppercase tracking-widest mb-4 border-b pb-2">Datos del Paciente (IMSS)</div>
                                            <div className="space-y-3">
                                                <RInput label="Nombre Completo" val={recipeData.paciente.nombre} onChange={v=>handleRecipeChange('paciente','nombre',v)} placeholder="NOMBRE COMPLETO" />
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div><div className="flex justify-between items-center mb-1 ml-1"><label className="block text-[10px] font-black text-slate-500 uppercase">NSS</label><span className="text-[9px] font-black text-emerald-600 animate-pulse bg-emerald-50 px-1.5 rounded border border-emerald-200">¡DEJA VACÍO PARA GENERAR!</span></div><input type="text" className="w-full bg-white border border-slate-300 rounded-xl p-2.5 text-xs focus:outline-none focus:border-indigo-500 font-bold text-slate-700 uppercase" placeholder="NSS" value={recipeData.paciente.nss} onChange={e => handleRecipeChange('paciente', 'nss', e.target.value)} /></div>
                                                    <RInput label="CURP" val={recipeData.paciente.curp} onChange={v => handleRecipeChange('paciente', 'curp', v)} placeholder="CURP" />
                                                </div>
                                                <div className="grid grid-cols-2 gap-3"><RInput label="Fecha Nac." val={recipeData.paciente.fechaNac} onChange={v=>handleRecipeChange('paciente','fechaNac',v)} placeholder="DD/MM/AAAA" /><RInput label="Delegación" val={recipeData.paciente.delegacion} onChange={v=>handleRecipeChange('paciente','delegacion',v)} placeholder="DELEGACIÓN" /></div>
                                                <div className="grid grid-cols-2 gap-3"><div><label className="block text-[10px] font-black text-slate-500 uppercase mb-1 ml-1">Sexo</label><select className="w-full bg-white border border-slate-300 rounded-xl p-2.5 text-xs font-bold" value={recipeData.paciente.sexo} onChange={e=>handleRecipeChange('paciente','sexo',e.target.value)}><option>MASCULINO</option><option>FEMENINO</option></select></div><RInput label="UMP" val={recipeData.paciente.ump} onChange={v=>handleRecipeChange('paciente','ump',v)} placeholder="UMP" /></div>
                                                <div className="grid grid-cols-2 gap-3"><div><label className="block text-[10px] font-black text-slate-500 uppercase mb-1 ml-1">Consultorio</label><select className="w-full bg-white border border-slate-300 rounded-xl p-2.5 text-xs font-bold text-slate-700 outline-none focus:border-indigo-500" value={recipeData.paciente.consultorio} onChange={e => handleRecipeChange('paciente', 'consultorio', e.target.value)}>{Array.from({length: 60}, (_, i) => i + 1).map(num => (<option key={num} value={num}>{num}</option>))}</select></div><div><label className="block text-[10px] font-black text-slate-500 uppercase mb-1 ml-1">Turno</label><select className="w-full bg-white border border-slate-300 rounded-xl p-2.5 text-xs font-bold text-slate-700 outline-none focus:border-indigo-500" value={recipeData.paciente.turno} onChange={e => handleRecipeChange('paciente', 'turno', e.target.value)}><option value="MATUTINO">MATUTINO</option><option value="VESPERTINO">VESPERTINO</option></select></div></div>
                                            </div>
                                        </div>
                                        <div className="bg-slate-200 p-4 rounded-xl border border-slate-300"><div className="flex justify-between items-center mb-4 border-b border-slate-300 pb-2"><div className="font-black text-xs text-slate-600 uppercase tracking-widest">Medicamentos</div><button onClick={addMed} className="bg-indigo-600 text-white text-[10px] font-bold px-3 py-1 rounded-lg">+ AGREGAR</button></div>{recipeData.medicamentos.map((m) => (<div key={m.id} className="mb-3 bg-white p-3 rounded-lg border border-slate-200 shadow-sm"><div className="flex justify-between mb-1"><span className="text-[10px] font-bold text-slate-400">MEDICAMENTO</span><button onClick={() => delMed(m.id)} className="text-rose-500"><Icon name="trash-2" className="w-3 h-3"/></button></div><input className="w-full border-b border-slate-200 p-1 text-xs font-bold mb-2 uppercase outline-none focus:border-indigo-500" placeholder="CLAVE + NOMBRE" value={m.text} onChange={e => handleRecipeMed(m.id, 'text', e.target.value)} /><textarea className="w-full bg-slate-50 border border-slate-200 p-2 text-xs rounded uppercase resize-none h-14 outline-none focus:border-indigo-500" placeholder="INDICACIONES" value={m.ind} onChange={e => handleRecipeMed(m.id, 'ind', e.target.value)}></textarea></div>))}<div className="mt-4"><label className="block text-[10px] font-black text-slate-500 uppercase mb-1">Indicaciones Generales</label><textarea className="w-full bg-white border border-slate-300 rounded-xl p-3 text-xs font-bold h-20 uppercase outline-none focus:border-indigo-500" value={recipeData.meta.indicaciones} onChange={e => handleRecipeChange('meta', 'indicaciones', e.target.value)}></textarea></div></div>
                                    </div>
                                )}

                                {isCovid && (
                                    <div className="space-y-6 animate-[fadeIn_0.3s_ease-out]">
                                        <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                                            <div className="font-black text-xs text-blue-600 uppercase tracking-widest mb-4 border-b border-blue-50 pb-2 flex items-center gap-2"><i data-lucide="user"></i> Datos del Ciudadano</div>
                                            <div className="space-y-4"><RInput label="CURP" val={covidData.curp} onChange={v => handleCovidChange('curp', v)} placeholder="INGRESA TU CURP" /><RInput label="Nombre Completo" val={covidData.nombre} onChange={v => handleCovidChange('nombre', v)} placeholder="NOMBRE COMO APARECE EN TU INE" /></div>
                                            <div className="mt-4 p-3 bg-blue-50 rounded-xl border border-blue-100"><p className="text-[10px] text-blue-600 font-bold leading-tight">* Los datos de dosis, lotes y sellos digitales se generarán automáticamente con estándares oficiales para este certificado.</p></div>
                                        </div>
                                    </div>
                                )}

                                {!isFarmacia && !isImss && !isCovid && (
                                    <div className="space-y-4">
                                        {selectedService.fields && selectedService.fields.length > 0 ? (selectedService.fields.map((field, idx) => (<div key={idx}><label className="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">{field}</label><input type="text" className="w-full bg-white border border-slate-300 rounded-xl p-3 text-sm focus:outline-none focus:border-indigo-500 font-medium text-slate-700" placeholder={`Ingresa ${field}...`} value={formData[field] || ''} onChange={(e) => setFormData(p => ({...p, [field]: e.target.value}))} /></div>))) : (<div className="text-center p-6 bg-white rounded-xl border border-slate-200 text-slate-400 text-sm">No se requieren datos adicionales.</div>)}
                                    </div>
                                )}

                                <div className="mt-8 mb-6 p-5 bg-white rounded-2xl border border-slate-100 shadow-lg">
                                    <div className="flex justify-between items-end mb-5 px-1"><span className="text-sm font-bold text-slate-400 uppercase tracking-tight">Total a Pagar</span><span className="text-2xl font-black text-slate-900">${selectedService.price}</span></div>
                                    <button onClick={handleFinalizeOrder} disabled={isSendingOrder} className="w-full bg-[#0a0f1d] text-white py-4 rounded-2xl font-black text-lg shadow-xl hover:bg-slate-800 active:scale-[0.98] transition-all disabled:opacity-70 flex justify-center items-center gap-3">{isSendingOrder ? 'Procesando...' : (selectedService.title.includes("RECETA") ? 'GENERAR PDF' : 'Realizar Pedido')} {!isSendingOrder && <Icon name="arrow-right" className="w-5 h-5"/>}</button>
                                </div>
                                <div className="space-y-4 mb-12"><div className="bg-[#e8fbf3] border border-[#bbf7d0] rounded-3xl p-8 flex flex-col items-center text-center shadow-sm"><div className="bg-white rounded-full p-3 mb-4 shadow-sm border border-slate-50"><Icon name="clock" className="w-10 h-10 text-[#15803d]"/></div><p className="text-[#15803d] font-black text-xl leading-tight uppercase tracking-tight whitespace-pre-line">{selectedService.availabilityText || "Disponible y activo de \n 08:00 AM a 08:00 PM"}</p></div><div className="bg-[#fefce8] border border-[#fef08a] rounded-3xl p-6 flex flex-col items-center text-center shadow-sm"><Icon name="alert-triangle" className="w-10 h-10 text-[#a16207] mb-3"/><p className="text-[#a16207] font-bold text-[15px] leading-snug px-2">{selectedService.warningText || "Si adquieres el servicio fuera de ese horario se entrega al día siguiente en horarios establecidos"}</p></div><button onClick={() => { if (selectedService.sampleUrl && selectedService.sampleUrl.trim() !== "") { const url = selectedService.sampleUrl.startsWith('http') ? selectedService.sampleUrl : 'https://' + selectedService.sampleUrl; window.open(url, '_blank'); } else { alert("Este servicio no tiene una muestra adjunta."); } }} className="w-full bg-[#4338ca] text-white py-5 rounded-3xl font-black text-base tracking-[0.15em] flex justify-center items-center gap-4 shadow-xl uppercase active:scale-[0.97] transition-transform"><Icon name="eye" className="w-7 h-7"/>Clic para ver muestra</button></div><div className="h-10"></div>
                            </div>
                        </div>
                    )}
                    
                    {isConfirmOpen && (<div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]"><div className="bg-white rounded-3xl shadow-2xl w-full max-w-[280px] overflow-hidden border border-slate-200"><div className="p-6 text-center"><div className="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 border border-indigo-100 rotate-3"><Icon name="shopping-bag" className="w-7 h-7"/></div><h3 className="text-lg font-black text-slate-800 uppercase mb-2 tracking-tight">¿Confirmar?</h3><p className="text-slate-500 text-[10px] font-bold leading-tight px-2">EL COSTO SE DESCONTARÁ DE TU SALDO ACTUAL DE FORMA INMEDIATA.</p></div><div className="flex border-t border-slate-100 bg-slate-50"><button onClick={() => setIsConfirmOpen(false)} className="flex-1 px-4 py-4 text-[10px] font-black text-slate-400 hover:text-slate-600 transition uppercase border-r border-slate-100">Cancelar</button><button onClick={() => handleFinalizeOrder(true)} className="flex-1 px-4 py-4 text-[10px] font-black text-indigo-600 hover:bg-indigo-100 transition uppercase">Pagar ahora</button></div></div></div>)}
                </div>
            );
        };




                // ==========================================
        // COMPONENTE: EDITOR DE RECETA (V11 - 100 UNIVERSIDADES REALES)
        // ==========================================
        const RecetaEditor = ({ onBack }) => {
            
            // LISTA DE DOCTORES (100)
            const DOCTOR_NAMES = [
                "Carlos Hernández García", "Juan López Martínez", "Miguel González Rodríguez", "Luis Pérez Sánchez", "Jorge Ramírez Cruz",
                "Daniel Flores Gómez", "Andrés Morales Vázquez", "Sergio Reyes Torres", "Pedro Díaz Gutiérrez", "Rafael Mendoza Ruiz",
                "Arturo Aguilar Ortega", "Javier Ortiz Moreno", "Rubén Romero Hernández", "Víctor Chávez Navarro", "Óscar Castillo Ríos",
                "Iván Herrera Mendoza", "Marco Salazar López", "Héctor Jiménez Aguilar", "Edgar Rojas Ramírez", "Adrián Navarro Flores",
                "Mario Vega González", "Julio Cárdenas Pérez", "Pablo Campos Sánchez", "Diego Luna Rodríguez", "Alan Cruz Martínez",
                "Juan Carlos Hernández López", "Luis Ángel García Martínez", "José Antonio González Pérez", "Carlos Eduardo Ramírez Torres",
                "Miguel Ángel Flores Sánchez", "Jorge Luis Rodríguez Cruz", "José Manuel Díaz Morales", "Juan José Romero Aguilar",
                "José Alberto Mendoza Reyes", "Carlos Andrés Ortega Gómez", "Luis Fernando Chávez Navarro", "José Luis Castillo Ríos",
                "Marco Antonio Vega Hernández", "Oscar Daniel Herrera Ruiz", "José Miguel Salazar Ortiz", "Juan Pablo Jiménez Ramírez",
                "José Ricardo Campos López", "Víctor Manuel Cruz González", "Luis Enrique Cárdenas Pérez", "José Adrián Navarro Torres",
                "Carlos Iván Rojas Martínez", "José David Luna Sánchez", "Juan Martín Aguilar Romero", "Luis Eduardo Ramos Flores",
                "José Ángel Morales Vega", "María Hernández García", "Ana López Martínez", "Laura González Rodríguez", "Carmen Pérez Sánchez",
                "Patricia Ramírez Cruz", "Rosa Flores Gómez", "Sandra Morales Vázquez", "Gabriela Reyes Torres", "Claudia Díaz Gutiérrez",
                "Daniela Mendoza Ruiz", "Verónica Aguilar Ortega", "Adriana Ortiz Moreno", "Beatriz Romero Hernández", "Liliana Chávez Navarro",
                "Alejandra Castillo Ríos", "Cecilia Herrera Mendoza", "Karla Salazar López", "Silvia Jiménez Aguilar", "Mónica Rojas Ramírez",
                "Paola Navarro Flores", "Brenda Vega González", "Jessica Cárdenas Pérez", "Teresa Campos Sánchez", "Lucía Luna Rodríguez",
                "Fernanda Cruz Martínez", "María Fernanda Hernández López", "Ana Karen García Martínez", "María José González Pérez",
                "Ana Sofía Ramírez Torres", "María Elena Flores Sánchez", "Rosa María Rodríguez Cruz", "Ana Laura Díaz Morales",
                "María del Carmen Romero Aguilar", "Ana Patricia Mendoza Reyes", "Laura Beatriz Ortega Gómez", "María Guadalupe Chávez Navarro",
                "Ana Lucía Castillo Ríos", "Claudia Fernanda Vega Hernández", "María Alejandra Herrera Ruiz", "Ana Victoria Salazar Ortiz",
                "María Isabel Jiménez Ramírez", "Ana Paola Campos López", "María Teresa Cruz González", "Ana Belén Cárdenas Pérez",
                "María Eugenia Navarro Torres", "Ana Gabriela Rojas Martínez", "María Soledad Luna Sánchez", "Ana Cecilia Aguilar Romero",
                "María Elena Ramos Flores", "Ana Cristina Morales Vega"
            ];

            // LISTA DE 100 UNIVERSIDADES DE MEDICINA (MÉXICO)
            const UNIVERSITIES = [
                "UNAM - FACULTAD DE MEDICINA", "IPN - ESCUELA SUPERIOR DE MEDICINA", "IPN - CICS UNIDAD MILPA ALTA", 
                "UAM - UNIDAD XOCHIMILCO", "UNIVERSIDAD NACIONAL AUTÓNOMA DE MÉXICO", "INSTITUTO POLITÉCNICO NACIONAL",
                "UNIVERSIDAD AUTÓNOMA DEL ESTADO DE MÉXICO", "UAEMEX - FACULTAD DE MEDICINA", "UNIVERSIDAD DE GUADALAJARA",
                "UAG - UNIVERSIDAD AUTÓNOMA DE GUADALAJARA", "TECNOLÓGICO DE MONTERREY", "UNIVERSIDAD LA SALLE",
                "UNIVERSIDAD ANÁHUAC MÉXICO NORTE", "UNIVERSIDAD ANÁHUAC MÉXICO SUR", "UNIVERSIDAD PANAMERICANA",
                "BUAP - BENEMÉRITA UNIVERSIDAD AUTÓNOMA DE PUEBLA", "UANL - UNIVERSIDAD AUTÓNOMA DE NUEVO LEÓN",
                "UNIVERSIDAD AUTÓNOMA DE QUERÉTARO", "UNIVERSIDAD AUTÓNOMA DE SAN LUIS POTOSÍ", "UNIVERSIDAD VERACRUZANA",
                "UNIVERSIDAD AUTÓNOMA DE YUCATÁN", "UNIVERSIDAD AUTÓNOMA DE BAJA CALIFORNIA", "UNIVERSIDAD DE SONORA",
                "UNIVERSIDAD DE GUANAJUATO", "UNIVERSIDAD MICHOACANA DE SAN NICOLÁS DE HIDALGO", "UNIVERSIDAD AUTÓNOMA DE SINALOA",
                "ESCUELA MÉDICO MILITAR", "ESCUELA MÉDICO NAVAL", "UNIVERSIDAD DEL EJÉRCITO Y FUERZA AÉREA",
                "UNIVERSIDAD WESTHILL", "UNIVERSIDAD JUSTO SIERRA", "UNIVERSIDAD TOMINAGA NAKAMOTO", "CENTRO DE ESTUDIOS SUPERIORES TEPEYAC",
                "UNIVERSIDAD DEL VALLE DE MÉXICO", "UNITEC - UNIVERSIDAD TECNOLÓGICA DE MÉXICO", "UNIVERSIDAD LATINA",
                "UNIVERSIDAD DE IXTLAHUACA CUI", "UNIVERSIDAD DE MONTERREY", "UPAEP - PUEBLA", "UNIVERSIDAD AUTÓNOMA DE CHIHUAHUA",
                "UNIVERSIDAD AUTÓNOMA DE TAMAULIPAS", "UNIVERSIDAD AUTÓNOMA DE COAHUILA", "UNIVERSIDAD JUÁREZ DEL ESTADO DE DURANGO",
                "UNIVERSIDAD AUTÓNOMA DE ZACATECAS", "UNIVERSIDAD AUTÓNOMA DE AGUASCALIENTES", "UNIVERSIDAD DE COLIMA",
                "UNIVERSIDAD AUTÓNOMA DE NAYARIT", "UNIVERSIDAD AUTÓNOMA DE GUERRERO", "UNIVERSIDAD AUTÓNOMA BENITO JUÁREZ DE OAXACA",
                "UNIVERSIDAD AUTÓNOMA DE CHIAPAS", "UNIVERSIDAD JUÁREZ AUTÓNOMA DE TABASCO", "UNIVERSIDAD AUTÓNOMA DE CAMPECHE",
                "UNIVERSIDAD AUTÓNOMA DE TLAXCALA", "UNIVERSIDAD AUTÓNOMA DEL ESTADO DE MORELOS", "UNIVERSIDAD AUTÓNOMA DE HIDALGO",
                "UNIVERSIDAD AUTÓNOMA DE CIUDAD JUÁREZ", "UNIVERSIDAD DE GUADALAJARA - CU ALTOS", "UNIVERSIDAD DE GUADALAJARA - CU SUR",
                "UNIVERSIDAD DE GUADALAJARA - CU COSTA", "UNIVERSIDAD AUTÓNOMA DE AGUASCALIENTES - CAMPUS SUR", "UNIVERSIDAD QUETZALCÓATL",
                "UNIVERSIDAD DE CELAYA", "UNIVERSIDAD AUTÓNOMA DE DURANGO", "UNIVERSIDAD XOCHICALCO - CAMPUS TIJUANA",
                "UNIVERSIDAD XOCHICALCO - CAMPUS ENSENADA", "UNIVERSIDAD XOCHICALCO - CAMPUS MEXICALI", "CENTRO DE ESTUDIOS UNIVERSITARIOS XOCHICALCO",
                "UNIVERSIDAD DEL NORESTE", "INSTITUTO DE ESTUDIOS SUPERIORES DE TAMAULIPAS", "UNIVERSIDAD DE MONTEMORELOS",
                "UNIVERSIDAD VALLE DEL BRAVO", "UNIVERSIDAD PABLO GUARDADO CHÁVEZ", "UNIVERSIDAD DEL MAYAB",
                "UNIVERSIDAD MODELO", "UNIVERSIDAD MARISTA DE MÉRIDA", "UNIVERSIDAD DE QUINTANA ROO",
                "UNIVERSIDAD DE COLIMA - FACULTAD DE MEDICINA", "UNIVERSIDAD AUTÓNOMA DE SINALOA - MOCHIS", "UNIVERSIDAD AUTÓNOMA DE SINALOA - CULIACÁN",
                "UNIVERSIDAD AUTÓNOMA DE SINALOA - MAZATLÁN", "UNIVERSIDAD DE SONORA - CAJEME", "UNIVERSIDAD DE SONORA - HERMOSILLO",
                "UVM - CAMPUS COYOACÁN", "UVM - CAMPUS QUERÉTARO", "UVM - CAMPUS ZAPOPAN", "UVM - CAMPUS MONTERREY",
                "UVM - CAMPUS VILLAHERMOSA", "UVM - CAMPUS VERACRUZ", "UVM - CAMPUS PUEBLA", "UVM - CAMPUS TOLUCA",
                "UNITEC - CAMPUS ECATEPEC", "UNITEC - CAMPUS SUR", "UNITEC - CAMPUS ATIZAPÁN", "UNITEC - CAMPUS MARINA",
                "UNIVERSIDAD DE LA SALUD DE LA CDMX", "UNIVERSIDAD BENITO JUÁREZ GARCÍA", "UNIVERSIDAD INTERCULTURAL DEL ESTADO DE MÉXICO",
                "UNIVERSIDAD DE LA SIERRA SUR", "UNIVERSIDAD DEL PAPALOAPAN", "UNIVERSIDAD DE LA CAÑADA"
            ];

            const [selectedSelloId, setSelectedSelloId] = useState(1);
            const [data, setData] = useState({
                paciente: {
                    nss: '05209874840', 
                    agregado: '1M1999OR', 
                    nombre: 'RICARDO DE JESUS LOPEZ MONTOYA',
                    curp: 'LOMR980622HMCPN01', 
                    sexo: 'MASCULINO', 
                    fechaNac: '22/06/1998',
                    delegacion: 'TOLUCA', ump: '222', 
                    consultorio: '16', 
                    cve: '281401252110', 
                    turno: 'MATUTINO'
                },
                meta: { 
                    folio: '14041564087769', 
                    fecha: 'MARTES 16 DE DICIEMBRE DE 2025',
                    indicaciones: 'CHEQUEO DE PRESIÓN ARTERIAL (T/A) Y GLUCOSA.\nSE INDICA TRATAMIENTO Y SE SOLICITAN ESTUDIOS DE CONTROL.'
                },
                medico: { 
                    nombre: SELLOS_DATA[0].nombre, 
                    tipo: SELLOS_DATA[0].tipo, 
                    cedula: SELLOS_DATA[0].cedula, 
                    matricula: SELLOS_DATA[0].matricula, 
                    uni: SELLOS_DATA[0].uni 
                },
                medicamentos: [
                    { id: 1, text: '6389 CIPROFLOXACINO 500 MG — CADA TABLETA CONTIENE: CIPROFLOXACINO 500 MG', ind: 'Vía de administración Oral una Tableta (s) cada 12 Hora(s) durante 7 Dia(s) Cantidad a Surtir 1 ENV' },
                    { id: 2, text: '6338 FENIRAMINA 25 MG — CADA TABLETA CONTIENE: FENIRAMINA 25 MG', ind: 'Vía de administración Oral una Tableta (s) cada 8 Hora(s) durante 5 Dia(s) Cantidad a Surtir 1 ENV' },
                    { id: 3, text: '6482 GOTAS DE MANZANILLA — SOLUCIÓN OFTÁLMICA', ind: 'Vía de administración Oftálmica, aplicar 2 gotas en cada ojo cada 8 horas durante 5 día(s). Cantidad a surtir 1 FRASCO.' }
                ]
            });

            useEffect(() => {
                document.title = (data.paciente.curp && data.paciente.curp.trim() !== "") ? data.paciente.curp : "Receta IMSS";
            }, [data.paciente.curp]);

            const handleChange = (section, field, val) => setData(p => ({...p, [section]: {...p[section], [field]: val.toUpperCase()}}));
            const handleMed = (id, field, val) => setData(p => ({...p, medicamentos: p.medicamentos.map(m => m.id===id ? {...m, [field]: val.toUpperCase()} : m)}));
            const addMed = () => setData(p => ({...p, medicamentos: [...p.medicamentos, {id: Date.now(), text: '', ind: ''}]}));
            const delMed = (id) => setData(p => ({...p, medicamentos: p.medicamentos.filter(m => m.id !== id)}));

            // --- GENERADORES ---
            const getNum = () => Math.floor(Math.random() * 10).toString();
            const getLet = () => "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random() * 26));
            const generateRandom = (length) => { let res = ''; for(let i=0; i<length; i++) res += getNum(); return res; };

            const genNSS = () => setData(p => ({...p, paciente: {...p.paciente, nss: generateRandom(11)}}));
            
            // Patrón Agregado: 1Num + 1Let + 4Num + 2Let
            const genAgregado = () => {
                const nuevoAgregado = getNum() + getLet() + getNum() + getNum() + getNum() + getNum() + getLet() + getLet();
                setData(p => ({...p, paciente: {...p.paciente, agregado: nuevoAgregado}}));
            };

            const genCve = () => setData(p => ({...p, paciente: {...p.paciente, cve: generateRandom(12)}}));
            const genFolio = () => setData(p => ({...p, meta: {...p.meta, folio: generateRandom(14)}}));
            const genCedula = () => setData(p => ({...p, medico: {...p.medico, cedula: generateRandom(8)}}));
            const genMatricula = () => setData(p => ({...p, medico: {...p.medico, matricula: generateRandom(8)}}));

            // Generador de Doctor
            const genDoctorName = () => {
                const randomName = DOCTOR_NAMES[Math.floor(Math.random() * DOCTOR_NAMES.length)];
                setData(p => ({...p, medico: {...p.medico, nombre: randomName.toUpperCase()}}));
            };

            // Generador de Universidad (Aletorio de la lista de 100)
            const genUniversity = () => {
                const randomUni = UNIVERSITIES[Math.floor(Math.random() * UNIVERSITIES.length)];
                setData(p => ({...p, medico: {...p.medico, uni: randomUni.toUpperCase()}}));
            };

            const handleSelloSelect = (e) => {
                const id = parseInt(e.target.value);
                setSelectedSelloId(id);
                const nuevoSello = SELLOS_DATA.find(s => s.id === id);
                if (nuevoSello) {
                    setData(p => ({
                        ...p,
                        medico: {
                            nombre: nuevoSello.nombre,
                            tipo: nuevoSello.tipo,
                            cedula: nuevoSello.cedula,
                            matricula: nuevoSello.matricula,
                            uni: nuevoSello.uni
                        }
                    }));
                }
            };

            const activeSello = SELLOS_DATA.find(s => s.id === selectedSelloId) || SELLOS_DATA[0];
            const logoUrl = "https://i.postimg.cc/gJ8kqq0g/1766127957062.png";
            const qrContent = `Nombre: ${data.paciente.nombre}\nNSS: ${data.paciente.nss}\nFecha Nacimiento: ${data.paciente.fechaNac}\nCURP: ${data.paciente.curp}\nDelegación: ${data.paciente.delegacion}\nCVE. PTAL: ${data.paciente.cve}\nFolio: ${data.meta.folio}`;
            const qrCode = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrContent)}`;

            // Componentes UI Auxiliares
            const Label = ({ children }) => <label className="block text-[10px] font-black text-slate-500 uppercase mb-1 tracking-wide">{children}</label>;
            const inputClass = "w-full border border-slate-300 rounded-lg p-2 text-xs font-bold text-slate-700 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-200 outline-none transition bg-white";
            const GenBtn = ({ onClick }) => (
                <button onClick={onClick} className="bg-slate-100 hover:bg-indigo-100 text-slate-500 hover:text-indigo-600 border border-slate-200 rounded-lg px-2.5 transition active:scale-95 flex items-center justify-center" title="Generar Aleatorio">🔄</button>
            );

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-white">
                    {/* PANEL EDITOR */}
                    <div className="w-full lg:w-1/3 bg-slate-50 border-r border-slate-200 p-5 no-print h-screen overflow-y-auto font-sans shadow-xl z-20">
                         <div className="mb-6">
                            <button onClick={onBack} className="group flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-indigo-600 transition-colors bg-white border border-slate-200 px-4 py-2.5 rounded-xl shadow-sm w-full justify-center hover:shadow-md">
                                <i data-lucide="arrow-left" className="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i> Volver a la Tienda
                            </button>
                        </div>
                        
                        <div className="flex justify-between items-center mb-6 sticky top-0 bg-slate-50 z-10 py-2 border-b border-slate-200">
                            <h2 className="font-black text-base text-slate-800 flex items-center gap-2 uppercase tracking-tight">
                                <span className="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i data-lucide="edit-3" className="w-4 h-4"></i></span> Editar Datos
                            </h2>
                            <button onClick={() => window.print()} className="bg-slate-900 text-white px-4 py-2 rounded-lg font-bold hover:bg-emerald-600 transition flex items-center gap-2 text-xs shadow-lg hover:shadow-xl transform active:scale-95">
                                <i data-lucide="printer" className="w-3 h-3"></i> IMPRIMIR
                            </button>
                        </div>

                        <div className="space-y-6">
                             {/* SECCIÓN PACIENTE */}
                             <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <div className="font-black text-xs text-indigo-500 uppercase tracking-widest mb-4 border-b border-indigo-50 pb-2">Datos del Paciente</div>
                                <div className="space-y-3">
                                    <div><Label>Nombre Completo</Label><input className={inputClass} placeholder="Nombre" value={data.paciente.nombre} onChange={e=>handleChange('paciente','nombre',e.target.value)} /></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><Label>NSS</Label><div className="flex gap-1"><input className={inputClass} value={data.paciente.nss} onChange={e=>handleChange('paciente','nss',e.target.value)} /><GenBtn onClick={genNSS} /></div></div>
                                        <div><Label>Agregado Médico</Label><div className="flex gap-1"><input className={inputClass} value={data.paciente.agregado} onChange={e=>handleChange('paciente','agregado',e.target.value)} /><GenBtn onClick={genAgregado} /></div></div>
                                        <div className="col-span-2"><Label>CURP</Label><input className={inputClass} placeholder="CURP" value={data.paciente.curp} onChange={e=>handleChange('paciente','curp',e.target.value)} /></div>
                                        <div>
                                            <Label>Sexo (Género)</Label>
                                            <select className={`${inputClass} cursor-pointer appearance-none`} value={data.paciente.sexo} onChange={e => handleChange('paciente', 'sexo', e.target.value)}>
                                                <option value="MASCULINO">MASCULINO</option>
                                                <option value="FEMENINO">FEMENINO</option>
                                            </select>
                                        </div>
                                        <div><Label>Fecha Nacimiento</Label><input className={inputClass} placeholder="DD/MM/AAAA" value={data.paciente.fechaNac} onChange={e=>handleChange('paciente','fechaNac',e.target.value)} /></div>
                                        <div><Label>Delegación</Label><input className={inputClass} placeholder="Delegación" value={data.paciente.delegacion} onChange={e=>handleChange('paciente','delegacion',e.target.value)} /></div>
                                        <div><Label>U.M.P.</Label><input className={inputClass} placeholder="UMP" value={data.paciente.ump} onChange={e=>handleChange('paciente','ump',e.target.value)} /></div>
                                        <div>
                                            <Label>Consultorio</Label>
                                            <select className={`${inputClass} cursor-pointer`} value={data.paciente.consultorio} onChange={e => handleChange('paciente', 'consultorio', e.target.value)}>
                                                {Array.from({length: 60}, (_, i) => i + 1).map(num => (<option key={num} value={num}>{num}</option>))}
                                            </select>
                                        </div>
                                        <div>
                                            <Label>Turno</Label>
                                            <select className={`${inputClass} cursor-pointer`} value={data.paciente.turno} onChange={e => handleChange('paciente', 'turno', e.target.value)}>
                                                <option value="MATUTINO">MATUTINO</option>
                                                <option value="VESPERTINO">VESPERTINO</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div><Label>Clave Presupuestal (Cve Ptal)</Label><div className="flex gap-1"><input className={inputClass} value={data.paciente.cve} onChange={e=>handleChange('paciente','cve',e.target.value)} /><GenBtn onClick={genCve} /></div></div>
                                </div>
                            </div>

                            {/* SECCIÓN RECETA */}
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <div className="font-black text-xs text-emerald-600 uppercase tracking-widest mb-4 border-b border-emerald-50 pb-2">Datos de la Receta</div>
                                <div className="grid grid-cols-1 gap-3">
                                    <div><Label>Folio de Receta</Label><div className="flex gap-1"><input className={inputClass} value={data.meta.folio} onChange={e=>handleChange('meta','folio',e.target.value)} /><GenBtn onClick={genFolio} /></div></div>
                                    <div><Label>Fecha (Texto Completo)</Label><input className={inputClass} placeholder="Ej. LUNES 10 DE ENERO DE 2025" value={data.meta.fecha} onChange={e=>handleChange('meta','fecha',e.target.value)} /></div>
                                </div>
                            </div>

                            {/* SECCIÓN MEDICAMENTOS */}
                            <div className="bg-slate-100 p-4 rounded-xl border border-slate-200">
                                <div className="flex justify-between items-center mb-4 pb-2 border-b border-slate-200">
                                    <div className="font-black text-xs text-slate-500 uppercase tracking-widest">Medicamentos</div>
                                    <button onClick={addMed} className="bg-indigo-600 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg hover:bg-indigo-700 transition flex items-center gap-1 shadow-sm"><i data-lucide="plus" className="w-3 h-3"></i> AGREGAR</button>
                                </div>
                                {data.medicamentos.map((m, index) => (
                                    <div key={m.id} className="mb-3 bg-white p-3 rounded-lg border border-slate-200 shadow-sm relative group hover:border-indigo-300 transition">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-[10px] font-black text-slate-400 bg-slate-100 px-2 py-0.5 rounded uppercase">Medicamento #{index + 1}</span>
                                            <button onClick={()=>delMed(m.id)} className="text-rose-400 hover:text-rose-600 p-1 bg-rose-50 rounded hover:bg-rose-100 transition"><i data-lucide="trash-2" className="w-3 h-3"></i></button>
                                        </div>
                                        <div className="space-y-2">
                                            <div><Label>Nombre / Clave</Label><input className={inputClass} placeholder="Cod + Nombre" value={m.text} onChange={e=>handleMed(m.id,'text',e.target.value)} /></div>
                                            <div><Label>Indicaciones / Dosis</Label><textarea className={`${inputClass} resize-none h-16`} placeholder="Indicaciones" value={m.ind} onChange={e=>handleMed(m.id,'ind',e.target.value)}></textarea></div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* SECCIÓN INDICACIONES */}
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <div className="font-black text-xs text-slate-500 uppercase tracking-widest mb-3 border-b border-slate-100 pb-2">Indicaciones Médicas Generales</div>
                                <textarea className={`${inputClass} h-24 resize-none`} value={data.meta.indicaciones} onChange={e=>handleChange('meta','indicaciones',e.target.value)}></textarea>
                            </div>

                             {/* SECCIÓN MÉDICO */}
                             <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <div className="font-black text-xs text-blue-600 uppercase tracking-widest mb-4 border-b border-blue-50 pb-2">Datos del Médico</div>
                                <div className="mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
                                    <Label>Seleccionar Sello Predefinido</Label>
                                    <select className={`${inputClass} bg-white cursor-pointer`} value={selectedSelloId} onChange={handleSelloSelect}>
                                        {SELLOS_DATA.map(sello => <option key={sello.id} value={sello.id}>{sello.label}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-3">
                                    {/* NOMBRE DOCTOR + BOTÓN */}
                                    <div><Label>Nombre del Doctor(a)</Label><div className="flex gap-1"><input className={inputClass} placeholder="Nombre Dr(a)." value={data.medico.nombre} onChange={e=>handleChange('medico','nombre',e.target.value)} /><GenBtn onClick={genDoctorName} /></div></div>
                                    
                                    <div><Label>Especialidad / Tipo</Label><input className={`${inputClass} bg-slate-50 text-slate-500`} placeholder="Tipo de Médico" value={data.medico.tipo} onChange={e=>handleChange('medico','tipo',e.target.value)} /></div>
                                    
                                    {/* UNIVERSIDAD + BOTÓN (CON LISTA DE 100 REALES) */}
                                    <div><Label>Universidad</Label><div className="flex gap-1"><input className={inputClass} placeholder="Universidad" value={data.medico.uni} onChange={e=>handleChange('medico','uni',e.target.value)} /><GenBtn onClick={genUniversity} /></div></div>
                                    
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><Label>Cédula Profesional</Label><div className="flex gap-1"><input className={inputClass} value={data.medico.cedula} onChange={e=>handleChange('medico','cedula',e.target.value)} /><GenBtn onClick={genCedula} /></div></div>
                                        <div><Label>Matrícula</Label><div className="flex gap-1"><input className={inputClass} value={data.medico.matricula} onChange={e=>handleChange('medico','matricula',e.target.value)} /><GenBtn onClick={genMatricula} /></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* VISTA PREVIA (DERECHA) */}
                    <div className="w-full lg:w-2/3 bg-slate-200 flex justify-center items-start p-4 print-area overflow-auto">
                        <div className="paper bg-white w-[21.59cm] min-h-[13.97cm] p-8 relative text-black shadow-2xl">
                             <div className="flex justify-between items-start">
                                <div className="w-[55%] pr-2">
                                    <div className="flex flex-col items-center mb-1"><img src={logoUrl} className="h-10 w-auto mb-1 opacity-90" alt="Logo" /><h1 className="text-[10px] font-bold tracking-wide text-center leading-none">INSTITUTO MEXICANO DEL SEGURO SOCIAL</h1><p className="text-[5px] font-bold tracking-[0.2em] text-gray-500 mt-0.5 uppercase">Seguridad y Solidaridad Social</p></div>
                                    <div className="w-full border-t border-b border-gray-400 py-0.5 my-2 text-center text-[7px] uppercase">Dirección de Prestaciones Médicas</div>
                                    <div className="text-center mb-2"><h2 className="text-xl font-bold font-[Tinos] uppercase tracking-wide">Receta Individual</h2></div>
                                    <div className="relative h-12 mt-2 mb-2 w-full"><div className="absolute left-1/2 -translate-x-1/2 top-0"><div className="barcode"></div></div><div className="absolute -right-40 top-8"><div className="text-left leading-[1.1] font-sans"><div className="text-base font-bold text-gray-900 mb-0.5 whitespace-nowrap">Folio: <span className="text-black text-base font-black tracking-tight ml-1">{data.meta.folio}</span></div><div className="text-[11px] font-bold text-black uppercase max-w-[220px]">ESTA RECETA NO SE SURTIRÁ DESPUÉS DE LAS 72 HORAS DE SU EXPEDICIÓN</div></div></div></div>
                                </div>
                                <div className="w-[45%] pl-2 pt-2 relative">
                                    <div className="double-box pt-box w-full -mt-6"><div className="flex justify-between mb-2"><div><span className="pt-label">NSS:</span><span className="pt-val">{data.paciente.nss}</span></div><div><span className="pt-label">AGREGADO. MED:</span><span className="pt-val">{data.paciente.agregado}</span></div></div><div className="text-center mb-2"><span className="pt-label block w-full mb-px">NOMBRE DEL PACIENTE:</span><div className="pt-val uppercase">{data.paciente.nombre}</div></div><div className="mb-0.5"><span className="pt-label">CURP:</span><span className="pt-val">{data.paciente.curp}</span></div><div className="mb-0.5"><span className="pt-label">SEXO:</span><span className="pt-val">{data.paciente.sexo}</span></div><div className="mb-0.5"><span className="pt-label">FECHA DE NACIMIENTO:</span><span className="pt-val">{data.paciente.fechaNac}</span></div><div className="mb-0.5"><span className="pt-label">DELEGACION:</span><span className="pt-val">{data.paciente.delegacion}</span></div><div className="flex justify-between mb-0.5"><div className="flex gap-2"><div><span className="pt-label">UMP:</span><span className="pt-val">{data.paciente.ump}</span></div><div><span className="pt-label">CONSULTORIO:</span><span className="pt-val">{data.paciente.consultorio}</span></div></div></div><div className="flex justify-end"><div className="text-left"><div><span className="pt-label">CVE.PTAL</span><span className="pt-val">{data.paciente.cve}</span></div><div><span className="pt-label">TURNO:</span><span className="pt-val">{data.paciente.turno}</span></div></div></div></div>
                                    <img src={qrCode} className="absolute -bottom-20 right-20 w-14 h-14" alt="QR" />
                                </div>
                            </div>

                            <div className="double-box min-h-[500px] flex flex-col relative mt-12">
                                <div className="flex justify-between items-center px-2 pt-1 text-[10px] font-bold uppercase"><div>FECHA: {data.meta.fecha}</div><div>Primer Nivel de Atención</div></div>
                                <div className="border-b border-black w-auto mx-4 mb-1"></div>
                                <div className="p-2 flex-grow">
                                    {data.medicamentos.map(m => (<div key={m.id} className="med-item text-[10px] leading-snug mb-6"><div className="font-bold text-black px-1 mb-0.5">{m.text}</div><div className="border-b border-black w-auto mx-4 mb-1"></div><div className="pl-1 whitespace-pre-wrap">{m.ind}</div></div>))}
                                    {data.meta.indicaciones && (<div className="text-[10px] leading-snug whitespace-pre-wrap mt-4 font-bold px-1">{data.meta.indicaciones}</div>)}
                                </div>
                                
                                <div className="border-t border-black mt-auto bg-white relative">
                                    <div className="pt-3 px-4 flex text-[9px] items-start relative z-20">
                                        <div className="w-[55%] pr-2 relative"><div className="flex flex-col items-start relative"><span className="font-bold mb-0.5 leading-none">Nombre y firma del médico: {data.medico.nombre}</span><span className="font-bold uppercase leading-tight text-[8px] w-full">{data.medico.uni}</span></div></div>
                                        <div className="w-[45%] flex justify-between items-start pl-4"><div className="flex flex-col items-start"><span className="font-bold mb-1 leading-none">Cédula Profesional:</span><span className="font-[Arimo] font-bold leading-none">{data.medico.cedula}</span></div><div className="flex flex-col items-end"><span className="font-bold mb-1 leading-none">Matrícula:</span><span className="font-[Arimo] font-bold leading-none">{data.medico.matricula}</span></div></div>
                                    </div>
                                    <div className="doctor-stamp-base absolute z-30" style={{ ...activeSello.style, ...activeSello.position }}>
                                        <img src={logoUrl} className="stamp-logo" alt="Sello" style={{ filter: activeSello.style.color !== '#003366' ? 'grayscale(100%) brightness(30%) contrast(150%)' : undefined }} />
                                        <div className="text-left text-[8px]"><div>DR(A). {data.medico.nombre}</div><div>{data.medico.tipo}</div><div>CED. PROF. {data.medico.cedula}</div><div>MATRICULA {data.medico.matricula}</div></div>
                                    </div>
                                    <div className="border-b border-black w-auto mx-4 mt-1 mb-1 relative z-10"></div>
                                    <div className="h-20 w-full bg-white relative z-0 flex flex-col items-end justify-start px-4"><span className="font-bold text-[9px] uppercase mt-1">PACIENTE</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
                                // ==========================================
        // NUEVO COMPONENTE: EDITOR FARMACIA DEL AHORRO (V4 - FECHA AUTOMÁTICA Y DOCTORES ÚNICOS)
        // ==========================================
        const FarmaciaEditor = ({ onBack }) => {
            
            // --- GENERADOR DE DATOS DE DOCTORES (LÓGICA ANTERIOR) ---
            const GENERAR_DOCTORES = () => {
                const nombresHombres = [
                    "JUAN CARLOS PÉREZ GÓMEZ", "LUIS ANTONIO GARCÍA MARTÍNEZ", "MIGUEL ÁNGEL RODRÍGUEZ LÓPEZ", "JOSÉ LUIS HERNÁNDEZ GONZÁLEZ", "CARLOS EDUARDO MARTÍNEZ SÁNCHEZ",
                    "JORGE ALBERTO SÁNCHEZ PÉREZ", "JESÚS MANUEL RAMÍREZ CRUZ", "FRANCISCO JAVIER FLORES GÓMEZ", "RAÚL ALEJANDRO TORRES VÁZQUEZ", "ROBERTO CARLOS RUIZ DÍAZ",
                    "DANIEL ALONSO MENDOZA GUTIÉRREZ", "EDUARDO JAVIER CASTRO ORTEGA", "SERGIO IVÁN VARGAS ROMERO", "ALEJANDRO DAVID MORALES JIMÉNEZ", "FERNANDO JOSÉ ORTIZ RUIZ",
                    "RICARDO ANDRÉS SILVA NAVARRO", "HÉCTOR MANUEL RAMOS CASTILLO", "GABRIEL OMAR MEDINA SALAZAR", "MARTÍN ELÍAS ROJAS AGUILAR", "PEDRO ANTONIO VEGA CÁRDENAS",
                    "MANUEL ALEJANDRO CAMPOS LUNA", "JAVIER EDUARDO CRUZ SALGADO", "ALBERTO JOSÉ REYES MARÍN", "DIEGO ARMANDO SOTO DOMÍNGUEZ", "ADRIÁN ARTURO PACHECO RIVERA",
                    "MARIO ALBERTO GUERRERO SERRANO", "JULIO CÉSAR VALENZUELA MEZA", "PABLO EMILIO CORTÉS IBARRA", "ÓSCAR IVÁN ESPINOZA ROSALES", "ANDRÉS FELIPE OROZCO BELTRÁN",
                    "RUBÉN DARÍO MONTES QUIROZ", "VÍCTOR HUGO CUEVAS GALLEGOS", "CÉSAR AUGUSTO PADILLA ZAMORA", "IVÁN LEONARDO SALAS VILLALOBOS", "HUGO ERNESTO RÍOS BARRERA",
                    "EDGAR ULISES MACÍAS ESCOBAR", "ARTURO ELÍAS ZÚÑIGA CORREA", "ALFREDO RAFAEL TOVAR VILLEGAS", "ENRIQUE ALONSO GALLARDO LARA", "FELIPE DE JESÚS NAVA PERALTA",
                    "GUSTAVO ADOLFO DELGADO CERVANTES", "IGNACIO MANUEL BERNAL OCHOA", "JOAQUÍN ANDRÉS SOLÍS ARROYO", "LEONARDO FABIÁN ACUÑA FIGUEROA", "MAURICIO ALEJANDRO CANO VALDEZ",
                    "NORBERTO ELÍAS TREJO MALDONADO", "ORLANDO JAVIER URBINA CORONA", "PATRICIO DANIEL VERA BUSTOS", "RODRIGO EMANUEL ZAVALA PINEDA", "SAÚL ERNESTO ALCARAZ MONTOYA"
                ];

                const nombresMujeres = [
                    "MARÍA FERNANDA LÓPEZ RUIZ", "ANA SOFÍA HERNÁNDEZ DÍAZ", "CARLA DANIELA GARCÍA PÉREZ", "ADRIANA MARÍA MARTÍNEZ SÁNCHEZ", "BEATRIZ ELENA GONZÁLEZ RODRÍGUEZ",
                    "CARMEN LUCÍA PÉREZ GÓMEZ", "DIANA CAROLINA RAMÍREZ CRUZ", "ELIZABETH VICTORIA FLORES TORRES", "FÁTIMA GUADALUPE TORRES VÁZQUEZ", "GABRIELA ALEJANDRA RUIZ MENDOZA",
                    "HILDA MARIANA CASTRO ORTEGA", "ISABEL CRISTINA VARGAS ROMERO", "JESSICA PAOLA MORALES JIMÉNEZ", "KARLA VANESSA ORTIZ SILVA", "LAURA PATRICIA RAMOS CASTILLO",
                    "MÓNICA LIZBETH MEDINA SALAZAR", "NATALIA SOFÍA ROJAS AGUILAR", "OLIVIA MARGARITA VEGA CÁRDENAS", "PAOLA ANDREA CAMPOS LUNA", "QUETZALLI YASMIN CRUZ SALGADO",
                    "REBECA ABIGAIL REYES MARÍN", "SANDRA LUZ SOTO DOMÍNGUEZ", "TERESA DE JESÚS PACHECO RIVERA", "URSULA MARIANA GUERRERO SERRANO", "VERÓNICA CECILIA VALENZUELA MEZA",
                    "WENDY NAYELI CORTÉS IBARRA", "XIMENA ALESSANDRA ESPINOZA ROSALES", "YOLANDA BEATRIZ OROZCO BELTRÁN", "ZULEMA KARINA MONTES QUIROZ", "ALMA DELIA CUEVAS GALLEGOS",
                    "BLANCA ESTELA PADILLA ZAMORA", "CLAUDIA IVETTE SALAS VILLALOBOS", "DANIELA MICHELLE RÍOS BARRERA", "ELENA SOFÍA MACÍAS ESCOBAR", "FABIOLA JANET ZÚÑIGA CORREA",
                    "GLORIA ESTEFANÍA TOVAR VILLEGAS", "HAYDEE MARISOL GALLARDO LARA", "IRENE GUADALUPE NAVA PERALTA", "JULIA MERCEDES DELGADO CERVANTES", "KAREN LIZETH BERNAL OCHOA",
                    "LETICIA MARIBEL SOLÍS ARROYO", "MARGARITA ROSA ACUÑA FIGUEROA", "NANCY GABRIELA CANO VALDEZ", "OFELIA ISABEL TREJO MALDONADO", "PATRICIA ELENA URBINA CORONA",
                    "ROCÍO ALEJANDRA VERA BUSTOS", "SILVIA FERNANDA ZAVALA PINEDA", "TANIA IVONNE ALCARAZ MONTOYA", "VALERIA JUDITH MEJÍA CORDERO", "YESSICA PAOLA LARA ZAMUDIO"
                ];

                const universidades = [
                    { uni: "UNIVERSIDAD NACIONAL AUTÓNOMA DE MÉXICO", dir: "AV. UNIVERSIDAD 3000, COPILCO EL ALTO\nCOYOACÁN, 04510 CIUDAD DE MÉXICO, CDMX" },
                    { uni: "INSTITUTO POLITÉCNICO NACIONAL", dir: "AV. WILFRIDO MASSIEU S/N, LINDAVISTA\nGUSTAVO A. MADERO, 07738 CIUDAD DE MÉXICO, CDMX" },
                    { uni: "BENEMÉRITA UNIVERSIDAD AUTÓNOMA DE PUEBLA", dir: "C. 16 DE SEPTIEMBRE 13323-LOCAL A, AMPLIACIÓN\nGUADALUPE HIDALGO, 72470 PUEBLA, PUE." },
                    { uni: "UNIVERSIDAD DE GUADALAJARA", dir: "AV. JUÁREZ 976, COL. CENTRO\nGUADALAJARA, 44100 GUADALAJARA, JAL." },
                    { uni: "UNIVERSIDAD AUTÓNOMA DE NUEVO LEÓN", dir: "AV. UNIVERSIDAD S/N, CIUDAD UNIVERSITARIA\nSAN NICOLÁS DE LOS GARZA, 66455 NUEVO LEÓN" },
                    { uni: "UNIVERSIDAD VERACRUZANA", dir: "LOMAS DEL ESTADIO S/N, ZONA UNIVERSITARIA\nXALAPA-ENRÍQUEZ, 91000 XALAPA, VER." },
                    { uni: "UNIVERSIDAD AUTÓNOMA DEL ESTADO DE MÉXICO", dir: "PASEO TOLLOCAN ESQ. JESÚS CARRANZA\nMODERNA DE LA CRUZ, 50180 TOLUCA, MÉX." },
                    { uni: "UNIVERSIDAD AUTÓNOMA DE QUERÉTARO", dir: "CERRO DE LAS CAMPANAS S/N, LAS CAMPANAS\nSANTIAGO DE QUERÉTARO, 76010 QUERÉTARO, QRO." },
                    { uni: "UNIVERSIDAD AUTÓNOMA DE YUCATÁN", dir: "CALLE 60 491-A, CENTRO\nMÉRIDA, 97000 MÉRIDA, YUC." },
                    { uni: "UNIVERSIDAD DE GUANAJUATO", dir: "LASCURÁIN DE RETANA 5, CENTRO\nGUANAJUATO, 36000 GUANAJUATO, GTO." }
                ];

                const especialidades = ["MÉDICO CIRUJANO", "MÉDICO CIRUJANO Y PARTERO", "MÉDICO GENERAL", "ESPECIALISTA EN MEDICINA FAMILIAR"];

                const generarDatos = (nombre, prefijo) => {
                    const uniObj = universidades[Math.floor(Math.random() * universidades.length)];
                    const cedula = Math.floor(1000000 + Math.random() * 9000000).toString();
                    return {
                        nombre: `${prefijo} ${nombre}`,
                        tipo: especialidades[Math.floor(Math.random() * especialidades.length)],
                        cedula: cedula,
                        uni: `${uniObj.uni}\n${uniObj.dir}`
                    };
                };

                const doctores = [
                    ...nombresHombres.map(n => generarDatos(n, "DR.")),
                    ...nombresMujeres.map(n => generarDatos(n, "DRA."))
                ];

                return doctores.sort(() => Math.random() - 0.5);
            };

            const DOCTORES_DATA = React.useMemo(() => GENERAR_DOCTORES(), []);

            // --- ESTADO INICIAL CON FECHA DE HOY ---
            const [data, setData] = useState(() => {
                // Calcular fecha de hoy al iniciar
                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0'); // Enero es 0
                const yyyy = today.getFullYear();
                const fechaHoy = `${dd}/${mm}/${yyyy}`;

                return {
                    paciente: {
                        nombre: 'KEMBERLY FERNANDA ORONA MUÑOZ',
                        edad: '17', peso: '78.600', talla: '1.70', temp: '36.5',
                        fecha: fechaHoy // <--- AQUÍ SE ASIGNA LA FECHA ACTUAL AUTOMÁTICAMENTE
                    },
                    medico: { 
                        nombre: '', 
                        tipo: '', 
                        cedula: '', 
                        uni: '' 
                    },
                    medicamentos: [
                        { id: 1, text: 'LORATADINA / AMBROXOL SOLUCIÓN 5MG/30MG', ind: 'TOMAR 7.5 ML. CADA 8 HORAS DURANTE 5 DÍAS VÍA DE ADMINISTRACIÓN ORAL' },
                        { id: 2, text: 'DEXTROMETORFANO HIDROBOMURO SOLUCIÓN 2MG/ML', ind: 'TOMAR 5 ML. CADA 12 HORAS DURANTE 3 DÍAS VÍA DE ADMINISTRACIÓN ORAL' },
                        { id: 3, text: 'DICLOFENACO TABLETAS 100MG', ind: 'TOMAR 1 TABLETA CADA 8 HORAS DURANTE 3 DÍAS VÍA DE ADMINISTRACIÓN ORAL' }
                    ]
                };
            });

            // Función para seleccionar un doctor aleatorio
            const seleccionarDoctorAleatorio = () => {
                const doctor = DOCTORES_DATA[Math.floor(Math.random() * DOCTORES_DATA.length)];
                setData(prev => ({
                    ...prev,
                    medico: {
                        nombre: doctor.nombre,
                        tipo: doctor.tipo,
                        cedula: doctor.cedula,
                        uni: doctor.uni
                    }
                }));
            };

            // Efecto para rellenar automáticamente el doctor al abrir
            useEffect(() => {
                seleccionarDoctorAleatorio();
            }, []);

            const handleChange = (section, field, val) => setData(p => ({...p, [section]: {...p[section], [field]: val.toUpperCase()}}));
            const handleMed = (id, field, val) => setData(p => ({...p, medicamentos: p.medicamentos.map(m => m.id===id ? {...m, [field]: val.toUpperCase()} : m)}));
            const addMed = () => setData(p => ({...p, medicamentos: [...p.medicamentos, {id: Date.now(), text: '', ind: ''}]}));
            const delMed = (id) => setData(p => ({...p, medicamentos: p.medicamentos.filter(m => m.id !== id)}));

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-slate-100 font-sans">
                    {/* --- PANEL DE EDICIÓN IZQUIERDO --- */}
                    <div className="w-full lg:w-1/3 bg-white border-r border-slate-200 p-5 no-print h-screen overflow-y-auto z-20 shadow-xl">
                        <div className="mb-4 flex items-center justify-between">
                            <button onClick={onBack} className="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-[#1d428a] transition"><i data-lucide="arrow-left" className="w-4 h-4"></i> Volver</button>
                            <button onClick={() => window.print()} className="bg-[#1d428a] text-white px-4 py-2 rounded-full font-bold text-xs shadow hover:bg-blue-900 flex items-center gap-2"><i data-lucide="printer" className="w-3 h-3"></i> IMPRIMIR</button>
                        </div>
                        <div className="space-y-5">
                            {/* PACIENTE */}
                            <div className="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                                <div className="font-black text-xs text-[#1d428a] uppercase tracking-widest mb-3 border-b border-blue-200 pb-1">Datos Paciente</div>
                                
                                <label className="block text-[10px] font-bold text-slate-500 mb-1">NOMBRE COMPLETO</label>
                                <input className="w-full border p-2 rounded text-xs font-bold uppercase mb-2" placeholder="NOMBRE COMPLETO DEL PACIENTE" value={data.paciente.nombre} onChange={e=>handleChange('paciente','nombre',e.target.value)} />
                                
                                <div className="grid grid-cols-2 gap-2">
                                    <div><label className="block text-[10px] font-bold text-slate-500 mb-1">EDAD</label><input className="w-full border p-2 rounded text-xs uppercase" placeholder="EJ. 25" value={data.paciente.edad} onChange={e=>handleChange('paciente','edad',e.target.value)} /></div>
                                    <div><label className="block text-[10px] font-bold text-slate-500 mb-1">PESO (KG)</label><input className="w-full border p-2 rounded text-xs uppercase" placeholder="EJ. 70.5" value={data.paciente.peso} onChange={e=>handleChange('paciente','peso',e.target.value)} /></div>
                                    <div><label className="block text-[10px] font-bold text-slate-500 mb-1">TALLA (MTS)</label><input className="w-full border p-2 rounded text-xs uppercase" placeholder="EJ. 1.75" value={data.paciente.talla} onChange={e=>handleChange('paciente','talla',e.target.value)} /></div>
                                    <div><label className="block text-[10px] font-bold text-slate-500 mb-1">TEMP</label><input className="w-full border p-2 rounded text-xs uppercase" placeholder="EJ. 36.5" value={data.paciente.temp} onChange={e=>handleChange('paciente','temp',e.target.value)} /></div>
                                </div>
                                <div className="mt-2">
                                    <label className="block text-[10px] font-bold text-[#1d428a] mb-1">FECHA DE CONSULTA</label>
                                    <input className="w-full border p-2 rounded text-xs font-bold uppercase" placeholder="DD/MM/AAAA" value={data.paciente.fecha} onChange={e=>handleChange('paciente','fecha',e.target.value)} />
                                </div>
                            </div>
                            {/* MEDICAMENTOS */}
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <div className="flex justify-between items-center mb-3"><div className="font-black text-xs text-slate-500 uppercase">Tratamiento</div><button onClick={addMed} className="bg-[#1d428a] text-white text-[10px] font-bold px-2 py-1 rounded">+ ITEM</button></div>
                                {data.medicamentos.map((m, i) => (
                                    <div key={m.id} className="mb-4 border-b pb-2">
                                        <div className="flex justify-between mb-1"><span className="text-[9px] font-bold text-slate-400">ITEM #{i+1}</span><button onClick={()=>delMed(m.id)} className="text-red-500 text-[9px]">BORRAR</button></div>
                                        
                                        <label className="block text-[9px] font-bold text-slate-400 mb-0.5">NOMBRE DEL MEDICAMENTO</label>
                                        <input className="w-full border mb-2 text-xs font-bold uppercase px-2 py-1 rounded" placeholder="NOMBRE Y GRAMAJE DEL MEDICAMENTO" value={m.text} onChange={e=>handleMed(m.id,'text',e.target.value)} />
                                        
                                        <label className="block text-[9px] font-bold text-slate-400 mb-0.5">INDICACIONES / DOSIS</label>
                                        <textarea className="w-full bg-slate-50 border px-2 py-1 text-[10px] uppercase resize-none h-14 rounded" placeholder="INDICACIONES COMPLETAS DE TOMA" value={m.ind} onChange={e=>handleMed(m.id,'ind',e.target.value)}></textarea>
                                    </div>
                                ))}
                            </div>
                            
                            {/* --- DATOS MÉDICO (CON GENERACIÓN COMPLETA) --- */}
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <div className="font-black text-xs text-[#1d428a] uppercase tracking-widest mb-3">Datos Médico</div>
                                
                                <label className="block text-[10px] font-bold text-slate-500 mb-1">NOMBRE DEL DOCTOR(A)</label>
                                <div className="flex gap-1 mb-2">
                                    <input 
                                        className="w-full border p-2 rounded text-xs font-bold uppercase" 
                                        placeholder="NOMBRE COMPLETO DEL MÉDICO" 
                                        value={data.medico.nombre} 
                                        onChange={e=>handleChange('medico','nombre',e.target.value)} 
                                    />
                                    <button 
                                        onClick={seleccionarDoctorAleatorio} 
                                        className="bg-slate-100 hover:bg-indigo-100 text-slate-500 hover:text-indigo-600 border border-slate-200 rounded-lg px-3 transition active:scale-95 flex items-center justify-center" 
                                        title="Generar Doctor Aleatorio (Datos Completos)"
                                    >
                                        🔄
                                    </button>
                                </div>
                                
                                <label className="block text-[10px] font-bold text-slate-500 mb-1">ESPECIALIDAD / TIPO</label>
                                <input className="w-full border p-2 rounded text-xs uppercase mb-2" placeholder="EJ. MÉDICO CIRUJANO" value={data.medico.tipo} onChange={e=>handleChange('medico','tipo',e.target.value)} />
                                
                                <label className="block text-[10px] font-bold text-slate-500 mb-1">CÉDULA PROFESIONAL</label>
                                <input className="w-full border p-2 rounded text-xs uppercase mb-2" placeholder="NÚMERO DE CÉDULA" value={data.medico.cedula} onChange={e=>handleChange('medico','cedula',e.target.value)} />
                                
                                <label className="block text-[10px] font-bold text-slate-500 mb-1">UNIVERSIDAD / DIRECCIÓN</label>
                                <textarea className="w-full border p-2 rounded text-xs uppercase h-20" placeholder="NOMBRE DE UNIVERSIDAD Y DIRECCIÓN COMPLETA" value={data.medico.uni} onChange={e=>handleChange('medico','uni',e.target.value)}></textarea>
                            </div>
                        </div>
                    </div>

                    {/* --- VISTA PREVIA DERECHA --- */}
                    <div className="w-full lg:w-2/3 bg-white flex justify-center items-start p-4 print-area overflow-auto">
                        <div className="bg-white w-[21.59cm] min-h-[27.94cm] relative px-12 pb-60 pt-6 font-sans text-[#1d428a] overflow-hidden shadow-none flex flex-col">
                            
                            {/* MARCA DE AGUA */}
                            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[92%] h-auto z-0 pointer-events-none flex justify-center items-center">
                                <img src="https://i.postimg.cc/6qjsDrMx/1770333114747.png" alt="Marca de Agua" className="w-full h-auto object-contain brightness-125 saturate-150 opacity-[0.15] mix-blend-multiply" />
                            </div>

                            {/* ENCABEZADO */}
                            <div className="flex justify-between items-start mb-8 relative z-10">
                                <div className="w-[30%] pt-0">
                                    <img src="https://i.postimg.cc/wvY9VQGh/logo-Farmacia-del-ahorro.webp" alt="Logo Farmacia del Ahorro" className="w-full h-auto object-contain" />
                                    <div className="w-full h-[2.5px] bg-[#a01d2d] mt-4"></div>
                                </div>

                                <div className="w-[70%] flex flex-col items-center justify-start pt-1 text-[#1d428a] pl-10">
                                    <div className="text-[26px] font-black leading-[0.9] mb-1.5 text-center w-full uppercase tracking-tight">
                                        {data.medico.nombre}
                                    </div>
                                    <div className="text-[18px] font-bold leading-none mb-1 text-center w-full uppercase">
                                        {data.medico.tipo}
                                    </div>
                                    <div className="text-[18px] font-bold leading-none mb-1 text-center w-full uppercase">
                                        CED. PROF. {data.medico.cedula}
                                    </div>
                                    <div className="text-[13px] font-bold leading-tight text-center w-full whitespace-pre-wrap uppercase tracking-tight">
                                        {data.medico.uni}
                                    </div>
                                </div>
                            </div>

                            {/* DATOS PACIENTE */}
                            <div className="mb-8 relative z-10 text-[12px] uppercase mt-4">
                                <div className="flex items-baseline mb-6">
                                    <span className="text-[#1d428a] font-black mr-2 text-[13px]">NOMBRE DEL PACIENTE:</span>
                                    <span className="text-[#444] font-medium text-[13px]">{data.paciente.nombre}</span>
                                </div>
                                <div className="flex justify-between items-center w-full">
                                    <div className="flex gap-6">
                                        <span className="flex items-baseline"><span className="text-[#1d428a] font-black mr-1">EDAD:</span><span className="text-[#444] font-medium">{data.paciente.edad}</span></span>
                                        <span className="flex items-baseline"><span className="text-[#1d428a] font-black mr-1">PESO:</span><span className="text-[#444] font-medium">{data.paciente.peso} KG</span></span>
                                        <span className="flex items-baseline"><span className="text-[#1d428a] font-black mr-1">TALLA:</span><span className="text-[#444] font-medium">{data.paciente.talla}</span></span>
                                        <span className="flex items-baseline"><span className="text-[#1d428a] font-black mr-1">TEMPERATURA:</span><span className="text-[#444] font-medium">{data.paciente.temp}</span></span>
                                    </div>
                                    <div className="flex items-baseline">
                                        <span className="text-[#1d428a] font-black mr-2">FECHA:</span><span className="text-[#444] font-medium">{data.paciente.fecha}</span>
                                    </div>
                                </div>
                            </div>

                            {/* TRATAMIENTO */}
                            <div className="relative z-10 flex-grow px-2 mt-4">
                                <div className="text-[#1d428a] font-black text-[13px] mb-6 uppercase">TRATAMIENTO:</div>
                                <div className="space-y-6">
                                    {data.medicamentos.map((m, i) => (
                                        <div key={i} className="text-[12px] leading-relaxed">
                                            <div className="font-bold text-black uppercase mb-1">{i+1}.- {m.text}</div>
                                            <div className="text-black uppercase pl-0 font-medium">{m.ind}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* PIE DE PÁGINA */}
                            <div className="mt-auto relative z-10 pt-4 w-full">
                                <div className="w-full h-[3px] bg-[#a01d2d] mb-2"></div>
                                <div className="text-[#1d428a] font-bold text-[12px] text-center uppercase mb-24 tracking-wide">
                                    SÚRTASE CON ESTA RECETA EN CUALQUIER SUCURSAL DE FARMACIAS DEL AHORRO
                                </div>
                                <div className="flex justify-center relative">
                                    <div className="w-64 text-center">
                                        <div className="border-t-[2px] border-[#1d428a] pt-2">
                                            <span className="text-[#1d428a] font-black text-[12px] uppercase tracking-wider">FIRMA</span>
                                        </div>
                                    </div>                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };



        
                                                                                                        // ==========================================
        // COMPONENTE: PANEL DE ADMINISTRACIÓN (V23 - ACTUALIZADO CON EDITOR DE HORARIOS/MUESTRAS)
        // ==========================================
        const AdminPanel = ({ onBack }) => {
            const [section, setSection] = useState('menu');
            
            // --- ESTADOS DE DATOS ---
            const [requests, setRequests] = useState([]);
            const [orders, setOrders] = useState([]);
            const [stockList, setStockList] = useState([]);
            const [usersList, setUsersList] = useState([]);
            const [anuncios, setAnuncios] = useState([]); 
            
            // --- ESTADOS DE CARGA ---
            const [loadingRequests, setLoadingRequests] = useState(true);
            const [loadingOrders, setLoadingOrders] = useState(true);
            const [loadingStock, setLoadingStock] = useState(true);
            const [loadingUsers, setLoadingUsers] = useState(true);

            // --- ESTADOS MODALES Y EDICIÓN ---
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [historyModalOpen, setHistoryModalOpen] = useState(false);
            const [isDetailsOpen, setIsDetailsOpen] = useState(false);
            const [selectedOrderDetails, setSelectedOrderDetails] = useState(null);
            const [selectedUserHistory, setSelectedUserHistory] = useState({ user: null, compras: [], recargas: [], loading: false });

            // --- ESTADOS EDICIÓN STOCK ---
            const [editingId, setEditingId] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [newService, setNewService] = useState({ title: '', category: '', price: '', time: '', isNew: false, fields: [] });

            // --- NUEVOS ESTADOS PARA ANUNCIOS ---
            const [newAnuncio, setNewAnuncio] = useState("");
            const [editingAnuncioId, setEditingAnuncioId] = useState(null);

            // --- NUEVOS ESTADOS PARA CONFIGURACIÓN DE SERVICIOS (HORARIOS/MUESTRAS) ---
            const [isConfigModalOpen, setIsConfigModalOpen] = useState(false);
            const [editingConfigId, setEditingConfigId] = useState(null);
            const [configForm, setConfigForm] = useState({
                title: '',
                availabilityText: '',
                warningText: '',
                sampleUrl: ''
            });

            // --- LISTA DE CAMPOS DISPONIBLES ---
            const availableFields = [
                "Nombre Completo", "Curp", "NSS", "Agregado Medico", "Delegación", "UMP", "Consultorio", "Turno", "Fecha (Texto Completo)",
                "Clave Presupuestal (Cve Ptal)", "Nombre del Doctor(a)", "Especialidad / Tipo", "Cédula Profesional", "Matrícula", "Universidad",
                "Medicamento #1 (Nombre / Clave)", "Medicamento #1 (Indicaciones / Dosis)",
                "Medicamento #2 (Nombre / Clave)", "Medicamento #2 (Indicaciones / Dosis)",
                "Medicamento #3 (Nombre / Clave)", "Medicamento #3 (Indicaciones / Dosis)",
                "Indicaciones Médicas Generales", "Folio de Receta",
                "Apellido Paterno", "Apellido Materno", "Fecha Nacimiento", 
                "Domicilio", "Clave de Elector", "Número de servicio CFE", "Placa", "Año a pagar", 
                "Número de serie", "Número de motor", "Marca", "Modelo", "Línea", "Color", 
                "Nombre del dueño/conductor", "Dirección", "RFC", "Idcif", "Fecha de emisión", "Sexo", 
                "1 Medicamento", "2 Medicamento", "3 Medicamento", "4 Medicamento", "Indicaciones Médicas", 
                "Nombre del medico", "De que se enfermo"
            ];

            const Icon = ({ name, className }) => (
                <span 
                    dangerouslySetInnerHTML={{__html: `<i data-lucide="${name}" class="${className || ''}"></i>`}} 
                    style={{display: 'inline-flex', alignItems: 'center', justifyContent: 'center'}}
                />
            );

            // 1. MOTOR DE ICONOS
            useEffect(() => {
                const timer = setTimeout(() => {
                    if(window.lucide) window.lucide.createIcons();
                }, 100);
                return () => clearTimeout(timer);
            }, [section, requests, stockList, orders, usersList, anuncios, isModalOpen, isConfigModalOpen]);

            // 2. CARGA DE DATOS
            useEffect(() => {
                const unsub1 = db.collection('recargas').where('status', '==', 'pendiente').onSnapshot(s => { setRequests(s.docs.map(d => ({id:d.id,...d.data()})).sort((a,b)=>(b.fecha?.seconds||0)-(a.fecha?.seconds||0))); setLoadingRequests(false); });
                const unsub2 = db.collection('servicios').onSnapshot(s => { setStockList(s.docs.map(d => ({id:d.id,...d.data()})).sort((a,b)=>(a.title||"").localeCompare(b.title||""))); setLoadingStock(false); });
                const unsub3 = db.collection('solicitudes_servicios').where('status', '==', 'pendiente').onSnapshot(s => { setOrders(s.docs.map(d => ({id:d.id,...d.data()})).sort((a,b)=>(b.date?.seconds||0)-(a.date?.seconds||0))); setLoadingOrders(false); });
                const unsub4 = db.collection('usuarios').onSnapshot(s => { setUsersList(s.docs.map(d => ({id:d.id,...d.data()}))); setLoadingUsers(false); });
                const unsub5 = db.collection('anuncios').orderBy('fecha', 'desc').onSnapshot(s => { setAnuncios(s.docs.map(d => ({id:d.id,...d.data()}))); }); 
                return () => { unsub1(); unsub2(); unsub3(); unsub4(); unsub5(); };
            }, []);

            // --- FUNCIONES LÓGICAS ---
            const handleProcessRecarga = async (req, approved) => {
                if(!confirm(approved?"¿Aprobar?":"¿Rechazar?")) return;
                try {
                    const batch = db.batch();
                    batch.update(db.collection('recargas').doc(req.id), {status: approved?'aprobado':'rechazado', fechaProceso: new Date()});
                    if(approved && req.userId) batch.update(db.collection('usuarios').doc(req.userId), {saldo: firebase.firestore.FieldValue.increment(Number(req.monto||0))});
                    await batch.commit();
                } catch(e) { alert(e.message); }
            };

            const handleAttachLink = async (id, current) => {
                const link = prompt("Link:", current||""); if(link===null) return;
                try { await db.collection('solicitudes_servicios').doc(id).update({downloadUrl: link}); alert("✅ Link guardado"); } catch(e){alert(e.message);}
            };

            const handleCompleteOrder = async (id, hasLink) => {
                if(!hasLink && !confirm("Sin link. ¿Seguir?")) return; if(hasLink && !confirm("¿Entregar?")) return;
                try { await db.collection('solicitudes_servicios').doc(id).update({status:'completado', fechaCompletado: new Date()}); } catch(e){alert(e.message);}
            };

            const handleViewData = (order) => { setSelectedOrderDetails(order); setIsDetailsOpen(true); };

            // LOGICA STOCK
            const handleSaveService = async (e) => {
                e.preventDefault(); setIsSaving(true);
                try {
                    if(editingId) await db.collection('servicios').doc(editingId).update(newService);
                    else await db.collection('servicios').add({...newService, createdAt: new Date(), active: true});
                    setIsModalOpen(false); setEditingId(null); alert("✅ Guardado");
                } catch(e){alert(e.message);} finally{setIsSaving(false);}
            };
            const handleDeleteService = async (id) => { if(confirm("¿Eliminar?")) db.collection('servicios').doc(id).delete(); };
            const handleToggleActive = async (s) => db.collection('servicios').doc(s.id).update({active: !(s.active!==false)});
            const openModal = (s) => {
                if(s) { setNewService({ title:s.title||'', category:s.category||'', price:s.price||'', time:s.time||'', isNew:!!s.isNew, fields: s.fields || [] }); setEditingId(s.id); }
                else { setNewService({title:'', category:'', price:'', time:'', isNew:false, fields: []}); setEditingId(null); }
                setIsModalOpen(true);
            };
            const toggleField = (field) => {
                const currentFields = newService.fields || [];
                if (currentFields.includes(field)) { setNewService({ ...newService, fields: currentFields.filter(f => f !== field) }); } 
                else { setNewService({ ...newService, fields: [...currentFields, field] }); }
            };

            // LOGICA CONFIGURACIÓN SERVICIOS (NUEVA)
            const openConfigModal = (service) => {
                setEditingConfigId(service.id);
                setConfigForm({
                    title: service.title,
                    availabilityText: service.availabilityText || "Disponible y activo de \n 08:00 AM a 08:00 PM",
                    warningText: service.warningText || "Si adquieres el servicio fuera de ese horario se entrega al día siguiente en horarios establecidos",
                    sampleUrl: service.sampleUrl || ""
                });
                setIsConfigModalOpen(true);
            };

            const handleSaveConfig = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                try {
                    await db.collection('servicios').doc(editingConfigId).update({
                        availabilityText: configForm.availabilityText,
                        warningText: configForm.warningText,
                        sampleUrl: configForm.sampleUrl
                    });
                    alert("✅ Textos y muestra actualizados correctamente.");
                    setIsConfigModalOpen(false);
                } catch(error) {
                    alert("Error: " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };


            // LOGICA USUARIOS
            const handleAddBalance = async (u) => { const m = prompt(`Sumar saldo a ${u.nombre}:`); if(!m) return; try { await db.collection('usuarios').doc(u.id).update({saldo: firebase.firestore.FieldValue.increment(parseFloat(m))}); alert("✅ Listo"); } catch(e){alert(e.message);} };
            const handleSetBalance = async (u) => { const m = prompt(`Nuevo saldo TOTAL para ${u.nombre}:`, u.saldo); if(!m) return; try { await db.collection('usuarios').doc(u.id).update({saldo: parseFloat(m)}); alert("✅ Listo"); } catch(e){alert(e.message);} };
            const handleToggleSuspend = async (u) => { if(confirm("¿Cambiar estado?")) db.collection('usuarios').doc(u.id).update({disabled:!u.disabled}); };
            const handleDeleteUser = async (u) => { if(prompt(`Escribe ELIMINAR para borrar a ${u.email}`)==="ELIMINAR") db.collection('usuarios').doc(u.id).delete(); };
            const handleViewHistory = async (u) => {
                setSelectedUserHistory({user:u, compras:[], recargas:[], loading:true}); setHistoryModalOpen(true);
                try {
                    const c = await db.collection('solicitudes_servicios').where('userId','==',u.id).get();
                    const r = await db.collection('recargas').where('userId','==',u.id).get();
                    setSelectedUserHistory({
                        user:u, loading:false,
                        compras: c.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.date?.seconds||0)-(a.date?.seconds||0)),
                        recargas: r.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.fecha?.seconds||0)-(a.fecha?.seconds||0))
                    });
                } catch(e){alert(e.message); setHistoryModalOpen(false);}
            };
            const handleDeleteHistoryItem = async (col, id) => {
                if(!confirm("¿Borrar registro?")) return;
                try { await db.collection(col).doc(id).delete(); 
                    setSelectedUserHistory(p=>({...p, compras: col.includes('sol')?p.compras.filter(i=>i.id!==id):p.compras, recargas: col.includes('rec')?p.recargas.filter(i=>i.id!==id):p.recargas}));
                } catch(e){alert(e.message);}
            };
            const handleWipeHistory = async (u) => {
                if(prompt("Escribe BORRAR:")!=="BORRAR") return;
                const b = db.batch(); (await db.collection('solicitudes_servicios').where('userId','==',u.id).get()).forEach(d=>b.delete(d.ref));
                (await db.collection('recargas').where('userId','==',u.id).get()).forEach(d=>b.delete(d.ref));
                await b.commit(); alert("✅ Borrado"); setHistoryModalOpen(false);
            };

            // LOGICA ANUNCIOS
            const handleSaveAnuncio = async (e) => {
                e.preventDefault();
                if(!newAnuncio.trim()) return;
                setIsSaving(true);
                try {
                    if(editingAnuncioId) {
                        await db.collection('anuncios').doc(editingAnuncioId).update({ texto: newAnuncio });
                        setEditingAnuncioId(null);
                    } else {
                        await db.collection('anuncios').add({ texto: newAnuncio, fecha: new Date() });
                    }
                    setNewAnuncio("");
                    alert("✅ Anuncio publicado");
                } catch(e) { alert(e.message); } finally { setIsSaving(false); }
            };
            
            const handleEditAnuncio = (anuncio) => {
                setNewAnuncio(anuncio.texto);
                setEditingAnuncioId(anuncio.id);
            };

            const handleDeleteAnuncio = async (id) => {
                if(confirm("¿Eliminar este anuncio?")) {
                    await db.collection('anuncios').doc(id).delete();
                }
            };

            // ==========================================
            // VISTAS DEL PANEL
            // ==========================================

            if (section === 'menu') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans"><div className="max-w-4xl mx-auto">
                    <button onClick={onBack} className="mb-6 flex items-center gap-2 text-slate-600 font-bold hover:text-indigo-600"><Icon name="arrow-left" className="w-5 h-5"/> Volver a la Tienda</button>
                    <h2 className="text-3xl font-bold text-slate-800 mb-8 flex items-center gap-3"><Icon name="shield" className="w-8 h-8 text-indigo-600"/> Panel de Administración</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <button onClick={()=>setSection('pagos')} className="bg-white p-6 rounded-2xl shadow hover:shadow-xl transition group relative overflow-hidden"><div className="flex justify-between items-start mb-4"><div className="p-3 bg-indigo-50 rounded-xl text-indigo-600"><Icon name="credit-card" className="w-8 h-8"/></div>{requests.length>0 && <span className="bg-rose-500 text-white text-xs font-bold px-3 py-1 rounded-full animate-pulse">{requests.length}</span>}</div><h3 className="text-xl font-bold text-slate-800">Recargas</h3><p className="text-slate-500 text-sm">Aprobar saldo</p></button>
                        <button onClick={()=>setSection('pedidos')} className="bg-white p-6 rounded-2xl shadow hover:shadow-xl transition group relative overflow-hidden"><div className="flex justify-between items-start mb-4"><div className="p-3 bg-orange-50 rounded-xl text-orange-600"><Icon name="shopping-cart" className="w-8 h-8"/></div>{orders.length>0 && <span className="bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full animate-pulse">{orders.length}</span>}</div><h3 className="text-xl font-bold text-slate-800">Pedidos</h3><p className="text-slate-500 text-sm">Solicitudes</p></button>
                        <button onClick={()=>setSection('stock')} className="bg-white p-6 rounded-2xl shadow hover:shadow-xl transition group relative overflow-hidden"><div className="flex justify-between items-start mb-4"><div className="p-3 bg-emerald-50 rounded-xl text-emerald-600"><Icon name="package" className="w-8 h-8"/></div><span className="bg-slate-100 text-slate-600 text-xs font-bold px-3 py-1 rounded-full">{stockList.length}</span></div><h3 className="text-xl font-bold text-slate-800">Stock</h3><p className="text-slate-500 text-sm">Inventario</p></button>
                        <button onClick={()=>setSection('usuarios')} className="bg-white p-6 rounded-2xl shadow hover:shadow-xl transition group relative overflow-hidden"><div className="flex justify-between items-start mb-4"><div className="p-3 bg-blue-50 rounded-xl text-blue-600"><Icon name="users" className="w-8 h-8"/></div><span className="bg-slate-100 text-slate-600 text-xs font-bold px-3 py-1 rounded-full">{usersList.length}</span></div><h3 className="text-xl font-bold text-slate-800">Usuarios</h3><p className="text-slate-500 text-sm">Gestión</p></button>
                        
                        {/* NUEVO BOTÓN: CONFIGURACIÓN SERVICIOS */}
                        <button onClick={()=>setSection('config_servicios')} className="bg-white p-6 rounded-2xl shadow hover:shadow-xl transition group relative overflow-hidden ring-2 ring-transparent hover:ring-indigo-200">
                            <div className="flex justify-between items-start mb-4">
                                <div className="p-3 bg-purple-50 rounded-xl text-purple-600"><Icon name="sliders" className="w-8 h-8"/></div>
                                <span className="bg-slate-100 text-slate-600 text-xs font-bold px-3 py-1 rounded-full">{stockList.length}</span>
                            </div>
                            <h3 className="text-lg font-bold text-slate-800 leading-tight">Horarios, Precios y muestra</h3>
                            <p className="text-slate-500 text-sm mt-1">Editar textos</p>
                        </button>

                        <button onClick={()=>setSection('anuncios')} className="bg-slate-900 p-6 rounded-2xl shadow hover:shadow-xl transition group relative overflow-hidden border border-slate-700">
                            <div className="flex justify-between items-start mb-4">
                                <div className="p-3 bg-cyan-900/50 rounded-xl text-cyan-400 border border-cyan-800"><Icon name="megaphone" className="w-8 h-8"/></div>
                            </div>
                            <h3 className="text-xl font-bold text-white">Anuncios</h3>
                            <p className="text-slate-400 text-sm">Publicidad Neón</p>
                        </button>

                    </div></div></div>
            );

            if (section === 'pagos') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans"><div className="max-w-4xl mx-auto"><button onClick={()=>setSection('menu')} className="mb-6 flex gap-2 font-bold text-slate-600"><Icon name="arrow-left" className="w-5 h-5"/> Volver</button><h2 className="text-2xl font-bold mb-6 flex gap-2"><Icon name="credit-card" className="w-6 h-6 text-indigo-600"/> Recargas</h2>
                <div className="bg-white rounded-xl shadow p-4 space-y-2">{requests.length===0?<p className="text-center text-slate-400 p-4">Sin datos.</p>:requests.map(r=>(<div key={r.id} className="flex justify-between items-center p-3 hover:bg-slate-50 border-b"><div><div className="font-bold">{r.userEmail}</div><div className="text-xs text-slate-500">${r.monto}</div></div><div className="flex gap-2"><button onClick={()=>handleProcessRecarga(r,false)} className="text-rose-600 font-bold text-xs bg-rose-50 px-3 py-2 rounded">RECHAZAR</button><button onClick={()=>handleProcessRecarga(r,true)} className="text-white font-bold text-xs bg-emerald-500 px-3 py-2 rounded">APROBAR</button></div></div>))}</div></div></div>
            );

            if (section === 'pedidos') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans">
                    <div className="max-w-4xl mx-auto">
                        <button onClick={()=>setSection('menu')} className="mb-6 flex gap-2 font-bold text-slate-600"><Icon name="arrow-left" className="w-5 h-5"/> Volver</button>
                        <h2 className="text-2xl font-bold mb-6 flex gap-2"><Icon name="shopping-cart" className="w-6 h-6 text-orange-600"/> Pedidos</h2>
                        <div className="bg-white rounded-xl shadow p-4 space-y-2">
                            {orders.length===0?<p className="text-center text-slate-400 p-4">Sin datos.</p>:orders.map(o=>(
                                <div key={o.id} className="flex flex-col md:flex-row justify-between items-center p-3 hover:bg-slate-50 border-b gap-3">
                                    <div className="flex-1">
                                        <div><span className="font-black">{o.serviceName}</span> <span className="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 rounded">PAID ${o.pricePaid}</span></div>
                                        <div className="text-xs text-slate-500">{o.userEmail}</div>
                                        {o.downloadUrl && <div className="text-[10px] text-indigo-600 bg-indigo-50 inline-block px-1 rounded border border-indigo-100">Link Adjunto</div>}
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => handleViewData(o)} className="text-xs font-bold border border-blue-200 bg-blue-50 text-blue-600 px-3 py-2 rounded flex gap-1 hover:bg-blue-100"><Icon name="eye" className="w-3 h-3"/> VER DATOS</button>
                                        <button onClick={()=>handleAttachLink(o.id,o.downloadUrl)} className="text-xs font-bold border px-3 py-2 rounded flex gap-1"><Icon name="link" className="w-3 h-3"/> {o.downloadUrl?'EDITAR':'ADJUNTAR'}</button>
                                        <button onClick={()=>handleCompleteOrder(o.id,o.downloadUrl)} className="text-xs font-bold text-white bg-slate-900 px-3 py-2 rounded flex gap-1"><Icon name="check" className="w-3 h-3"/> ATENDIDO</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    {isDetailsOpen && selectedOrderDetails && (
                        <div className="fixed inset-0 z-[100] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
                                <div className="p-4 border-b bg-slate-50 flex justify-between items-center"><div><h3 className="font-bold text-slate-800">Datos</h3><p className="text-xs text-slate-500 uppercase">{selectedOrderDetails.serviceName}</p></div><button onClick={() => setIsDetailsOpen(false)}><Icon name="x" className="w-5 h-5 text-slate-400"/></button></div>
                                <div className="p-6 max-h-[60vh] overflow-y-auto"><div className="space-y-3">{Object.keys(selectedOrderDetails.datosFormulario||{}).map((key,i)=>(<div key={i} className="bg-slate-50 p-3 rounded-lg border border-slate-200"><div className="text-[10px] font-bold text-slate-400 uppercase mb-1">{key}</div><div className="text-sm font-bold text-slate-800 select-text break-all">{selectedOrderDetails.datosFormulario[key]}</div></div>))}</div></div>
                                <div className="p-4 border-t bg-slate-50 text-right"><button onClick={() => setIsDetailsOpen(false)} className="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold">CERRAR</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );

            if (section === 'stock') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans relative"><div className="max-w-2xl mx-auto"><button onClick={()=>setSection('menu')} className="mb-6 flex gap-2 font-bold text-slate-600"><Icon name="arrow-left" className="w-5 h-5"/> Volver</button><div className="flex justify-between mb-6"><h2 className="text-2xl font-bold flex gap-2"><Icon name="package" className="w-6 h-6 text-emerald-600"/> Inventario</h2><button onClick={()=>openModal()} className="bg-emerald-600 text-white text-xs font-bold px-4 py-2 rounded shadow flex gap-2"><Icon name="plus" className="w-4 h-4"/> Agregar</button></div>
                <div className="space-y-3">{stockList.map(s=>(<div key={s.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center"><div><h4 className="font-bold text-sm">{s.title} {s.active===false&&<span className="text-slate-400 text-xs">(OCULTO)</span>}</h4><p className="text-[10px] text-slate-500 font-bold uppercase">{s.category} • <span className="text-emerald-600">{s.price}</span></p></div><div className="flex items-center gap-2"><div className="flex flex-col items-center"><input type="checkbox" checked={s.active!==false} onChange={()=>handleToggleActive(s)}/><span className="text-[9px] font-bold">{s.active!==false?'ON':'OFF'}</span></div><button onClick={()=>openModal(s)} className="p-2 bg-yellow-50 text-yellow-600 rounded"><Icon name="pencil" className="w-4 h-4"/></button><button onClick={()=>handleDeleteService(s.id)} className="p-2 bg-rose-50 text-rose-600 rounded"><Icon name="trash-2" className="w-4 h-4"/></button></div></div>))}</div></div>
                {isModalOpen && (<div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name={editingId?"edit":"plus-circle"} className="w-5 h-5 text-indigo-600"/>{editingId?'Editar':'Nuevo'}</h3><button onClick={()=>setIsModalOpen(false)}><Icon name="x" className="w-5 h-5 text-slate-400"/></button></div>
                <form onSubmit={handleSaveService} className="space-y-4"><input className="w-full border p-2 rounded" placeholder="Titulo" value={newService.title} onChange={e=>setNewService({...newService,title:e.target.value.toUpperCase()})}/><input className="w-full border p-2 rounded" placeholder="Categoria" value={newService.category} onChange={e=>setNewService({...newService,category:e.target.value.toUpperCase()})}/><div className="grid grid-cols-2 gap-2"><input className="border p-2 rounded" placeholder="Precio" value={newService.price} onChange={e=>setNewService({...newService,price:e.target.value})}/><input className="border p-2 rounded" placeholder="Tiempo" value={newService.time} onChange={e=>setNewService({...newService,time:e.target.value})}/></div>
                <div className="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-100"><span className="text-xs font-bold text-slate-600">¿Etiqueta "NUEVO"?</span><label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" className="sr-only peer" checked={newService.isNew} onChange={e => setNewService({...newService, isNew: e.target.checked})} /><div className="w-10 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div></label></div>
                <div className="border-t border-slate-100 pt-3"><p className="text-xs font-bold text-slate-500 mb-2 uppercase">Datos Requeridos:</p><div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto bg-slate-50 p-2 rounded border border-slate-200">{availableFields.map(label => (<label key={label} className="flex items-center gap-2 text-xs cursor-pointer hover:bg-slate-100 p-1 rounded"><input type="checkbox" checked={(newService.fields || []).includes(label)} onChange={() => toggleField(label)} className="rounded text-indigo-600 focus:ring-indigo-500"/><span className="truncate">{label}</span></label>))}</div></div>
                <button className="w-full bg-slate-900 text-white py-3 rounded font-bold">GUARDAR</button></form></div></div>)}</div>
            );

            // --- VISTA CONFIGURACIÓN DE SERVICIOS (NUEVA) ---
            if (section === 'config_servicios') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans relative">
                    <div className="max-w-4xl mx-auto">
                        <button onClick={()=>setSection('menu')} className="mb-6 flex gap-2 font-bold text-slate-600 hover:text-indigo-600 transition"><Icon name="arrow-left" className="w-5 h-5"/> Volver al Menú</button>
                        
                        <div className="flex items-center gap-3 mb-8">
                            <div className="p-3 bg-purple-100 rounded-xl text-purple-600"><Icon name="sliders" className="w-8 h-8"/></div>
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Horarios, Precios y Muestra</h2>
                                <p className="text-slate-500 text-sm">Personaliza los textos de disponibilidad y enlaces de muestra.</p>
                            </div>
                        </div>

                        {/* LISTA DE SERVICIOS PARA EDITAR */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {stockList.map(s => (
                                <div key={s.id} className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition flex flex-col justify-between group relative overflow-hidden">
                                    <div className={`absolute top-0 left-0 w-1.5 h-full ${s.active===false ? 'bg-slate-300' : 'bg-purple-500'}`}></div>
                                    
                                    <div className="pl-3 mb-4">
                                        <div className="flex justify-between items-start">
                                            <h4 className="font-black text-slate-800 text-base uppercase leading-tight">{s.title}</h4>
                                            {s.active===false && <span className="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-bold">OCULTO</span>}
                                        </div>
                                        <p className="text-xs text-purple-600 font-bold uppercase mt-1">{s.category}</p>
                                    </div>
                                    
                                    <div className="pl-3 mt-auto pt-4 border-t border-slate-100">
                                        <button 
                                            onClick={() => openConfigModal(s)}
                                            className="w-full bg-slate-50 text-slate-600 hover:bg-purple-600 hover:text-white py-2 rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-all border border-slate-200 hover:border-purple-600"
                                        >
                                            <Icon name="pencil" className="w-4 h-4"/> EDITAR TEXTOS Y LINK
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* MODAL DE EDICIÓN CONFIGURACIÓN */}
                    {isConfigModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm p-4 animate-[fadeIn_0.2s_ease-out]">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                                    <div>
                                        <h3 className="font-bold text-slate-800 text-lg">Editar Configuración</h3>
                                        <p className="text-[10px] font-bold text-purple-600 uppercase tracking-widest">{configForm.title}</p>
                                    </div>
                                    <button onClick={()=>setIsConfigModalOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="x" className="w-6 h-6"/></button>
                                </div>
                                
                                <form onSubmit={handleSaveConfig} className="p-6 overflow-y-auto space-y-5">
                                    {/* CAMPO 1: TEXTO DISPONIBILIDAD */}
                                    <div className="space-y-2">
                                        <div className="flex items-center gap-2">
                                            <span className="bg-emerald-100 text-emerald-600 p-1.5 rounded-lg"><Icon name="clock" className="w-4 h-4"/></span>
                                            <label className="text-xs font-bold text-slate-600 uppercase">Texto Disponibilidad (Banner Verde)</label>
                                        </div>
                                        <textarea 
                                            className="w-full bg-slate-50 border border-slate-300 rounded-xl p-3 text-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 outline-none transition resize-none h-20 font-medium"
                                            value={configForm.availabilityText}
                                            onChange={e => setConfigForm({...configForm, availabilityText: e.target.value})}
                                            placeholder="Ej: Disponible y activo de 08:00 AM a 08:00 PM"
                                        ></textarea>
                                    </div>

                                    {/* CAMPO 2: TEXTO ADVERTENCIA */}
                                    <div className="space-y-2">
                                        <div className="flex items-center gap-2">
                                            <span className="bg-amber-100 text-amber-600 p-1.5 rounded-lg"><Icon name="alert-triangle" className="w-4 h-4"/></span>
                                            <label className="text-xs font-bold text-slate-600 uppercase">Texto Advertencia (Banner Amarillo)</label>
                                        </div>
                                        <textarea 
                                            className="w-full bg-slate-50 border border-slate-300 rounded-xl p-3 text-sm focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none transition resize-none h-24 font-medium"
                                            value={configForm.warningText}
                                            onChange={e => setConfigForm({...configForm, warningText: e.target.value})}
                                            placeholder="Ej: Si adquieres el servicio fuera de ese horario se entrega al día siguiente..."
                                        ></textarea>
                                    </div>

                                    {/* CAMPO 3: URL MUESTRA */}
                                    <div className="space-y-2">
                                        <div className="flex items-center gap-2">
                                            <span className="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg"><Icon name="image" className="w-4 h-4"/></span>
                                            <label className="text-xs font-bold text-slate-600 uppercase">Enlace de Muestra (Imagen/PDF)</label>
                                        </div>
                                        <input 
                                            type="text"
                                            className="w-full bg-slate-50 border border-slate-300 rounded-xl p-3 text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-medium text-slate-700"
                                            value={configForm.sampleUrl}
                                            onChange={e => setConfigForm({...configForm, sampleUrl: e.target.value})}
                                            placeholder="Pegar enlace aquí (http://...)"
                                        />
                                        <p className="text-[10px] text-slate-400 font-bold ml-1">Dejar vacío para mostrar alerta de "No disponible".</p>
                                    </div>

                                    <div className="pt-4 border-t border-slate-100 flex justify-end gap-3">
                                        <button type="button" onClick={()=>setIsConfigModalOpen(false)} className="px-5 py-3 text-xs font-bold text-slate-500 hover:text-slate-800 transition">CANCELAR</button>
                                        <button type="submit" disabled={isSaving} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg flex items-center gap-2 disabled:opacity-50">
                                            {isSaving ? 'GUARDANDO...' : <><Icon name="save" className="w-4 h-4"/> GUARDAR CAMBIOS</>}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );

            if (section === 'usuarios') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans"><div className="max-w-6xl mx-auto"><button onClick={()=>setSection('menu')} className="mb-6 flex gap-2 font-bold text-slate-600"><Icon name="arrow-left" className="w-5 h-5"/> Volver</button><h2 className="text-2xl font-bold mb-6 flex gap-2"><Icon name="users" className="w-6 h-6 text-indigo-600"/> Usuarios</h2>
                <div className="bg-white rounded-xl shadow border border-slate-200 overflow-hidden"><div className="p-4 bg-slate-50 border-b border-slate-200"><span className="font-bold text-xs uppercase">Total: {usersList.length}</span></div><div className="overflow-x-auto"><table className="w-full text-left text-sm text-slate-600"><thead className="bg-slate-50 font-bold text-xs uppercase border-b"><tr><th className="px-6 py-4">Usuario</th><th className="px-6 py-4">Acciones</th></tr></thead><tbody className="divide-y divide-slate-100">
                {usersList.map(u => (<tr key={u.id} className={u.disabled?"bg-red-50":"hover:bg-slate-50"}><td className="px-6 py-4 w-1/3"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center font-bold text-indigo-600">{u.nombre?u.nombre[0]:'U'}</div><div>
                    <div className="font-black text-slate-800 flex items-center gap-2">{u.nombre||'SIN NOMBRE'} <span className="text-[10px] bg-emerald-100 text-emerald-700 px-2 rounded font-bold">${(u.saldo||0).toFixed(2)}</span></div>
                    <div className="text-xs text-indigo-500">{u.email}</div><div className="text-[9px] text-slate-400 font-mono mt-0.5 select-text">ID: {u.id}</div>
                </div></div></td>
                <td className="px-6 py-4"><div className="flex flex-wrap gap-2">
                    <div className="flex bg-emerald-50 rounded border border-emerald-100"><button onClick={()=>handleAddBalance(u)} className="p-2 border-r border-emerald-100 text-emerald-700"><Icon name="plus" className="w-4 h-4"/></button><button onClick={()=>handleSetBalance(u)} className="p-2 text-emerald-700"><Icon name="edit-3" className="w-4 h-4"/></button></div>
                    <div className="flex bg-blue-50 rounded border border-blue-100"><button onClick={()=>handleViewHistory(u)} className="p-2 border-r border-blue-100 text-blue-700"><Icon name="file-clock" className="w-4 h-4"/></button><button onClick={()=>handleWipeHistory(u)} className="p-2 text-blue-700"><Icon name="file-x" className="w-4 h-4"/></button></div>
                    <div className="flex bg-slate-100 rounded border border-slate-200"><button onClick={()=>handleToggleSuspend(u)} className="p-2 border-r border-slate-200 text-slate-600"><Icon name={u.disabled?"check-circle":"ban"} className="w-4 h-4"/></button><button onClick={()=>handleDeleteUser(u)} className="p-2 text-rose-600"><Icon name="user-x" className="w-4 h-4"/></button></div>
                </div></td></tr>))}</tbody></table></div></div></div>
                {historyModalOpen && (<div className="fixed inset-0 z-[100] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4"><div className="bg-white w-full max-w-3xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                    <div className="p-4 border-b bg-slate-50 flex justify-between items-center"><div><h3 className="font-bold">Historial</h3><p className="text-xs text-slate-500">{selectedUserHistory.user?.email}</p></div><button onClick={()=>setHistoryModalOpen(false)}><Icon name="x" className="w-5 h-5"/></button></div>
                    <div className="flex-1 overflow-y-auto p-6 bg-slate-100"><div className="grid md:grid-cols-2 gap-6">
                        <div><h4 className="font-bold text-indigo-600 mb-3">Compras</h4><div className="space-y-2">{selectedUserHistory.compras.map(c=>(<div key={c.id} className="bg-white p-3 rounded shadow text-xs relative"><div className="font-bold pr-6">{c.serviceName}</div><div className="text-emerald-600 font-bold">${c.pricePaid}</div><button onClick={()=>handleDeleteHistoryItem('solicitudes_servicios',c.id)} className="absolute top-2 right-2 text-slate-300 hover:text-rose-500"><Icon name="trash-2" className="w-4 h-4"/></button></div>))}</div></div>
                        <div><h4 className="font-bold text-emerald-600 mb-3">Recargas</h4><div className="space-y-2">{selectedUserHistory.recargas.map(r=>(<div key={r.id} className="bg-white p-3 rounded shadow text-xs relative"><div className="font-bold pr-6">${r.monto}</div><div className="text-slate-500">{r.concept}</div><button onClick={()=>handleDeleteHistoryItem('recargas',r.id)} className="absolute top-2 right-2 text-slate-300 hover:text-rose-500"><Icon name="trash-2" className="w-4 h-4"/></button></div>))}</div></div>
                    </div></div></div></div>
                )}</div>
            );

            // --- VISTA DE ANUNCIOS ---
            if (section === 'anuncios') return (
                <div className="min-h-screen bg-slate-100 p-6 font-sans">
                    <div className="max-w-2xl mx-auto">
                        <button onClick={()=>setSection('menu')} className="mb-6 flex gap-2 font-bold text-slate-600"><Icon name="arrow-left" className="w-5 h-5"/> Volver</button>
                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><Icon name="megaphone" className="w-6 h-6 text-cyan-500"/> Gestión de Anuncios</h2>
                        
                        {/* FORMULARIO */}
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 mb-8">
                            <form onSubmit={handleSaveAnuncio}>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Texto del Anuncio</label>
                                <textarea 
                                    className="w-full border border-slate-300 rounded-xl p-3 text-sm focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-100 transition-all font-medium text-slate-700 h-24 resize-none"
                                    placeholder="Escribe aquí el anuncio que aparecerá en la tienda..."
                                    value={newAnuncio}
                                    onChange={(e) => setNewAnuncio(e.target.value)}
                                ></textarea>
                                <div className="flex justify-end mt-3 gap-2">
                                    {editingAnuncioId && <button type="button" onClick={() => { setEditingAnuncioId(null); setNewAnuncio(""); }} className="text-slate-500 font-bold text-xs px-4">CANCELAR</button>}
                                    <button type="submit" disabled={isSaving} className="bg-slate-900 text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-800 transition flex items-center gap-2">
                                        {isSaving ? 'Guardando...' : <><Icon name="send" className="w-4 h-4"/> {editingAnuncioId ? 'ACTUALIZAR' : 'PUBLICAR'}</>}
                                    </button>
                                </div>
                            </form>
                        </div>

                        {/* LISTA */}
                        <div className="space-y-4">
                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">Anuncios Activos ({anuncios.length})</h3>
                            {anuncios.map(anuncio => (
                                <div key={anuncio.id} className="bg-slate-900 text-cyan-400 p-4 rounded-xl shadow-lg border border-slate-800 flex justify-between items-center relative overflow-hidden group">
                                    <div className="absolute top-0 left-0 w-1 h-full bg-cyan-500"></div>
                                    <p className="font-bold text-sm pr-4 shadow-cyan-500/50 drop-shadow-md">{anuncio.texto}</p>
                                    <div className="flex gap-2 bg-slate-900/80 p-1 rounded-lg">
                                        <button onClick={() => handleEditAnuncio(anuncio)} className="p-2 bg-yellow-500/10 text-yellow-500 hover:bg-yellow-500 hover:text-white rounded transition"><Icon name="pencil" className="w-4 h-4"/></button>
                                        <button onClick={() => handleDeleteAnuncio(anuncio.id)} className="p-2 bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white rounded transition"><Icon name="trash-2" className="w-4 h-4"/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            return null;
        };




        
                                     // ==========================================
        // COMPONENTE: EDITOR CERTIFICADO COVID (CLON FINAL - FULL NAME GRANDE)
        // ==========================================
        const CovidEditor = ({ onBack }) => {
            const [data, setData] = useState({
                curp: 'LIGR920126HCMNNB01', 
                nombre: 'RUBEN LINARES GONZALEZ',
                dosis1: { fecha: '2021-03-18', marca: 'AstraZeneca', lote: 'I-592740' },
                dosis2: { fecha: '2021-08-16', marca: 'AstraZeneca', lote: 'I-694376' },
                selloDigital: '278feab6-2b4f-4fe4-b9b7-3e8dcff84934',
                fechaEmision: '2025-12-02 15:56:03'
            });

            const handleChange = (field, value) => {
                setData(prev => ({ ...prev, [field]: value.toUpperCase() }));
            };

            const handleDoseChange = (dose, field, value) => {
                setData(prev => ({ ...prev, [dose]: { ...prev[dose], [field]: value } }));
            };

            const headerImage = "https://i.postimg.cc/6pXNzC2y/20260201-084246-0000.png";

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-slate-100 font-sans">
                    {/* IMPORTAMOS LA FUENTE MONTSERRAT */}
                    <style>
                        {`@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');`}
                    </style>

                    {/* --- PANEL DE EDICIÓN (IZQUIERDA) --- */}
                    <div className="w-full lg:w-1/3 bg-white border-r border-slate-200 p-5 no-print h-screen overflow-y-auto z-20 shadow-xl">
                        <div className="mb-6 flex justify-between items-center">
                            <button onClick={onBack} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-bold transition">
                                <i data-lucide="arrow-left" className="w-5 h-5"></i> Regresar
                            </button>
                            <button onClick={() => window.print()} className="bg-slate-900 text-white px-4 py-2 rounded-lg font-bold hover:bg-emerald-600 transition flex items-center gap-2 text-xs shadow-lg">
                                <i data-lucide="printer" className="w-4 h-4"></i> IMPRIMIR
                            </button>
                        </div>
                        
                        <div className="space-y-6 text-xs font-['Montserrat']">
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h3 className="font-black text-slate-400 uppercase tracking-widest mb-3">Datos Personales</h3>
                                <div className="space-y-3">
                                    <div><label className="block font-bold text-slate-700 mb-1">CURP</label><input className="w-full border border-slate-300 rounded p-2 outline-none font-mono uppercase focus:border-indigo-500" value={data.curp} onChange={e => handleChange('curp', e.target.value)} /></div>
                                    <div><label className="block font-bold text-slate-700 mb-1">Nombre Completo</label><input className="w-full border border-slate-300 rounded p-2 outline-none uppercase focus:border-indigo-500" value={data.nombre} onChange={e => handleChange('nombre', e.target.value)} /></div>
                                </div>
                            </div>
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <h3 className="font-black text-blue-400 uppercase tracking-widest mb-3">1ª Dosis</h3>
                                <div className="space-y-3">
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="block font-bold text-slate-500">Fecha</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis1.fecha} onChange={e => handleDoseChange('dosis1', 'fecha', e.target.value)} /></div>
                                        <div><label className="block font-bold text-slate-500">Lote</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis1.lote} onChange={e => handleDoseChange('dosis1', 'lote', e.target.value)} /></div>
                                    </div>
                                    <div><label className="block font-bold text-slate-500">Marca</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis1.marca} onChange={e => handleDoseChange('dosis1', 'marca', e.target.value)} /></div>
                                </div>
                            </div>
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <h3 className="font-black text-blue-800 uppercase tracking-widest mb-3">2ª Dosis</h3>
                                <div className="space-y-3">
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="block font-bold text-slate-500">Fecha</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis2.fecha} onChange={e => handleDoseChange('dosis2', 'fecha', e.target.value)} /></div>
                                        <div><label className="block font-bold text-slate-500">Lote</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis2.lote} onChange={e => handleDoseChange('dosis2', 'lote', e.target.value)} /></div>
                                    </div>
                                    <div><label className="block font-bold text-slate-500">Marca</label><input className="w-full border border-slate-300 rounded p-2 focus:border-indigo-500" value={data.dosis2.marca} onChange={e => handleDoseChange('dosis2', 'marca', e.target.value)} /></div>
                                </div>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h3 className="font-black text-slate-400 uppercase tracking-widest mb-3">Pie de Página</h3>
                                <div><label className="block font-bold text-slate-500 mb-1">Fecha Emisión</label><input className="w-full border border-slate-300 rounded p-2 mb-3 focus:border-indigo-500" value={data.fechaEmision} onChange={e => handleChange('fechaEmision', e.target.value)} /></div>
                                <div><label className="block font-bold text-slate-500 mb-1">Sello Digital (Hash)</label><textarea className="w-full border border-slate-300 rounded p-2 font-mono h-16 text-[10px] focus:border-indigo-500" value={data.selloDigital} onChange={e => handleChange('selloDigital', e.target.value)} /></div>
                            </div>
                        </div>
                    </div>

                    {/* --- VISTA PREVIA (DERECHA - CLON FINAL) --- */}
                    <div className="w-full lg:w-2/3 bg-gray-600 flex justify-center items-start p-8 print-area overflow-auto">
                        <div className="paper bg-white w-[21.59cm] min-h-[27.94cm] relative shadow-none flex flex-col items-center pt-0 pb-12 px-12" 
                             style={{ fontFamily: 'Arial, sans-serif', color: '#1a1a1a' }}>
                            
                            {/* 1. HEADER (LOGO) */}
                            <div className="w-full mb-0 px-6 relative z-10 mt-[-15px]">
                                <img src={headerImage} alt="Encabezado" className="w-full object-contain" />
                            </div>

                            {/* 2. TÍTULO */}
                            <div className="text-center mb-3 w-full mt-[-8px] relative z-20">
                                <h1 className="text-[42px] font-black mb-0 leading-[0.8] tracking-tighter w-full transform scale-x-[1.05]" style={{ color: '#1a1a1a' }}>
                                    CERTIFICADO DE VACUNACIÓN
                                </h1>
                                <h1 className="text-[42px] font-black mb-1 leading-[0.8] tracking-tighter w-full transform scale-x-[1.05]" style={{ color: '#1a1a1a' }}>
                                    CONTRA LA COVID-19
                                </h1>
                                <p className="text-[15px] mt-1 tracking-[0.25em] uppercase font-normal scale-y-90" style={{ color: '#1a1a1a' }}>COVID-19 VACCINATION CERTIFICATE</p>
                            </div>

                            {/* 3. DATOS PERSONALES */}
                            <div className="w-full mb-5 text-center">
                                <div className="mb-1">
                                    <p className="text-[24px] font-bold mb-0 leading-tight" style={{ color: '#1a1a1a', transform: 'scaleX(1.20)' }}>Clave Única de Registro de Población:</p>
                                    <p className="text-[13px] mb-0.5 leading-none font-normal tracking-[0.04em]" style={{ color: '#444' }}>Unique Population Registry Code:</p>
                                    <p className="text-[22px] tracking-wide uppercase mt-0.5 font-normal scale-y-95" style={{ color: '#1a1a1a' }}>{data.curp}</p>
                                </div>
                                <div>
                                    <p className="text-[24px] font-bold mb-0 leading-tight" style={{ color: '#1a1a1a' }}>Nombre completo:</p>
                                    
                                    {/* CAMBIO APLICADO: AUMENTADO A 14PX (ANTES 12PX) */}
                                    <p className="text-[14px] mb-1 leading-none font-normal" style={{ color: '#444' }}>Full name:</p>
                                    
                                    <p className="text-[22px] tracking-wide uppercase mt-1.5 font-normal scale-y-95" style={{ color: '#1a1a1a' }}>{data.nombre}</p>
                                </div>
                            </div>

                                                        {/* 4. TABLA DE VACUNACIÓN - COMPACTADA (LETRA GRANDE, MENOS ESPACIO) */}
                            <div className="w-[98%] mx-auto mb-2" style={{ color: '#000' }}>
                                {/* ENCABEZADOS - Padding reducido para ahorrar espacio */}
                                <div className="flex border border-black border-b-0">
                                    <div className="w-1/2 py-1 text-center border-r border-black">
                                        <div className="font-bold text-[34px] leading-none text-black">1º Dosis</div>
                                        <div className="text-[20px] text-[#444] leading-tight font-normal">First dose</div>
                                    </div>
                                    <div className="w-1/2 py-1 text-center">
                                        <div className="font-bold text-[34px] leading-none text-black">2º Dosis</div>
                                        <div className="text-[20px] text-[#444] leading-tight font-normal">Second dose</div>
                                    </div>
                                </div>

                                {/* CONTENIDO - Huecos reducidos (gap-3 en vez de gap-7) */}
                                <div className="flex border border-black">
                                    {/* Columna Izquierda */}
                                    <div className="w-1/2 pt-3 pb-3 px-1 flex flex-col gap-3 border-r border-black items-center text-center">
                                        <div>
                                            <div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Fecha de aplicación:</div>
                                            <div className="text-[16px] leading-none mb-0.5 text-[#444]">Application date:</div>
                                            <div className="text-[24px] leading-none text-black font-normal">{data.dosis1.fecha}</div>
                                        </div>
                                        <div>
                                            <div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Marca de la vacuna:</div>
                                            <div className="text-[16px] leading-none mb-0.5 text-[#444]">Vaccine manufacturer:</div>
                                            <div className="text-[24px] leading-none text-black font-normal">{data.dosis1.marca}</div>
                                        </div>
                                        <div>
                                            <div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Lote de la vacuna:</div>
                                            <div className="text-[16px] leading-none mb-0.5 text-[#444]">Vaccine lot number:</div>
                                            <div className="text-[24px] leading-none text-black font-normal">{data.dosis1.lote}</div>
                                        </div>
                                    </div>

                                    {/* Columna Derecha */}
                                    <div className="w-1/2 pt-3 pb-3 px-1 flex flex-col gap-3 items-center text-center">
                                        <div>
                                            <div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Fecha de aplicación:</div>
                                            <div className="text-[16px] leading-none mb-0.5 text-[#444]">Application date:</div>
                                            <div className="text-[24px] leading-none text-black font-normal">{data.dosis2.fecha}</div>
                                        </div>
                                        <div>
                                            <div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Marca de la vacuna:</div>
                                            <div className="text-[16px] leading-none mb-0.5 text-[#444]">Vaccine manufacturer:</div>
                                            <div className="text-[24px] leading-none text-black font-normal">{data.dosis2.marca}</div>
                                        </div>
                                        <div>
                                            <div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Lote de la vacuna:</div>
                                            <div className="text-[16px] leading-none mb-0.5 text-[#444]">Vaccine lot number:</div>
                                            <div className="text-[24px] leading-none text-black font-normal">{data.dosis2.lote}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                                        {/* 5. PIE DE PÁGINA - TEXTOS MÁS LEGIBLES */}
                            <div className="w-full flex mt-1 px-4 items-end mb-1">
                                
                                {/* IZQUIERDA: FIRMA (Ajustada para verse completa) */}
                                <div className="w-[35%] flex flex-col items-center justify-end pb-12 pr-4"> {/* pb-12 la empuja hacia arriba */}
                                    <svg viewBox="0 0 150 80" className="w-32 h-16 opacity-90 rotate-[-5deg] overflow-visible"> {/* overflow-visible por seguridad */}
                                        <path d="M20,60 C40,40 60,30 50,70 S 90,40 120,30" stroke="#1a1a1a" strokeWidth="2.5" fill="none" strokeLinecap="round" />
                                        <path d="M30,50 L110,45" stroke="#1a1a1a" strokeWidth="1.5" fill="none" strokeLinecap="round" />
                                        <path d="M60,30 C60,10 80,10 70,50" stroke="#1a1a1a" strokeWidth="2" fill="none" />
                                    </svg>
                                </div>

                                {/* DERECHA: SELLO DIGITAL Y TEXTOS */}
                                <div className="w-[65%] flex flex-col items-end">
                                    
                                    {/* CAJA DEL SELLO */}
                                    <div className="border border-black w-full p-2 mb-2 bg-white">
                                        <div className="text-[15px] font-bold text-black leading-none mb-1 uppercase">SELLO DIGITAL/DIGITAL STAMP:</div>
                                        <div className="text-[14px] text-[#111] leading-tight break-all font-sans" style={{fontFamily: 'Arial, sans-serif'}}>{data.selloDigital}</div>
                                    </div>

                                    {/* FECHA EMISIÓN */}
                                    <div className="text-right w-full mt-0.5 mb-2">
                                        <div className="text-[15px] text-[#1a1a1a] leading-tight font-normal">
                                            Emisión del documento/Document issued:
                                        </div>
                                        <div className="text-[15px] text-[#1a1a1a] leading-tight mt-0.5">
                                            {data.fechaEmision}
                                        </div>
                                    </div>

                                    {/* TEXTO DE VALIDACIÓN (AUMENTADO A 11PX) */}
                                    <div className="text-right text-[11px] leading-[1.2] text-black w-full font-sans">
                                        <p>Para validar la autenticidad de éste documento, por favor escanee el</p>
                                        <p>código QR que debe abrir la página <b className="font-bold">https://cvcovid.salud.gob.mx</b></p>
                                        <p className="text-[#444] mt-0.5">To validate the authenticity of this document, please scann the QR</p>
                                        <p className="text-[#444]">code that should open the page <b className="font-bold">https://cvcovid.salud.gob.mx</b></p>
                                    </div>
                                </div>
                            </div>

                            {/* 6. BANNER RENAPO (AUMENTADO A 11PX) */}
                            <div className="w-full text-center mt-auto pb-8">
                                <div 
                                    className="inline-block px-6 py-2 w-[95%]"
                                    style={{ 
                                        backgroundColor: '#e2e2e2', 
                                        WebkitPrintColorAdjust: 'exact', 
                                        printColorAdjust: 'exact' 
                                    }}
                                >
                                    <p className="text-[11px] text-black leading-tight text-center font-sans">
                                        "La Secretaría de Gobernación a través de <span className="font-bold">RENAPO</span>, acredita que la CURP fue verificada en la base de datos <br/> del Registro Nacional de Población".
                                    </p>
                                </div>
                            </div>



                        </div>
                    </div>
                </div>
            );
        };
        
                                      // ==========================================
        // COMPONENTE: HISTORIAL DE COMPRAS (DISEÑO ORIGINAL + CURP)
        // ==========================================
        const PurchaseHistory = ({ onBack, onPrintDocument }) => {
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if(window.lucide) window.lucide.createIcons();
                const user = auth.currentUser;
                if (!user) return;
                
                // NOTA: No usamos orderBy aquí para evitar el error de "Index" que deja cargando infinito.
                // Ordenamos los datos manualmente en el cliente (docs.sort).
                const unsubscribe = db.collection('solicitudes_servicios').where('userId', '==', user.uid).onSnapshot(snapshot => {
                    const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Ordenamiento manual por fecha (más reciente primero)
                    docs.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
                    setHistory(docs);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

                        const handleDownload = (item) => {
                // AGREGADA LA DETECCIÓN PARA FARMACIA
                if (item.farmaciaData) { onPrintDocument(item.farmaciaData, 'farmacia'); return; }
                
                if (item.covidData) { onPrintDocument(item.covidData, 'covid'); return; }
                if (item.recipeData) { onPrintDocument(item.recipeData, 'recipe'); return; }
                
                if (item.downloadUrl && item.downloadUrl !== 'GENERATED_PDF') {
                    let url = item.downloadUrl;
                    if (!url.startsWith('http')) url = 'https://' + url.trim();
                    window.open(url, '_blank');
                } else { alert("El documento aún no está listo."); }
            };


            // Función auxiliar simple para obtener el texto del CURP
            const getCurpText = (item) => {
                if (item.covidData && item.covidData.curp) return item.covidData.curp;
                if (item.recipeData && item.recipeData.paciente && item.recipeData.paciente.curp) return item.recipeData.paciente.curp;
                return "SERVICIO SIN CURP";
            };

            return (
                <div className="min-h-screen bg-slate-50 p-6 font-sans">
                    <div className="max-w-3xl mx-auto">
                        <button onClick={onBack} className="mb-6 flex items-center gap-2 text-slate-600 font-bold hover:text-indigo-600 transition"><i data-lucide="arrow-left" className="w-5 h-5"></i> Volver a la Tienda</button>
                        <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3"><i data-lucide="history" className="w-6 h-6 text-indigo-600"></i> Historial de Compras</h2>
                        
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-slate-500 uppercase text-xs tracking-wider">Mis Documentos ({history.length})</div>
                            
                            {loading ? (
                                <div className="p-10 text-center text-slate-400">Cargando...</div> 
                            ) : history.length === 0 ? (
                                <div className="p-10 text-center text-slate-400"><p>Sin compras aún.</p></div> 
                            ) : (
                                <div className="divide-y divide-slate-100">
                                    {history.map(item => (
                                        <div key={item.id} className="p-4 hover:bg-slate-50 transition flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <h4 className="font-bold text-slate-800 text-sm">{item.serviceName}</h4>
                                                    <span className={`text-[9px] font-bold px-2 py-0.5 rounded-full border uppercase ${item.status === 'completado' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-amber-100 text-amber-700 border-amber-200'}`}>
                                                        {item.status === 'completado' ? 'Listo / Entregado' : 'En Proceso'}
                                                    </span>
                                                </div>

                                                {/* --- AQUÍ ESTÁ EL CAMBIO SOLICITADO --- */}
                                                <div className="text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wide">
                                                    {getCurpText(item)}
                                                </div>
                                                {/* -------------------------------------- */}

                                                <div className="text-[11px] text-slate-500 flex items-center gap-3">
                                                    <span>{item.date ? new Date(item.date.seconds * 1000).toLocaleDateString() : 'Fecha desc.'}</span>
                                                    <span>• {item.category}</span>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <span className="font-bold text-slate-700 text-sm">${item.pricePaid}</span>
                                                {item.status === 'completado' && (
                                                    <button onClick={() => handleDownload(item)} className="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md font-bold text-xs flex items-center gap-2">
                                                        <i data-lucide={item.recipeData || item.covidData ? "printer" : "download"} className="w-4 h-4"></i> 
                                                        {item.recipeData || item.covidData ? 'IMPRIMIR PDF' : 'DESCARGAR'}
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };



        
                       // ==========================================
        // COMPONENTE: PERFIL DE USUARIO (V13 - BLINDAJE TOTAL CON SAFE-ICON)
        // ==========================================
        const UserProfile = ({ onBack }) => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState({});
            const [stats, setStats] = useState({ spent: 0, recharged: 0 });
            const [loading, setLoading] = useState(true);

            // Estado para edición
            const [editingField, setEditingField] = useState(null);
            const [tempValue, setTempValue] = useState("");
            const [isSaving, setIsSaving] = useState(false);
            
            // Estado para mensaje de éxito
            const [successField, setSuccessField] = useState(null);

            // --- 1. COMPONENTE DE SEGURIDAD PARA ICONOS ---
            // Esto evita que React se rompa cuando los iconos cambian
            const SafeIcon = ({ name, className }) => (
                <span 
                    dangerouslySetInnerHTML={{
                        __html: `<i data-lucide="${name}" class="${className || ''}"></i>`
                    }}
                    style={{ display: 'inline-flex' }}
                />
            );

            // 2. MOTOR DE ICONOS BLINDADO
            useEffect(() => {
                // Pequeño retraso para asegurar que el DOM está listo
                const timer = setTimeout(() => {
                    try {
                        if(window.lucide) window.lucide.createIcons();
                    } catch(e) { console.warn("Error de iconos prevenido"); }
                }, 100);
                return () => clearTimeout(timer);
            }, [loading, editingField, successField, userData]);

            useEffect(() => {
                const currentUser = auth.currentUser;
                if (!currentUser) return;
                setUser(currentUser);

                const unsubUser = db.collection('usuarios').doc(currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) setUserData(doc.data());
                    else setUserData({ email: currentUser.email });
                    setLoading(false);
                });

                const fetchStats = async () => {
                    try {
                        const ordersSnap = await db.collection('solicitudes_servicios').where('userId', '==', currentUser.uid).get();
                        const totalSpent = ordersSnap.docs.reduce((acc, doc) => acc + (doc.data().pricePaid || 0), 0);
                        const rechargesSnap = await db.collection('recargas').where('userId', '==', currentUser.uid).where('status', '==', 'aprobado').get();
                        const totalRecharged = rechargesSnap.docs.reduce((acc, doc) => acc + (doc.data().monto || 0), 0);
                        setStats({ spent: totalSpent, recharged: totalRecharged });
                    } catch (e) { console.error(e); }
                };
                fetchStats();
                return () => unsubUser();
            }, []);

            const startEditing = (field, currentValue) => {
                setSuccessField(null); 
                setEditingField(field);
                setTempValue(currentValue || "");
            };

            const cancelEditing = () => {
                setEditingField(null);
                setTempValue("");
            };

            const saveField = async (field) => {
                if (!user) return;
                setIsSaving(true);
                try {
                    const finalValue = field === 'genero' ? tempValue : String(tempValue || "").toUpperCase();
                    
                    await db.collection('usuarios').doc(user.uid).set({
                        [field]: finalValue
                    }, { merge: true });
                    
                    setEditingField(null); 
                    setSuccessField(field); 
                    
                    setTimeout(() => setSuccessField(null), 1500);

                } catch (error) {
                    alert("Error: " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            const formatDate = (timestamp) => {
                if(!timestamp) return 'Reciente';
                if(timestamp.toDate) return timestamp.toDate().toLocaleDateString();
                return new Date(timestamp).toLocaleDateString();
            };

            // RENDERIZADOR DE CAMPOS (USANDO SAFEICON)
            const renderEditableField = (field, label, iconName, placeholder, type = "text") => {
                const isEditing = editingField === field;
                const isSuccess = successField === field;
                const value = isEditing ? tempValue : (userData[field] || "");

                // KEY ÚNICA: Obliga a React a limpiar el componente al cambiar de estado
                const componentKey = `field-${field}-${isEditing ? 'edit' : 'view'}-${isSuccess ? 'ok' : 'no'}`;

                let actionButtons;

                if (isEditing) {
                    actionButtons = (
                        <div className="flex gap-2">
                            <button onClick={cancelEditing} disabled={isSaving} className="text-slate-400 hover:text-slate-600 bg-slate-100 p-1 rounded">
                                <SafeIcon name="x" className="w-4 h-4" />
                            </button>
                            <button onClick={() => saveField(field)} disabled={isSaving} className="text-white bg-emerald-500 hover:bg-emerald-600 p-1 rounded font-bold shadow-emerald-200 shadow-sm">
                                {isSaving ? <span className="text-[10px]">...</span> : <SafeIcon name="check" className="w-4 h-4" />}
                            </button>
                        </div>
                    );
                } else if (isSuccess) {
                    actionButtons = (
                        <span className="text-emerald-600 text-[10px] font-bold px-2 py-1 bg-emerald-50 rounded border border-emerald-100 animate-pulse">
                            ¡GUARDADO!
                        </span>
                    );
                } else {
                    actionButtons = (
                        <button onClick={() => startEditing(field, userData[field])} className="text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 p-1.5 rounded-full transition">
                            <SafeIcon name="pencil" className="w-4 h-4" />
                        </button>
                    );
                }

                return (
                    <div key={componentKey} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm mb-3 transition-all hover:shadow-md">
                        <div className="flex justify-between items-center mb-1">
                            <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-1">
                                <SafeIcon name={iconName} className="w-3 h-3" /> {label}
                            </label>
                            {actionButtons}
                        </div>
                        <div className="relative">
                            <input 
                                type={type} 
                                value={value}
                                onChange={(e) => setTempValue(e.target.value)}
                                disabled={!isEditing}
                                placeholder={placeholder}
                                className={`w-full bg-transparent outline-none font-bold text-slate-700 transition-all ${isEditing ? 'border-b-2 border-indigo-500 pb-1' : 'text-slate-800'}`}
                            />
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 p-6 font-sans pb-20">
                    <div className="max-w-xl mx-auto">
                        <button onClick={onBack} className="mb-6 flex items-center gap-2 text-slate-600 font-bold hover:text-indigo-600 transition">
                            <SafeIcon name="arrow-left" className="w-5 h-5" /> Volver a la Tienda
                        </button>
                        
                        <div className="flex items-center gap-4 mb-8">
                            <div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 border-2 border-indigo-200 shadow-sm">
                                <SafeIcon name="user-cog" className="w-8 h-8" />
                            </div>
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Mi Perfil</h2>
                                <p className="text-slate-500 text-sm">Gestiona tus datos personales</p>
                            </div>
                        </div>

                        {loading ? (
                            <div className="text-center py-10 text-slate-400 flex flex-col items-center gap-2">
                                <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-500"></div>
                                Cargando perfil...
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <div>
                                    <div className="mb-2 px-1 text-xs font-black text-slate-400 uppercase tracking-widest">Información Personal</div>
                                    
                                    {/* CORREO (NO EDITABLE) */}
                                    <div className="bg-slate-100 p-4 rounded-xl border border-slate-200 mb-3 opacity-70">
                                        <div className="flex justify-between items-center mb-1">
                                            <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-1"><SafeIcon name="mail" className="w-3 h-3" /> Correo</label>
                                            <SafeIcon name="lock" className="w-3 h-3 text-slate-400" />
                                        </div>
                                        <div className="font-bold text-slate-600 break-all">{user?.email}</div>
                                    </div>

                                    {renderEditableField("nombre", "Nombre Completo", "user", "Tu Nombre")}
                                    {renderEditableField("telefono", "Teléfono", "phone", "55 0000 0000", "tel")}
                                    {renderEditableField("direccion", "Dirección", "map-pin", "Ciudad, Estado")}

                                    {/* GÉNERO */}
                                    <div key={`genero-${editingField === 'genero' ? 'edit' : 'view'}-${successField === 'genero' ? 'ok' : 'normal'}`} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm mb-3 transition-all hover:shadow-md">
                                        <div className="flex justify-between items-center mb-3">
                                            <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-1">
                                                <SafeIcon name="users" className="w-3 h-3" /> Género
                                            </label>
                                            
                                            {editingField === 'genero' ? (
                                                 <div className="flex gap-2">
                                                    <button onClick={cancelEditing} disabled={isSaving} className="text-slate-400 hover:text-slate-600 bg-slate-100 p-1 rounded"><SafeIcon name="x" className="w-4 h-4" /></button>
                                                    <button onClick={() => saveField('genero')} disabled={isSaving} className="text-white bg-emerald-500 hover:bg-emerald-600 p-1 rounded font-bold shadow-emerald-200 shadow-sm">
                                                        {isSaving ? <span className="text-[10px]">...</span> : <SafeIcon name="check" className="w-4 h-4" />}
                                                    </button>
                                                </div>
                                            ) : successField === 'genero' ? (
                                                <span className="text-emerald-600 text-[10px] font-bold px-2 py-1 bg-emerald-50 rounded border border-emerald-100 animate-pulse">¡GUARDADO!</span>
                                            ) : (
                                                <button onClick={() => startEditing('genero', userData.genero)} className="text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 p-1.5 rounded-full transition">
                                                    <SafeIcon name="pencil" className="w-4 h-4" />
                                                </button>
                                            )}
                                        </div>
                                        
                                        <div className="flex gap-2 overflow-x-auto pb-1">
                                            {['Femenino', 'Masculino', 'No Binario'].map(option => {
                                                const currentVal = editingField === 'genero' ? tempValue : userData.genero;
                                                const isSelected = currentVal === option;
                                                return (
                                                    <label key={option} className={`flex-shrink-0 cursor-pointer px-4 py-2 rounded-lg border text-xs font-bold transition-all flex items-center gap-2 ${isSelected ? 'bg-indigo-600 text-white border-indigo-600 shadow-md ring-2 ring-indigo-200' : 'bg-slate-50 text-slate-500 border-slate-200 hover:bg-slate-100'} ${editingField !== 'genero' ? 'pointer-events-none opacity-60' : ''}`}>
                                                        <input type="radio" name="genero" value={option} checked={isSelected} onChange={(e) => setTempValue(e.target.value)} className="sr-only" disabled={editingField !== 'genero'} />
                                                        {isSelected && <SafeIcon name="check-circle" className="w-3 h-3" />}
                                                        {option}
                                                    </label>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div className="mb-2 px-1 text-xs font-black text-slate-400 uppercase tracking-widest mt-6">Estadísticas de Cuenta</div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center text-center">
                                            <div className="w-10 h-10 rounded-full bg-rose-50 flex items-center justify-center text-rose-500 mb-2 border border-rose-100"><SafeIcon name="trending-down" className="w-5 h-5" /></div>
                                            <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Saldo Gastado</div>
                                            <div className="text-xl font-black text-slate-800 mt-1">${stats.spent.toFixed(2)}</div>
                                        </div>
                                        <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center text-center">
                                            <div className="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-500 mb-2 border border-emerald-100"><SafeIcon name="trending-up" className="w-5 h-5" /></div>
                                            <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Saldo Recargado</div>
                                            <div className="text-xl font-black text-slate-800 mt-1">${stats.recharged.toFixed(2)}</div>
                                        </div>
                                        <div className="col-span-2 bg-slate-800 p-5 rounded-2xl shadow-lg flex items-center justify-between text-white relative overflow-hidden">
                                            <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-500 rounded-full blur-3xl opacity-20 -mr-10 -mt-10"></div>
                                            <div className="flex items-center gap-4 relative z-10">
                                                <div className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center backdrop-blur-sm border border-white/10"><SafeIcon name="calendar-days" className="w-5 h-5 text-indigo-300" /></div>
                                                <div>
                                                    <div className="text-[10px] font-bold opacity-60 uppercase tracking-wider">Fecha de registro</div>
                                                    <div className="font-bold text-base text-white">{formatDate(userData.fechaRegistro)}</div>
                                                </div>
                                            </div>
                                            <SafeIcon name="award" className="w-12 h-12 text-yellow-400 opacity-20 relative z-10" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
                // ==========================================
        // NUEVO COMPONENTE: VISOR DE IMPRESIÓN (RECETA)
        // ==========================================
        const RecipePrinter = ({ data, onBack }) => {
            
            useEffect(() => {
                // Guardamos el título original de la página para restaurarlo después
                const tituloOriginal = document.title;
                
                // Forzamos el nombre del CURP en el título antes de imprimir
                if (data.paciente?.curp) {
                    document.title = data.paciente.curp.toUpperCase();
                }

                const timer = setTimeout(() => {
                    window.print();
                }, 800);

                // Esta función se ejecuta cuando el usuario sale de la vista de impresión
                return () => {
                    document.title = tituloOriginal;
                    clearTimeout(timer);
                };
            }, [data]);

            // Recuperamos el sello basado en el nombre del médico si coincide, si no, usa el default
            const findSello = () => {
                const sello = SELLOS_DATA.find(s => s.nombre === data.medico.nombre);
                return sello || SELLOS_DATA[0];
            };
            const activeSello = findSello();
            
            const logoUrl = "https://i.postimg.cc/gJ8kqq0g/1766127957062.png";
            const qrContent = `Nombre: ${data.paciente.nombre}\nNSS: ${data.paciente.nss}\nFecha Nacimiento: ${data.paciente.fechaNac}\nCURP: ${data.paciente.curp}\nDelegación: ${data.paciente.delegacion}\nCVE. PTAL: ${data.paciente.cve}\nFolio: ${data.meta.folio}`;
            const qrCode = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrContent)}`;

            return (
                <div className="min-h-screen bg-white flex flex-col items-center justify-start pt-5 font-sans">
                    <div className="no-print mb-6 flex gap-4">
                         <button onClick={onBack} className="bg-white text-slate-800 px-6 py-2 rounded-full font-bold shadow-lg hover:scale-105 transition flex items-center gap-2">
                            <i data-lucide="arrow-left"></i> Volver al Historial
                         </button>
                         <button onClick={() => window.print()} className="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:scale-105 transition flex items-center gap-2">
                            <i data-lucide="printer"></i> Imprimir / Guardar PDF
                         </button>
                    </div>

                    <div className="print-area bg-white w-[21.59cm] min-h-[13.97cm] p-8 relative text-black shadow-none overflow-hidden mx-auto">
                         <div className="flex justify-between items-start">
                            <div className="w-[55%] pr-2">
                                <div className="flex flex-col items-center mb-1"><img src={logoUrl} className="h-10 w-auto mb-1 opacity-90" alt="Logo" /><h1 className="text-[10px] font-bold tracking-wide text-center leading-none">INSTITUTO MEXICANO DEL SEGURO SOCIAL</h1><p className="text-[5px] font-bold tracking-[0.2em] text-gray-500 mt-0.5 uppercase">Seguridad y Solidaridad Social</p></div>
                                <div className="w-full border-t border-b border-gray-400 py-0.5 my-2 text-center text-[7px] uppercase">Dirección de Prestaciones Médicas</div>
                                <div className="text-center mb-2"><h2 className="text-xl font-bold font-[Tinos] uppercase tracking-wide">Receta Individual</h2></div>
                                <div className="relative h-12 mt-2 mb-2 w-full"><div className="absolute left-1/2 -translate-x-1/2 top-0"><div className="barcode"></div></div><div className="absolute -right-40 top-8"><div className="text-left leading-[1.1] font-sans"><div className="text-base font-bold text-gray-900 mb-0.5 whitespace-nowrap">Folio: <span className="text-black text-base font-black tracking-tight ml-1">{data.meta.folio}</span></div><div className="text-[11px] font-bold text-black uppercase max-w-[220px]">ESTA RECETA NO SE SURTIRÁ DESPUÉS DE LAS 72 HORAS DE SU EXPEDICIÓN</div></div></div></div>
                            </div>
                            <div className="w-[45%] pl-2 pt-2 relative">
                                <div className="double-box pt-box w-full -mt-6"><div className="flex justify-between mb-2"><div><span className="pt-label">NSS:</span><span className="pt-val">{data.paciente.nss}</span></div><div><span className="pt-label">AGREGADO. MED:</span><span className="pt-val">{data.paciente.agregado}</span></div></div><div className="text-center mb-2"><span className="pt-label block w-full mb-px">NOMBRE DEL PACIENTE:</span><div className="pt-val uppercase">{data.paciente.nombre}</div></div><div className="mb-0.5"><span className="pt-label">CURP:</span><span className="pt-val">{data.paciente.curp}</span></div><div className="mb-0.5"><span className="pt-label">SEXO:</span><span className="pt-val">{data.paciente.sexo}</span></div><div className="mb-0.5"><span className="pt-label">FECHA DE NACIMIENTO:</span><span className="pt-val">{data.paciente.fechaNac}</span></div><div className="mb-0.5"><span className="pt-label">DELEGACION:</span><span className="pt-val">{data.paciente.delegacion}</span></div><div className="flex justify-between mb-0.5"><div className="flex gap-2"><div><span className="pt-label">UMP:</span><span className="pt-val">{data.paciente.ump}</span></div><div><span className="pt-label">CONSULTORIO:</span><span className="pt-val">{data.paciente.consultorio}</span></div></div></div><div className="flex justify-end"><div className="text-left"><div><span className="pt-label">CVE.PTAL</span><span className="pt-val">{data.paciente.cve}</span></div><div><span className="pt-label">TURNO:</span><span className="pt-val">{data.paciente.turno}</span></div></div></div></div>
                                <img src={qrCode} className="absolute -bottom-20 right-20 w-14 h-14" alt="QR" />
                            </div>
                        </div>

                        <div className="double-box min-h-[500px] flex flex-col relative mt-12">
                            <div className="flex justify-between items-center px-2 pt-1 text-[10px] font-bold uppercase"><div>FECHA: {data.meta.fecha}</div><div>Primer Nivel de Atención</div></div>
                            <div className="border-b border-black w-auto mx-4 mb-1"></div>
                            <div className="p-2 flex-grow">
                                {data.medicamentos.map(m => (<div key={m.id} className="med-item text-[10px] leading-snug mb-6"><div className="font-bold text-black px-1 mb-0.5">{m.text}</div><div className="border-b border-black w-auto mx-4 mb-1"></div><div className="pl-1 whitespace-pre-wrap">{m.ind}</div></div>))}
                                {data.meta.indicaciones && (<div className="text-[10px] leading-snug whitespace-pre-wrap mt-4 font-bold px-1">{data.meta.indicaciones}</div>)}
                            </div>
                            
                            <div className="border-t border-black mt-auto bg-white relative">
                                <div className="pt-3 px-4 flex text-[9px] items-start relative z-20">
                                    <div className="w-[55%] pr-2 relative"><div className="flex flex-col items-start relative"><span className="font-bold mb-0.5 leading-none">Nombre y firma del médico: {data.medico.nombre}</span><span className="font-bold uppercase leading-tight text-[8px] w-full">{data.medico.uni}</span></div></div>
                                    <div className="w-[45%] flex justify-between items-start pl-4"><div className="flex flex-col items-start"><span className="font-bold mb-1 leading-none">Cédula Profesional:</span><span className="font-[Arimo] font-bold leading-none">{data.medico.cedula}</span></div><div className="flex flex-col items-end"><span className="font-bold mb-1 leading-none">Matrícula:</span><span className="font-[Arimo] font-bold leading-none">{data.medico.matricula}</span></div></div>
                                </div>
                                <div className="doctor-stamp-base absolute z-30" style={{ ...activeSello.style, ...activeSello.position }}>
                                    <img src={logoUrl} className="stamp-logo" alt="Sello" style={{ filter: activeSello.style.color !== '#003366' ? 'grayscale(100%) brightness(30%) contrast(150%)' : undefined }} />
                                    <div className="text-left text-[8px]"><div>DR(A). {data.medico.nombre}</div><div>{data.medico.tipo}</div><div>CED. PROF. {data.medico.cedula}</div><div>MATRICULA {data.medico.matricula}</div></div>
                                </div>
                                <div className="border-b border-black w-auto mx-4 mt-1 mb-1 relative z-10"></div>
                                <div className="h-20 w-full bg-white relative z-0 flex flex-col items-end justify-start px-4"><span className="font-bold text-[9px] uppercase mt-1">PACIENTE</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const DOCTORES_POOL = [
    "Carlos Hernández García", "Juan López Martínez", "Miguel González Rodríguez", "Luis Pérez Sánchez", "Jorge Ramírez Cruz",
    "Daniel Flores Gómez", "Andrés Morales Vázquez", "Sergio Reyes Torres", "Pedro Díaz Gutiérrez", "Rafael Mendoza Ruiz",
    "Arturo Aguilar Ortega", "Javier Ortiz Moreno", "Rubén Romero Hernández", "Víctor Chávez Navarro", "Óscar Castillo Ríos",
    "Iván Herrera Mendoza", "Marco Salazar López", "Héctor Jiménez Aguilar", "Edgar Rojas Ramírez", "Adrián Navarro Flores",
    "Mario Vega González", "Julio Cárdenas Pérez", "Pablo Campos Sánchez", "Diego Luna Rodríguez", "Alan Cruz Martínez",
    "Juan Carlos Hernández López", "Luis Ángel García Martínez", "José Antonio González Pérez", "Carlos Eduardo Ramírez Torres",
    "Miguel Ángel Flores Sánchez", "Jorge Luis Rodríguez Cruz", "José Manuel Díaz Morales", "Juan José Romero Aguilar",
    "José Alberto Mendoza Reyes", "Carlos Andrés Ortega Gómez", "Luis Fernando Chávez Navarro", "José Luis Castillo Ríos",
    "Marco Antonio Vega Hernández", "Oscar Daniel Herrera Ruiz", "José Miguel Salazar Ortiz", "Juan Pablo Jiménez Ramírez",
    "José Ricardo Campos López", "Víctor Manuel Cruz González", "Luis Enrique Cárdenas Pérez", "José Adrián Navarro Torres",
    "Carlos Iván Rojas Martínez", "José David Luna Sánchez", "Juan Martín Aguilar Romero", "Luis Eduardo Ramos Flores",
    "José Ángel Morales Vega", "María Hernández García", "Ana López Martínez", "Laura González Rodríguez", "Carmen Pérez Sánchez",
    "Patricia Ramírez Cruz", "Rosa Flores Gómez", "Sandra Morales Vázquez", "Gabriela Reyes Torres", "Claudia Díaz Gutiérrez",
    "Daniela Mendoza Ruiz", "Verónica Aguilar Ortega", "Adriana Ortiz Moreno", "Beatriz Romero Hernández", "Liliana Chávez Navarro",
    "Alejandra Castillo Ríos", "Cecilia Herrera Mendoza", "Karla Salazar López", "Silvia Jiménez Aguilar", "Mónica Rojas Ramírez",
    "Paola Navarro Flores", "Brenda Vega González", "Jessica Cárdenas Pérez", "Teresa Campos Sánchez", "Lucía Luna Rodríguez",
    "Fernanda Cruz Martínez", "María Fernanda Hernández López", "Ana Karen García Martínez", "María José González Pérez",
    "Ana Sofía Ramírez Torres", "María Elena Flores Sánchez", "Rosa María Rodríguez Cruz", "Ana Laura Díaz Morales",
    "María del Carmen Romero Aguilar", "Ana Patricia Mendoza Reyes", "Laura Beatriz Ortega Gómez", "María Guadalupe Chávez Navarro",
    "Ana Lucía Castillo Ríos", "Claudia Fernanda Vega Hernández", "María Alejandra Herrera Ruiz", "Ana Victoria Salazar Ortiz",
    "María Isabel Jiménez Ramírez", "Ana Paola Campos López", "María Teresa Cruz González", "Ana Belén Cárdenas Pérez",
    "María Eugenia Navarro Torres", "Ana Gabriela Rojas Martínez", "María Soledad Luna Sánchez", "Ana Cecilia Aguilar Romero",
    "María Elena Ramos Flores", "Ana Cristina Morales Vega"
].map(nombre => {
    // Generador interno para asegurar datos únicos por nombre
    const get8Num = () => Math.floor(10000000 + Math.random() * 90000000).toString();
    const unis = [
        "UNAM - FACULTAD DE MEDICINA", "IPN - ESCUELA SUPERIOR DE MEDICINA", "UAM - UNIDAD XOCHIMILCO", "UNIVERSIDAD DE GUADALAJARA",
        "BUAP - FACULTAD DE MEDICINA", "UANL - FACULTAD DE MEDICINA", "UAEMEX - FACULTAD DE MEDICINA", "UNIVERSIDAD VERACRUZANA",
        "UNIVERSIDAD AUTÓNOMA DE QUERÉTARO", "UNIVERSIDAD AUTÓNOMA DE SAN LUIS POTOSÍ", "UNIVERSIDAD DE SONORA", "UNIVERSIDAD DE GUANAJUATO",
        "AUTÓNOMA DE CHIHUAHUA", "AUTÓNOMA DE YUCATÁN", "AUTÓNOMA DE BAJA CALIFORNIA", "ESCUELA MÉDICO MILITAR", "UNIVERSIDAD ANÁHUAC",
        "TECNOLÓGICO DE MONTERREY (ITESM)", "UNIVERSIDAD LA SALLE", "UNIVERSIDAD PANAMERICANA", "AUTÓNOMA DE TAMAULIPAS", 
        "AUTÓNOMA DE AGUASCALIENTES", "UNIVERSIDAD DE COLIMA", "AUTÓNOMA DE NAYARIT", "AUTÓNOMA DE COAHUILA", "AUTÓNOMA DE TLAXCALA",
        "AUTÓNOMA DEL ESTADO DE HIDALGO", "AUTÓNOMA DE SINALOA", "AUTÓNOMA DE CHIAPAS", "JUÁREZ AUTÓNOMA DE TABASCO", 
        "AUTÓNOMA BENITO JUÁREZ DE OAXACA", "AUTÓNOMA DE CAMPECHE", "AUTÓNOMA DEL ESTADO DE MORELOS", "AUTÓNOMA DE GUERRERO",
        "AUTÓNOMA DE ZACATECAS", "AUTÓNOMA DE DURANGO", "UNIVERSIDAD XOCHICALCO", "UNIVERSIDAD DEL NORESTE", "UNIVERSIDAD DE MONTEMORELOS",
        "UNIVERSIDAD DEL VALLE DE MÉXICO", "UNITEC - CIENCIAS DE LA SALUD", "UNIVERSIDAD WESTHILL", "UNIVERSIDAD JUSTO SIERRA",
        "UNIVERSIDAD TOMINAGA NAKAMOTO", "CENTRO UNIVERSITARIO DE INTEGRACIÓN HUMANÍSTICA", "UNIVERSIDAD DE IXTLAHUACA CUI",
        "AUTÓNOMA DE CIUDAD JUÁREZ", "UNIVERSIDAD DE MONTERREY (UDEM)", "AUTÓNOMA DE GUADALAJARA (UAG)", "UPAEP - PUEBLA"
    ]; // (Se repiten o alternan para completar los 100)
    
    return {
        nombre: nombre.toUpperCase(),
        cedula: get8Num(),
        matricula: get8Num(),
        uni: unis[Math.floor(Math.random() * unis.length)]
    };
});

                                // ==========================================
        // COMPONENTE: IMPRESORA CERTIFICADO COVID (CORREGIDO: NOMBRE DE PDF = SOLO CURP)
        // ==========================================
        const CovidPrinter = ({ data, onBack }) => {
            useEffect(() => {
                const tituloOriginal = document.title;
                
                // --- CAMBIO FINAL AQUÍ ---
                // Antes decía: "CERTIFICADO_" + data.curp.toUpperCase();
                // Ahora dice: data.curp.toUpperCase();
                // Esto hará que el nombre del PDF sea SOLO el CURP.
                if (data.curp) document.title = data.curp.toUpperCase();
                
                const timer = setTimeout(() => { window.print(); }, 800);
                return () => { document.title = tituloOriginal; clearTimeout(timer); };
            }, [data]);
            const headerImage = "https://i.postimg.cc/6pXNzC2y/20260201-084246-0000.png";
            
            return (
                <div className="min-h-screen bg-white flex flex-col items-center justify-start pt-5 font-sans">
                    <style>{`@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');`}</style>
                    <div className="no-print mb-6 flex gap-4">
                            <button onClick={onBack} className="bg-white text-slate-800 px-6 py-2 rounded-full font-bold shadow-lg hover:scale-105 transition flex items-center gap-2"><i data-lucide="arrow-left"></i> Volver al Historial</button>
                            <button onClick={() => window.print()} className="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:scale-105 transition flex items-center gap-2"><i data-lucide="printer"></i> Imprimir / Guardar PDF</button>
                    </div>
                    
                    <div className="print-area bg-white w-[21.59cm] min-h-[27.94cm] relative shadow-none flex flex-col items-center pt-0 pb-12 px-12" style={{ fontFamily: 'Arial, sans-serif', color: '#1a1a1a' }}>
                        
                        {/* 1. HEADER (LOGO) - INTACTO (-40px) */}
                        <div className="w-full mb-0 px-6 relative z-10 mt-[-40px]">
                            <img src={headerImage} alt="Encabezado" className="w-full object-contain" />
                        </div>
                        
                        {/* 2. TÍTULO - INTACTO (-15px) */}
                        <div className="text-center mb-3 w-full mt-[-15px] relative z-20">
                            <h1 className="text-[42px] font-black mb-0 leading-[0.8] tracking-tighter w-full transform scale-x-[1.05]" style={{ color: '#1a1a1a' }}>CERTIFICADO DE VACUNACIÓN</h1>
                            <h1 className="text-[42px] font-black mb-1 leading-[0.8] tracking-tighter w-full transform scale-x-[1.05]" style={{ color: '#1a1a1a' }}>CONTRA LA COVID-19</h1>
                            <p className="text-[15px] mt-1 tracking-[0.25em] uppercase font-normal scale-y-90" style={{ color: '#1a1a1a' }}>COVID-19 VACCINATION CERTIFICATE</p>
                        </div>
                        
                        {/* 3. DATOS PERSONALES - INTACTO */}
                        <div className="w-full mb-5 text-center">
                            <div className="mb-1"><p className="text-[24px] font-bold mb-0 leading-tight" style={{ color: '#1a1a1a', transform: 'scaleX(1.20)' }}>Clave Única de Registro de Población:</p><p className="text-[13px] mb-0.5 leading-none font-normal tracking-[0.04em]" style={{ color: '#444' }}>Unique Population Registry Code:</p><p className="text-[22px] tracking-wide uppercase mt-0.5 font-normal scale-y-95" style={{ color: '#1a1a1a' }}>{data.curp}</p></div>
                            <div><p className="text-[24px] font-bold mb-0 leading-tight" style={{ color: '#1a1a1a' }}>Nombre completo:</p><p className="text-[14px] mb-1 leading-none font-normal" style={{ color: '#444' }}>Full name:</p><p className="text-[22px] tracking-wide uppercase mt-1.5 font-normal scale-y-95" style={{ color: '#1a1a1a' }}>{data.nombre}</p></div>
                        </div>
                        
                        {/* 4. TABLA - INTACTA */}
                        <div className="w-[98%] mx-auto mb-2" style={{ color: '#000' }}>
                            <div className="flex border border-black mb-1">
                                <div className="w-1/2 py-1 text-center border-r border-black"><div className="font-bold text-[34px] leading-none text-black">1º Dosis</div><div className="text-[20px] text-[#444] leading-tight font-normal">First dose</div></div>
                                <div className="w-1/2 py-1 text-center"><div className="font-bold text-[34px] leading-none text-black">2º Dosis</div><div className="text-[20px] text-[#444] leading-tight font-normal">Second dose</div></div>
                            </div>
                            <div className="flex border border-black">
                                <div className="w-1/2 pt-3 pb-3 px-1 flex flex-col gap-3 border-r border-black items-center text-center"><div><div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Fecha de aplicación:</div><div className="text-[16px] leading-none mb-0.5 text-[#444]">Application date:</div><div className="text-[24px] leading-none text-black font-normal">{data.dosis1.fecha}</div></div><div><div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Marca de la vacuna:</div><div className="text-[16px] leading-none mb-0.5 text-[#444]">Vaccine manufacturer:</div><div className="text-[24px] leading-none text-black font-normal">{data.dosis1.marca}</div></div><div><div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Lote de la vacuna:</div><div className="text-[16px] leading-none mb-0.5 text-[#444]">Vaccine lot number:</div><div className="text-[24px] leading-none text-black font-normal">{data.dosis1.lote}</div></div></div>
                                <div className="w-1/2 pt-3 pb-3 px-1 flex flex-col gap-3 items-center text-center"><div><div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Fecha de aplicación:</div><div className="text-[16px] leading-none mb-0.5 text-[#444]">Application date:</div><div className="text-[24px] leading-none text-black font-normal">{data.dosis2.fecha}</div></div><div><div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Marca de la vacuna:</div><div className="text-[16px] leading-none mb-0.5 text-[#444]">Vaccine manufacturer:</div><div className="text-[24px] leading-none text-black font-normal">{data.dosis2.marca}</div></div><div><div className="font-bold text-[24px] leading-[1.1] text-black tracking-tight">Lote de la vacuna:</div><div className="text-[16px] leading-none mb-0.5 text-[#444]">Vaccine lot number:</div><div className="text-[24px] leading-none text-black font-normal">{data.dosis2.lote}</div></div></div>
                            </div>
                        </div>
                        
                        {/* 5. PIE DE PAGINA (Sello y textos) - INTACTO (-8px) */}
                        <div className="w-full flex mt-1 px-4 items-end mb-1">
                            <div className="w-[35%] flex flex-col items-center justify-end pb-12 pr-4"><svg viewBox="0 0 150 80" className="w-32 h-16 opacity-90 rotate-[-5deg] overflow-visible"><path d="M20,60 C40,40 60,30 50,70 S 90,40 120,30" stroke="#1a1a1a" strokeWidth="2.5" fill="none" strokeLinecap="round" /><path d="M30,50 L110,45" stroke="#1a1a1a" strokeWidth="1.5" fill="none" strokeLinecap="round" /><path d="M60,30 C60,10 80,10 70,50" stroke="#1a1a1a" strokeWidth="2" fill="none" /></svg></div>
                            <div className="w-[65%] flex flex-col items-end">
                                <div className="border border-black w-full p-2 mb-2 bg-white"><div className="text-[15px] font-bold text-black leading-none mb-1 uppercase">SELLO DIGITAL/DIGITAL STAMP:</div><div className="text-[14px] text-[#111] leading-tight break-all font-sans" style={{fontFamily: 'Arial, sans-serif'}}>{data.selloDigital}</div></div>
                                <div className="text-right w-full mt-0.5 mb-2"><div className="text-[15px] text-[#1a1a1a] leading-tight font-normal">Emisión del documento/Document issued:</div><div className="text-[15px] text-[#1a1a1a] leading-tight mt-0.5">{data.fechaEmision}</div></div>
                                <div className="text-right text-[11px] leading-[1.2] text-black w-full font-sans mt-[-8px]">
                                    <p>Para validar la autenticidad de éste documento, por favor escanee el</p>
                                    <p>código QR que debe abrir la página <b className="font-bold">https://cvcovid.salud.gob.mx</b></p>
                                    <p className="text-[#444] mt-0.5">To validate the authenticity of this document, please scann the QR</p>
                                    <p className="text-[#444]">code that should open the page <b className="font-bold">https://cvcovid.salud.gob.mx</b></p>
                                </div>
                            </div>
                        </div>
                        
                        {/* 6. BANNER RENAPO - INTACTO (AJUSTADO AL TEXTO) */}
                        <div className="w-full text-center mt-auto pb-8">
                            <div className="inline-block px-8 py-1 w-auto" style={{ backgroundColor: '#e2e2e2', WebkitPrintColorAdjust: 'exact', printColorAdjust: 'exact' }}>
                                <p className="text-[11px] text-black leading-tight text-center font-sans">"La Secretaría de Gobernación a través de <span className="font-bold">RENAPO</span>, acredita que la CURP fue verificada en la base de datos <br/> del Registro Nacional de Población".</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
                // ==========================================
        // COMPONENTE: IMPRESORA FARMACIA DEL AHORRO (FIRMA AJUSTADA UN POCO ABAJO)
        // ==========================================
        const FarmaciaPrinter = ({ data, onBack }) => {
            
            useEffect(() => {
                const tituloOriginal = document.title;
                if (data.paciente?.nombre) {
                    document.title = data.paciente.nombre.toUpperCase();
                }

                const timer = setTimeout(() => {
                    window.print();
                }, 800);

                return () => {
                    document.title = tituloOriginal;
                    clearTimeout(timer);
                };
            }, [data]);

            return (
                <div className="min-h-screen bg-white flex flex-col items-center justify-start pt-5 font-sans">
                    {/* --- BOTONES (NO IMPRIMIBLES) --- */}
                    <div className="no-print mb-6 flex gap-4">
                        <button onClick={onBack} className="bg-white text-slate-800 px-6 py-2 rounded-full font-bold shadow-lg hover:scale-105 transition flex items-center gap-2">
                            <i data-lucide="arrow-left"></i> Volver al Historial
                        </button>
                        <button onClick={() => window.print()} className="bg-[#1d428a] text-white px-6 py-2 rounded-full font-bold shadow-lg hover:scale-105 transition flex items-center gap-2">
                            <i data-lucide="printer"></i> Imprimir / Guardar PDF
                        </button>
                    </div>

                    {/* --- ÁREA DE IMPRESIÓN --- */}
                    <div className="print-area bg-white w-[21.59cm] min-h-[27.94cm] relative px-12 pb-60 pt-6 font-sans text-[#1d428a] overflow-hidden shadow-none flex flex-col">
                            
                        {/* MARCA DE AGUA */}
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[92%] h-auto z-0 pointer-events-none flex justify-center items-center">
                            <img src="https://i.postimg.cc/6qjsDrMx/1770333114747.png" alt="Marca de Agua" className="w-full h-auto object-contain brightness-125 saturate-150 opacity-[0.15] mix-blend-multiply" />
                        </div>

                        {/* ENCABEZADO */}
                        <div className="flex justify-between items-start mb-8 relative z-10">
                            <div className="w-[30%] pt-0">
                                <img src="https://i.postimg.cc/wvY9VQGh/logo-Farmacia-del-ahorro.webp" alt="Logo Farmacia del Ahorro" className="w-full h-auto object-contain" />
                                <div className="w-full h-[2.5px] bg-[#a01d2d] mt-4"></div>
                            </div>

                            <div className="w-[70%] flex flex-col items-center justify-start pt-1 text-[#1d428a] pl-10">
                                <div className="text-[26px] font-black leading-[0.9] mb-1.5 text-center w-full uppercase tracking-tight">
                                    {data.medico.nombre}
                                </div>
                                <div className="text-[18px] font-bold leading-none mb-1 text-center w-full uppercase">
                                    {data.medico.tipo}
                                </div>
                                <div className="text-[18px] font-bold leading-none mb-1 text-center w-full uppercase">
                                    CED. PROF. {data.medico.cedula}
                                </div>
                                <div className="text-[13px] font-bold leading-tight text-center w-full whitespace-pre-wrap uppercase tracking-tight">
                                    {data.medico.uni}
                                </div>
                            </div>
                        </div>

                        {/* DATOS PACIENTE */}
                        <div className="mb-8 relative z-10 text-[12px] uppercase mt-4">
                            <div className="flex items-baseline mb-6">
                                <span className="text-[#1d428a] font-black mr-2 text-[13px]">NOMBRE DEL PACIENTE:</span>
                                <span className="text-[#444] font-medium text-[13px]">{data.paciente.nombre}</span>
                            </div>
                            <div className="flex justify-between items-center w-full">
                                <div className="flex gap-6">
                                    <span className="flex items-baseline"><span className="text-[#1d428a] font-black mr-1">EDAD:</span><span className="text-[#444] font-medium">{data.paciente.edad}</span></span>
                                    <span className="flex items-baseline"><span className="text-[#1d428a] font-black mr-1">PESO:</span><span className="text-[#444] font-medium">{data.paciente.peso} KG</span></span>
                                    <span className="flex items-baseline"><span className="text-[#1d428a] font-black mr-1">TALLA:</span><span className="text-[#444] font-medium">{data.paciente.talla}</span></span>
                                    <span className="flex items-baseline"><span className="text-[#1d428a] font-black mr-1">TEMPERATURA:</span><span className="text-[#444] font-medium">{data.paciente.temp}</span></span>
                                </div>
                                <div className="flex items-baseline mr-24">
                                    <span className="text-[#1d428a] font-black mr-2">FECHA:</span><span className="text-[#444] font-medium">{data.paciente.fecha}</span>
                                </div>
                            </div>
                        </div>

                        {/* TRATAMIENTO */}
                        <div className="relative z-10 flex-grow px-2 mt-4">
                            <div className="text-[#1d428a] font-black text-[13px] mb-6 uppercase">TRATAMIENTO:</div>
                            <div className="space-y-6">
                                {data.medicamentos.map((m, i) => (
                                    <div key={i} className="text-[12px] leading-relaxed">
                                        <div className="font-bold text-black uppercase mb-1">{i+1}.- {m.text}</div>
                                        <div className="text-black uppercase pl-0 font-medium">{m.ind}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* --- BLOQUE 1: LÍNEA ROJA Y TEXTO (NO MOVER - 350px) --- */}
                        <div className="absolute left-0 w-full z-10 px-12 bottom-[350px]">
                            <div className="w-full h-[3px] bg-[#a01d2d] mb-1"></div>
                            <div className="text-[#1d428a] font-bold text-[12px] text-center uppercase tracking-wide">
                                SÚRTASE CON ESTA RECETA EN CUALQUIER SUCURSAL DE FARMACIAS DEL AHORRO
                            </div>
                        </div>

                        {/* --- BLOQUE 2: FIRMA (BAJADA UN POCO A 230px) --- */}
                        <div className="absolute left-0 w-full z-10 flex justify-center bottom-[230px]">
                            <div className="w-64 text-center">
                                <div className="border-t-[2px] border-[#1d428a] pt-1">
                                    <span className="text-[#1d428a] font-black text-[12px] uppercase tracking-wider">FIRMA</span>
                                </div>
                            </div>                                    
                        </div>
                    </div>
                </div>
            );
        };





                                                         // ==========================================
        // COMPONENTE PRINCIPAL (MainApp) - ACTUALIZADO
        // ==========================================
        const MainApp = () => {
            const [view, setView] = useState('login'); 
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isCheckingAuth, setIsCheckingAuth] = useState(true);
            const [userData, setUserData] = useState({ saldo: 0 }); 
            const [printData, setPrintData] = useState(null);
            
            useEffect(() => { 
                if(window.lucide) window.lucide.createIcons(); 
                const unsubscribe = auth.onAuthStateChanged((user) => { if (user && user.emailVerified) { setView('store'); db.collection('usuarios').doc(user.uid).onSnapshot(doc => { if (doc.exists) setUserData(doc.data()); else setUserData({ email: user.email, saldo: 0 }); }); } else { setView('login'); } setIsCheckingAuth(false); }); return () => unsubscribe();
            }, []);

                        const handlePrintDocument = (data, type) => {
                setPrintData(data);
                if (type === 'covid') setView('print_covid');
                else if (type === 'farmacia') setView('print_farmacia'); // NUEVA RUTA
                else setView('print_recipe');
            };

            const renderView = () => {
                switch(view) {
                    case 'login': return <LoginScreen onLogin={() => setView('store')} />;
                    case 'store': return <StoreFront userData={userData} 
                        onSelectService={(tipo) => {
                            if (tipo === 'farmacia') {
                                setView('editor_farmacia');
                            } else {
                                setView('editor');
                            }
                        }} 
                        onSelectCovid={() => setView('covid')} 
                        onOpenMenu={() => setIsMenuOpen(true)} 
                        onGoToHistory={() => setView('history')} />;
                    
                    case 'editor': return <RecetaEditor onBack={() => setView('store')} />;
                    case 'editor_farmacia': return <FarmaciaEditor onBack={() => setView('store')} />;
                    case 'covid': return <CovidEditor onBack={() => setView('store')} />;
                    case 'recharge': return <RechargeFlow onBack={() => setView('store')} />;
                    case 'admin': return <AdminPanel onBack={() => setView('store')} />;
                    case 'history': return <PurchaseHistory onBack={() => setView('store')} onPrintDocument={handlePrintDocument} />;
                    case 'profile': return <UserProfile onBack={() => setView('store')} />;
                    
                    case 'print_recipe': return <RecipePrinter data={printData} onBack={() => setView('history')} />;
                    case 'print_covid': return <CovidPrinter data={printData} onBack={() => setView('history')} />;
                    
                    // NUEVO CASO AGREGADO:
                    case 'print_farmacia': return <FarmaciaPrinter data={printData} onBack={() => setView('history')} />;
                    
                    default: return <LoginScreen onLogin={() => setView('store')} />;
                }
            };


            if (isCheckingAuth) { return (<div className="min-h-screen bg-slate-900 flex items-center justify-center"><div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div></div>); }
            return (<div className="antialiased text-slate-900">{view !== 'login' && view !== 'covid' && view !== 'editor' && view !== 'editor_farmacia' && view !== 'print_recipe' && view !== 'print_covid' && (<SidebarMenu isOpen={isMenuOpen} onClose={() => setIsMenuOpen(false)} onNavigate={(v) => { setIsMenuOpen(false); setView(v); }} userBalance={userData?.saldo || 0} userData={userData} />)}{renderView()}</div>);
        };


        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
